<!DOCTYPE html>  <html> <head>   <title>mithgrid.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               mithgrid.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p><strong>MITHGrid</strong> is a data-centric JavaScript library that provides event-driven application building blocks.
The library is based loosely on the MIT Simile Exhibit library and the Fluid Infusion project.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <h1>#</h1>

<p>mithgrid JavaScript Library v0.0.1</p>

<p>Date: Wed Jan 18 11:51:47 2012 -0500</p>

<p>(c) Copyright University of Maryland 2011-2012.  All rights reserved.</p>

<p>(c) Copyright Texas A&amp;M University 2010.  All rights reserved.</p>

<p>Portions of this code are copied from The SIMILE Project:
 (c) Copyright The SIMILE Project 2006. All rights reserved.</p>

<p>Redistribution and use in source and binary forms, with or without
modification, are permitted provided that the following conditions
are met:</p>

<ol>
<li><p>Redistributions of source code must retain the above copyright
notice, this list of conditions and the following disclaimer.</p></li>
<li><p>Redistributions in binary form must reproduce the above copyright
notice, this list of conditions and the following disclaimer in the
documentation and/or other materials provided with the distribution.</p></li>
<li><p>The name of the author may not be used to endorse or promote products
derived from this software without specific prior written permission.</p></li>
</ol>

<p>THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
(INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</p>

<h1>#</h1>             </td>             <td class="code">               <div class="highlight"><pre><span class="nv">MITHGrid = </span><span class="k">this</span><span class="p">.</span><span class="nx">MITHGrid</span> <span class="o">?=</span> <span class="p">{}</span>
<span class="nv">jQuery = </span><span class="k">this</span><span class="p">.</span><span class="nx">jQuery</span> <span class="o">?=</span> <span class="p">{}</span>

<span class="p">(</span><span class="nf">($, MITHGrid) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <h1>namespace management</h1>

<p>These functions are available as properties of the global MITHGrid object. The debug() and namespace()
functions are properties of all namespaces created using MITHGrid.</p>             </td>             <td class="code">               <div class="highlight"><pre>    </pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <h2>MITHGrid.debug</h2>

<p>If you don't know if the console.log is available, use MITHGrid.debug. If console.log is available, it's the same
function. Otherwise, it's a NOP.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nb">window</span><span class="o">?</span><span class="p">.</span><span class="nx">console</span><span class="o">?</span><span class="p">.</span><span class="nx">log</span><span class="o">?</span>
        <span class="nv">MITHGrid.debug = </span><span class="nb">window</span><span class="p">.</span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span>
    <span class="k">else</span> 
        <span class="nv">MITHGrid.debug = </span><span class="nf">() -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <h2>MITHGrid.error</h2>

<p>MITHGrid.error will be like MITHGrid.debug except that it will return the arguments in an object that can be thrown as
an error. It is used in the data store loadItems() function.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">MITHGrid.error = </span><span class="nf">() -&gt;</span>
        <span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">debug</span><span class="p">.</span><span class="nx">call</span> <span class="p">{},</span> <span class="nx">arguments</span>
        <span class="p">{</span> <span class="s">&#39;arguments&#39;</span><span class="o">:</span> <span class="nx">arguments</span> <span class="p">}</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <h2>MITHGrid.namespace</h2>

<p>Ensures the namespace exists as a property of the MITHGrid global.
Any namespace created will have the debug() and namespace()
functions available.</p>

<p>Parameters:</p>

<ul>
<li>nom - the name of the namespace</li>
<li>fn  - optional callback to be called with the new namespace</li>
</ul>

<p>Returns:</p>

<p>The object corresponding to the namespace.</p>             </td>             <td class="code">               <div class="highlight"><pre>    
    <span class="nv">MITHGrid.namespace = </span><span class="nf">(nom, fn) -&gt;</span>
        <span class="nx">genericNamespacer</span> <span class="nx">MITHGrid</span><span class="p">,</span> <span class="nx">nom</span><span class="p">,</span> <span class="nx">fn</span>
        </pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>We need a general way to handle namespace creation. We do this so we can use closures when creating the
namespace.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">genericNamespacer = </span><span class="nf">(base, nom, fn) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>TODO: check for '.' in nom</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">bits = </span><span class="nx">nom</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
        <span class="k">while</span> <span class="nx">bits</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>
            <span class="k">if</span> <span class="o">!</span><span class="nx">base</span><span class="p">[</span><span class="nx">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="nv">base = </span><span class="nx">genericNamespacer</span> <span class="nx">base</span><span class="p">,</span> <span class="nx">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="nx">bits</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
        <span class="k">if</span> <span class="o">!</span><span class="nx">base</span><span class="p">[</span><span class="nx">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">?</span>
            <span class="nv">newbase =</span>
                <span class="nv">namespace: </span><span class="nf">(nom2, fn2) -&gt;</span>
                    <span class="nx">genericNamespacer</span> <span class="nx">newbase</span><span class="p">,</span> <span class="nx">nom2</span><span class="p">,</span> <span class="nx">fn2</span>
                <span class="nv">debug: </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">debug</span>
        <span class="nx">base</span><span class="p">[</span><span class="nx">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="nx">newbase</span>
        <span class="k">if</span> <span class="nx">fn</span><span class="o">?</span>
            <span class="nx">fn</span> <span class="nx">base</span><span class="p">[</span><span class="nx">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="nx">base</span><span class="p">[</span><span class="nx">bits</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <h2>MITHGrid.globalNamespace</h2>

<p>Ensures the namespace exists in the global space.
Any namespace created will have the debug() and namespace() functions available.</p>

<p>Parameters:</p>

<ul>
<li>nom - the name of the namespace</li>
<li>fn  - optional callback to be called with the new namespace</li>
</ul>

<p>Returns:</p>

<p>The object corresponding to the namespace.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">MITHGrid.globalNamespace = </span><span class="nf">(nom, fn) -&gt;</span>
        <span class="nv">globals = </span><span class="nb">window</span>
        <span class="nx">globals</span><span class="p">[</span><span class="nx">nom</span><span class="p">]</span> <span class="o">or=</span> <span class="p">{}</span>
        
        <span class="nx">globals</span><span class="p">[</span><span class="nx">nom</span><span class="p">][</span><span class="s">&quot;debug&quot;</span><span class="p">]</span> <span class="o">or=</span> <span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">debug</span>
        <span class="nx">globals</span><span class="p">[</span><span class="nx">nom</span><span class="p">][</span><span class="s">&quot;namespace&quot;</span><span class="p">]</span> <span class="o">or=</span> <span class="nf">(n, f) -&gt;</span>
            <span class="nx">genericNamespacer</span> <span class="nx">globals</span><span class="p">[</span><span class="nx">nom</span><span class="p">],</span> <span class="nx">n</span><span class="p">,</span> <span class="nx">f</span>
        <span class="k">if</span> <span class="nx">fn</span><span class="o">?</span>
            <span class="nx">fn</span> <span class="nx">globals</span><span class="p">[</span><span class="nx">nom</span><span class="p">]</span>
        <span class="nx">globals</span><span class="p">[</span><span class="nx">nom</span><span class="p">]</span>
    </pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <h1>that-ism helper functions</h1>

<p>These functions are available as properties of the global MITHGrid object.    </p>             </td>             <td class="code">               <div class="highlight"><pre>    </pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <h2>MITHGrid.normalizeArgs</h2>

<p>Accepts the arguments passed in from the constructor and sorts out the various pieces.</p>

<p>Parameters:</p>

<ul>
<li>type - the namespace of the object initializer</li>
<li>types - an optional array of super namespaces</li>
<li>container - an optional DOM object managed by the object being initialized</li>
<li>options - an optional object holding configuration information for the object initializer</li>
</ul>

<p>Returns:</p>

<p>An array of three elements: a list of namespaces, the DOM container, and the options object.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">MITHGrid.normalizeArgs = </span><span class="nf">(type, types, container, options) -&gt;</span>
        <span class="k">if</span> <span class="o">!</span><span class="nx">options</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="nx">$</span><span class="p">.</span><span class="nx">isPlainObject</span><span class="p">(</span><span class="nx">container</span><span class="p">)</span>
            <span class="nv">options = </span><span class="nx">container</span>
            <span class="nv">container = </span><span class="kc">undefined</span>
        <span class="k">if</span> <span class="o">!</span><span class="nx">container</span><span class="o">?</span>
            <span class="k">if</span> <span class="k">typeof</span> <span class="nx">types</span> <span class="o">!=</span> <span class="s">&quot;string&quot;</span>
                <span class="k">if</span> <span class="o">!</span><span class="nx">$</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">types</span><span class="p">)</span>
                    <span class="nv">container = </span><span class="nx">types</span>
                    <span class="nv">types = </span><span class="p">[]</span>

        <span class="k">if</span> <span class="o">!</span><span class="nx">options</span><span class="o">?</span>
            <span class="k">if</span> <span class="k">typeof</span> <span class="nx">types</span> <span class="o">==</span> <span class="s">&quot;string&quot;</span>
                <span class="nv">types = </span><span class="p">[</span> <span class="nx">types</span><span class="p">,</span> <span class="nx">type</span> <span class="p">]</span>
                <span class="nv">options = </span><span class="p">{}</span>
            <span class="k">else</span> <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">types</span>
                <span class="nx">types</span><span class="p">.</span><span class="nx">push</span> <span class="nx">type</span>
                <span class="nv">options = </span><span class="p">{}</span>
            <span class="k">else</span>
                <span class="nv">options = </span><span class="nx">types</span>
                <span class="nv">types = </span><span class="nx">type</span>
        <span class="k">else</span>
            <span class="k">if</span> <span class="k">typeof</span> <span class="nx">types</span> <span class="o">==</span> <span class="s">&quot;string&quot;</span>
                <span class="nv">types = </span><span class="p">[</span> <span class="nx">types</span><span class="p">,</span> <span class="nx">type</span> <span class="p">]</span>
            <span class="k">else</span> <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">types</span>
                <span class="nx">types</span><span class="p">.</span><span class="nx">push</span> <span class="nx">type</span>
            <span class="k">else</span>
                <span class="nv">types = </span><span class="nx">type</span>
                
        <span class="p">[</span> <span class="nx">types</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">options</span> <span class="p">]</span>
        
    
    <span class="nv">MITHGridDefaults = </span><span class="p">{}</span>
    </pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <h2>MITHGrid.defaults</h2>

<p>Allows default configuration values to be set for a given namespace.</p>

<p>Parameters:</p>

<ul>
<li>namespace - the namespace for which the defaults should be set</li>
<li>defaults - object containing default configuration information</li>
</ul>

<p>Returns: Nothing.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">MITHGrid.defaults = </span><span class="nf">(namespace, defaults) -&gt;</span>
        <span class="nx">MITHGridDefaults</span><span class="p">[</span><span class="nx">namespace</span><span class="p">]</span> <span class="o">or=</span> <span class="p">{}</span>
        <span class="nx">MITHGridDefaults</span><span class="p">[</span><span class="nx">namespace</span><span class="p">]</span> <span class="o">=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nx">MITHGridDefaults</span><span class="p">[</span><span class="nx">namespace</span><span class="p">],</span> <span class="nx">defaults</span><span class="p">)</span>
        </pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <h1>Synchonizer</h1>

<h2>MITHGrid.initSynchronizer</h2>

<p>Parameters:</p>

<ul>
<li>callbacks - an object with an optional "done" property providing a function to call when the counter is zero and
the done() method has been called.</li>
</ul>

<p>Returns:</p>

<p>The synchronizer object.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">MITHGrid.initSynchronizer = </span><span class="nf">(callbacks) -&gt;</span>
        <span class="nv">that = </span><span class="p">{}</span>
        <span class="nv">counter = </span><span class="mi">1</span>
        <span class="nv">done = </span><span class="kc">false</span>
        <span class="nv">fired = </span><span class="kc">false</span>
        <span class="k">if</span> <span class="o">!</span><span class="nx">callbacks</span><span class="p">.</span><span class="nx">done</span><span class="o">?</span>
            <span class="nv">that.increment = </span><span class="nf">() -&gt;</span>
            <span class="nv">that.decrement = </span><span class="nx">that</span><span class="p">.</span><span class="nx">increment</span>
            <span class="nv">that.done = </span><span class="nx">that</span><span class="p">.</span><span class="nx">increment</span>
            <span class="nv">that.add = </span><span class="nf">(v) -&gt;</span>
        <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <h3>#increment</h3>

<p>Increments the synchronizer counter by one.</p>

<p>Returns:</p>

<p>The new value of the synchronizer counter.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nv">that.increment = </span><span class="nf">() -&gt;</span> <span class="nx">counter</span> <span class="o">+=</span> <span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <h3>#add</h3>

<p>Adds the indicated number to the synchronizer.</p>

<p>Parameters:</p>

<ul>
<li>n - how much to add to the synchronizer counter</li>
</ul>

<p>Returns:</p>

<p>The new value of the synchronizer counter.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nv">that.add = </span><span class="nf">(n) -&gt;</span> <span class="nx">counter</span> <span class="o">+=</span> <span class="nx">n</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <h3>#decrement</h3>

<p>Decrements the synchronizer counter by one.</p>

<p>Returns:</p>

<p>The new value of the synchronizer counter.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nv">that.decrement = </span><span class="nf">() -&gt;</span>
                <span class="nx">counter</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span> <span class="nx">counter</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">done</span> <span class="o">and</span> <span class="o">!</span><span class="nx">fired</span>
                    <span class="nx">setTimeout</span> <span class="nx">callbacks</span><span class="p">.</span><span class="nx">done</span><span class="p">,</span> <span class="mi">0</span>
                    <span class="nv">fired = </span><span class="kc">true</span>
                <span class="nx">counter</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <h3>#done</h3>

<p>Marks the synchronizer as done. The counter should monotonically decrease after this. Once it is zero, the
"done" callback will run.</p>

<p>Returns:</p>

<p>The new value of the synchronizer counter. If it is zero, then the "done" callback should be scheduled to run.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nv">that.done = </span><span class="nf">() -&gt;</span>
                <span class="nv">done = </span><span class="kc">true</span>
                <span class="nx">that</span><span class="p">.</span><span class="nx">decrement</span><span class="p">()</span>

        <span class="nx">that</span>
        </pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <h1>EventFirer</h1>

<h2>MITHGrid.initEventFirer</h2>

<p>Parameters:</p>

<ul>
<li>isPreventable - true if a listener can prevent further listeners from receiving the event</li>
<li>isUnicast - true if only one listener receives the event</li>
</ul>

<p>Returns:</p>

<p>The EventFirer object.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">MITHGrid.initEventFirer = </span><span class="nf">(isPreventable, isUnicast) -&gt;</span>
        <span class="nv">that = </span><span class="p">{}</span>
        <span class="nv">that.isPreventable = </span><span class="nx">isPreventable</span>
        <span class="nv">that.isUnicast = </span><span class="nx">isUnicast</span>
        <span class="nv">listeners = </span><span class="p">[]</span>
        </pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <h3>#addListener</h3>

<p>Adds a listener to an event.</p>

<p>Parameters:</p>

<ul>
<li>listener - function to call when event fires</li>
<li>namespace - optional namespace parameter that can be used to remove listeners</li>
</ul>

<p>Returns: Nothing.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">that.addListener = </span><span class="nf">(listener, namespace) -&gt;</span>
            <span class="nx">listeners</span><span class="p">.</span><span class="nx">push</span> <span class="p">[</span><span class="nx">listener</span><span class="p">,</span> <span class="nx">namespace</span><span class="p">]</span>
        </pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <h3>#removeListener</h3>

<p>Removes a listener (or set of listeners) from an event firer.</p>

<p>Parameters:</p>

<ul>
<li>listener - function or string to remove from list of listeners</li>
</ul>

<p>Returns: Nothing.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">that.removeListener = </span><span class="nf">(listener) -&gt;</span>
            <span class="k">if</span> <span class="k">typeof</span> <span class="nx">listener</span> <span class="o">==</span> <span class="s">&quot;string&quot;</span>
                <span class="nv">listeners = </span><span class="p">(</span><span class="nx">l</span> <span class="k">for</span> <span class="nx">l</span> <span class="k">in</span> <span class="nx">listeners</span> <span class="k">when</span> <span class="nx">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">listener</span><span class="p">)</span>
            <span class="k">else</span>
                <span class="nv">listeners = </span><span class="p">(</span><span class="nx">l</span> <span class="k">for</span> <span class="nx">l</span> <span class="k">in</span> <span class="nx">listeners</span> <span class="k">when</span> <span class="nx">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">listener</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <h3>#fire</h3>

<p>Fire's behavior depends on the type of event that is firing.</p>

<p>If a unicast event, then fire() will call the first listener. All other listeners will be ignored.</p>

<p>If the event is preventable, then fire() will call each listener in turn until either it runs out of
listeners or a listener returns the "false" value.</p>

<p>If the event is neither unicast nor preventable, then fire() will call each listener in turn. After all listeners
are called, it will return the "true" value.</p>

<p>Parameters:</p>

<ul>
<li>args... - all arguments are passed to the listener without modification</li>
</ul>

<p>Returns:</p>

<p>Fire's behavior depends on the type of event that is firing.</p>

<p>A unicast event will always return the value returned by the listener. If there are no listeners, it will return
the "true" value.</p>

<p>If the event is preventable, then fire() will return the "false" value if a listener returns "false". Otherwise,
it will return "true".</p>

<p>If neither unicast nor preventabe, then fire() will return "true" regardless of how many listeners are called.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="k">if</span> <span class="nx">isUnicast</span>
            <span class="nv">that.fire = </span><span class="nf">(args...) -&gt;</span>
                <span class="k">if</span> <span class="nx">listeners</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="k">try</span>
                        <span class="nx">listeners</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">](</span><span class="nx">args</span><span class="p">...)</span>
                    <span class="k">catch</span> <span class="nx">e</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">e</span>
                <span class="k">else</span>
                    <span class="kc">true</span>
        <span class="k">else</span> <span class="k">if</span> <span class="nx">isPreventable</span>

            <span class="nv">that.fire = </span><span class="nf">(args...) -&gt;</span>
                <span class="nv">r = </span><span class="kc">true</span>
                <span class="k">for</span> <span class="nx">listener</span> <span class="k">in</span> <span class="nx">listeners</span>
                    <span class="nv">l = </span><span class="nx">listener</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">try</span>
                        <span class="nv">r = </span><span class="nx">l</span><span class="p">(</span><span class="nx">args</span><span class="p">...)</span>
                    <span class="k">catch</span> <span class="nx">e</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">e</span>
                    <span class="k">if</span> <span class="nx">r</span> <span class="o">==</span> <span class="kc">false</span>
                        <span class="k">return</span> <span class="kc">false</span>
                <span class="kc">true</span>
        <span class="k">else</span>

            <span class="nv">that.fire = </span><span class="nf">(args...) -&gt;</span>
                <span class="k">for</span> <span class="nx">listener</span> <span class="k">in</span> <span class="nx">listeners</span>
                    <span class="k">try</span>
                        <span class="nx">listener</span><span class="p">[</span><span class="mi">0</span><span class="p">](</span><span class="nx">args</span><span class="p">...)</span>
                    <span class="k">catch</span> <span class="nx">e</span>
                        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="nx">listener</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">e</span>
                <span class="kc">true</span>
        

        
        <span class="nx">that</span>
        </pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <h1>Object Instances</h1>

<p>We use a local global to track how many objects we've initialized so we can assign a unique number
to each. This is useful when debugging to see if you are creating the right number of objects or too many.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">initViewCounter = </span><span class="mi">0</span>
    </pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <h2>MITHGrid.initInstance</h2>

<p>Initialize an object based on that-ism principles.</p>

<p>Parameters:</p>

<ul>
<li>namespace - the name of the object type being initialized</li>
<li>container - optional DOM object in which this object can place content</li>
<li>config - object containing configuration information for this object</li>
</ul>

<p>Returns:</p>

<p>The instantiated and initialized object.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">MITHGrid.initInstance = </span><span class="nf">(namespace, container, config) -&gt;</span>
        <span class="k">if</span> <span class="o">!</span><span class="nx">config</span><span class="o">?</span>
            <span class="nv">config = </span><span class="nx">container</span>
            <span class="nv">container = </span><span class="kc">undefined</span>
        <span class="k">if</span> <span class="o">!</span><span class="nx">config</span><span class="o">?</span> <span class="o">and</span> <span class="o">!</span><span class="p">(</span><span class="k">typeof</span> <span class="nx">namespace</span> <span class="o">==</span> <span class="s">&quot;string&quot;</span> <span class="o">||</span> <span class="nx">$</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">namespace</span><span class="p">))</span>
            <span class="nv">config = </span><span class="nx">namespace</span>
            <span class="nv">namespace = </span><span class="kc">null</span>
        <span class="nv">that = </span><span class="p">{}</span>
        <span class="nv">options = </span><span class="p">{}</span>
        <span class="k">if</span> <span class="nx">namespace</span><span class="o">?</span> 
            <span class="k">if</span> <span class="k">typeof</span> <span class="nx">namespace</span> <span class="o">==</span> <span class="s">&quot;string&quot;</span>
                <span class="nv">namespace = </span><span class="p">[</span> <span class="nx">namespace</span> <span class="p">]</span>
            <span class="nx">namespace</span><span class="p">.</span><span class="nx">reverse</span><span class="p">()</span>
            <span class="k">for</span> <span class="nx">ns</span> <span class="k">in</span> <span class="nx">namespace</span>
                <span class="nv">bits = </span><span class="nx">ns</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="s">&#39;.&#39;</span><span class="p">)</span>
                <span class="nv">ns = </span><span class="nx">bits</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
                <span class="nv">options = </span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">MITHGridDefaults</span><span class="p">[</span><span class="nx">ns</span><span class="p">]</span><span class="o">||</span><span class="p">{})</span>
                <span class="k">while</span> <span class="nx">bits</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="nv">ns = </span><span class="nx">ns</span> <span class="o">+</span> <span class="s">&quot;.&quot;</span> <span class="o">+</span> <span class="nx">bits</span><span class="p">.</span><span class="nx">shift</span><span class="p">()</span>
                    <span class="nv">options = </span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">MITHGridDefaults</span><span class="p">[</span><span class="nx">ns</span><span class="p">]</span><span class="o">||</span><span class="p">{})</span>
        <span class="nv">options = </span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="nx">config</span><span class="o">||</span><span class="p">{})</span>

        <span class="nx">initViewCounter</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="nv">that.id = </span><span class="nx">initViewCounter</span>
        <span class="nv">that.options = </span><span class="nx">options</span>
        <span class="nv">that.container = </span><span class="nx">container</span>
        <span class="nv">that.events = </span><span class="p">{}</span>
        
        <span class="k">if</span> <span class="nx">that</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">events</span><span class="o">?</span>
            <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">c</span> <span class="k">of</span> <span class="nx">that</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">events</span>
                <span class="k">if</span> <span class="nx">c</span><span class="o">?</span>
                    <span class="k">if</span> <span class="k">typeof</span> <span class="nx">c</span> <span class="o">==</span> <span class="s">&quot;string&quot;</span>
                        <span class="nv">c = </span><span class="p">[</span> <span class="nx">c</span> <span class="p">]</span>
                <span class="k">else</span>
                    <span class="nv">c = </span><span class="p">[]</span>
                <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">initEventFirer</span><span class="p">(</span> <span class="p">(</span><span class="s">&quot;preventable&quot;</span> <span class="k">in</span> <span class="nx">c</span><span class="p">),</span> <span class="p">(</span><span class="s">&quot;unicast&quot;</span> <span class="k">in</span> <span class="nx">c</span><span class="p">))</span>
        <span class="nx">that</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>We place most of the data-centric pieces in the MITHGrid.Data namespace.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">namespace</span> <span class="s">&#39;Data&#39;</span><span class="p">,</span> <span class="nf">(Data) -&gt;</span>
        <span class="nx">Data</span><span class="p">.</span><span class="nx">namespace</span> <span class="s">&#39;Set&#39;</span><span class="p">,</span> <span class="nf">(Set) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <h1>Data Sets</h1>

<p>Sets track membership of string item IDs.
Sets are basic objects that do not participate in the MITHGrid.initView scheme.</p>

<h2>Set.initInstance</h2>

<p>Initializes a set.</p>

<p>Parameters:</p>

<ul>
<li>values - optional array of values that are initial members of the set</li>
</ul>

<p>Returns:</p>

<p>The set object.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nv">Set.initInstance = </span><span class="nf">(values) -&gt;</span>
                <span class="nv">that = </span><span class="p">{}</span>
                <span class="nv">items = </span><span class="p">{}</span>
                <span class="nv">count = </span><span class="mi">0</span>
                <span class="nv">recalc_items = </span><span class="kc">true</span>
                <span class="nv">items_list = </span><span class="p">[]</span>

                <span class="nv">that.isSet = </span><span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <h3>#items</h3>

<p>Returns a list of item IDs in the set.</p>

<p>Parameters: None.</p>

<p>Returns:</p>

<p>An array of item IDs.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.items = </span><span class="nf">() -&gt;</span>
                    <span class="k">if</span> <span class="nx">recalc_items</span>
                        <span class="nv">items_list = </span><span class="p">[]</span>
                        <span class="k">for</span> <span class="nx">i</span> <span class="k">of</span> <span class="nx">items</span>
                            <span class="nx">items_list</span><span class="p">.</span><span class="nx">push</span> <span class="nx">i</span> <span class="k">if</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;string&quot;</span> <span class="o">and</span> <span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">==</span> <span class="kc">true</span>
                    <span class="nx">items_list</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <h3>#add</h3>

<p>Adds an item ID to the set.</p>

<p>Parameters:</p>

<ul>
<li>item - item ID to be added to the set</li>
</ul>

<p>Returns:</p>

<p>Returns nothing.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.add = </span><span class="nf">(item) -&gt;</span>
                    <span class="k">if</span> <span class="o">!</span><span class="nx">items</span><span class="p">[</span><span class="nx">item</span><span class="p">]</span><span class="o">?</span>
                        <span class="nx">items</span><span class="p">[</span><span class="nx">item</span><span class="p">]</span> <span class="o">=</span> <span class="kc">true</span>
                        <span class="nv">recalc_items = </span><span class="kc">true</span>
                        <span class="nx">count</span> <span class="o">+=</span> <span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <h3>#remove</h3>

<p>Removes the item ID from the set.</p>

<p>Parameters:</p>

<ul>
<li>item - item ID to be removed from the set</li>
</ul>

<p>Returns:</p>

<p>Returns nothing.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.remove = </span><span class="nf">(item) -&gt;</span>
                    <span class="k">if</span> <span class="nx">items</span><span class="p">[</span><span class="nx">item</span><span class="p">]</span><span class="o">?</span>
                        <span class="k">delete</span> <span class="nx">items</span><span class="p">[</span><span class="nx">item</span><span class="p">]</span>
                        <span class="nv">recalc_items = </span><span class="kc">true</span>
                        <span class="nx">count</span> <span class="o">-=</span> <span class="mi">1</span>
                </pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <h3>#empty</h3>

<p>Removes all items from the set.</p>

<p>Parameters: None.</p>

<p>Returns:</p>

<p>Returns nothing.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.empty = </span><span class="nf">() -&gt;</span>
                    <span class="nv">items = </span><span class="p">{}</span>
                    <span class="nv">count = </span><span class="mi">0</span>
                    <span class="nv">recalc_items = </span><span class="kc">false</span>
                    <span class="nv">items_list = </span><span class="p">[]</span>
                    <span class="kc">undefined</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <h3>#visit</h3>

<p>Calls a function with each item ID in the set. This will terminate if the called function returns the
"true" value.</p>

<p>Parameters:</p>

<ul>
<li>fn - function taking one argument (the item ID being visited)</li>
</ul>

<p>Returns:</p>

<p>Returns nothing.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.visit = </span><span class="nf">(fn) -&gt;</span>
                    <span class="k">for</span> <span class="nx">o</span> <span class="k">of</span> <span class="nx">items</span>
                        <span class="k">break</span> <span class="k">if</span> <span class="nx">fn</span><span class="p">(</span><span class="nx">o</span><span class="p">)</span> <span class="o">==</span> <span class="kc">true</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <h3>#contains</h3>

<p>Returns true if the item ID is in the set.</p>

<p>Parameters:</p>

<ul>
<li>o - item ID to be tested</li>
</ul>

<p>Returns:</p>

<p>True or false depending on the presence of the item ID in the set.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.contains = </span><span class="nf">(o) -&gt;</span>
                    <span class="nx">items</span><span class="p">[</span><span class="nx">o</span><span class="p">]</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <h3>#size</h3>

<p>Returns the number of item IDs in the set.</p>

<p>Parameters: None.</p>

<p>Returns:</p>

<p>The number of item IDs in the set.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.size = </span><span class="nf">() -&gt;</span>
                    <span class="k">if</span> <span class="nx">recalc_items</span>
                        <span class="nx">that</span><span class="p">.</span><span class="nx">items</span><span class="p">().</span><span class="nx">length</span>
                    <span class="k">else</span>
                        <span class="nx">items_list</span><span class="p">.</span><span class="nx">length</span>

                <span class="k">if</span> <span class="nx">values</span> <span class="k">instanceof</span> <span class="nb">Array</span>
                    <span class="nx">that</span><span class="p">.</span><span class="nx">add</span> <span class="nx">i</span> <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">values</span>

                <span class="nx">that</span>
            

        </pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <h1>Data Types</h1>

<p>This object type is used to encapsulate information about item types. Used within data store objects and parsed
expressions.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Data</span><span class="p">.</span><span class="nx">namespace</span> <span class="s">&#39;Type&#39;</span><span class="p">,</span> <span class="nf">(Type) -&gt;</span>
            <span class="nv">Type.initInstance = </span><span class="nf">(t) -&gt;</span>
                <span class="nv">that =</span>
                    <span class="nv">name: </span><span class="nx">t</span>
                    <span class="nv">custom: </span><span class="p">{}</span>
        </pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <h1>Data Properties</h1>

<p>This object type is used to encapsulate information about item properties. Used within data store objects and
parsed expressions.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Data</span><span class="p">.</span><span class="nx">namespace</span> <span class="s">&#39;Property&#39;</span><span class="p">,</span> <span class="nf">(Property) -&gt;</span>
            <span class="nv">Property.initInstance = </span><span class="nf">(p) -&gt;</span>
                <span class="nv">that =</span>
                    <span class="nv">name: </span><span class="nx">p</span>
                    <span class="nv">getValueType: </span><span class="nf">() -&gt;</span>
                        <span class="nx">that</span><span class="p">.</span><span class="nx">valueType</span> <span class="o">?</span> <span class="s">&#39;text&#39;</span>
        </pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <h1>Data Store</h1>

<p>MITHGrid.Data.Store is a basic triple store that allows updating and deletion of triples.
Data stores are usually used as sources for data views.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Data</span><span class="p">.</span><span class="nx">namespace</span> <span class="s">&#39;Store&#39;</span><span class="p">,</span> <span class="nf">(Store) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <h2>Store.initInstance</h2>

<p>Initializes a data store instance.</p>

<p>Parameters:</p>

<ul>
<li>options - object containing configuration options</li>
</ul>

<p>Returns:</p>

<p>The configured data store instance.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nv">Store.initInstance = </span><span class="nf">(options) -&gt;</span>
                <span class="nv">quiesc_events = </span><span class="kc">false</span>
                <span class="nv">set = </span><span class="nx">Data</span><span class="p">.</span><span class="nx">initSet</span><span class="p">()</span>
                <span class="nv">types = </span><span class="p">{}</span>
                <span class="nv">properties = </span><span class="p">{}</span>
                <span class="nv">spo = </span><span class="p">{}</span>
                <span class="nv">ops = </span><span class="p">{}</span>
        
                <span class="nx">options</span> <span class="o">?=</span> <span class="p">{}</span>

                <span class="nv">that = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">initInstance</span> <span class="s">&quot;MITHGrid.Data.Store&quot;</span><span class="p">,</span> <span class="nx">options</span></pre></div>             </td>           </tr>                               <tr id="section-37">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-37">&#182;</a>               </div>               <h3>#items (see Set#items)</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.items = </span><span class="nx">set</span><span class="p">.</span><span class="nx">items</span>
                </pre></div>             </td>           </tr>                               <tr id="section-38">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-38">&#182;</a>               </div>               <h3>#contains (see Set#contains)</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.contains = </span><span class="nx">set</span><span class="p">.</span><span class="nx">contains</span>
                </pre></div>             </td>           </tr>                               <tr id="section-39">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-39">&#182;</a>               </div>               <h3>#visit (see Set#visit)</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.visit = </span><span class="nx">set</span><span class="p">.</span><span class="nx">visit</span>
                </pre></div>             </td>           </tr>                               <tr id="section-40">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-40">&#182;</a>               </div>               <h3>#size (see Set#size)</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.size = </span><span class="nx">set</span><span class="p">.</span><span class="nx">size</span></pre></div>             </td>           </tr>                               <tr id="section-41">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-41">&#182;</a>               </div>               <h3>indexPut (private)</h3>

<p>Puts a triple into an index. This manages reference counting.</p>

<p>Parameters:</p>

<ul>
<li>index - the index to which the triple is added</li>
<li>x, y, z - the triple to insert into the index (s,p,o or o,p,s)</li>
</ul>

<p>Returns: Nothing.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">indexPut = </span><span class="nf">(index, x, y, z) -&gt;</span>
                    <span class="nv">hash = </span><span class="nx">index</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span>

                    <span class="k">if</span> <span class="o">!</span><span class="nx">hash</span><span class="o">?</span>
                        <span class="nv">hash =</span>
                            <span class="nv">values: </span><span class="p">{}</span>
                            <span class="nv">counts: </span><span class="p">{}</span>
                        <span class="nx">index</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span> <span class="o">=</span> <span class="nx">hash</span>

                    <span class="nv">array = </span><span class="nx">hash</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="nx">y</span><span class="p">]</span>
                    <span class="nv">counts = </span><span class="nx">hash</span><span class="p">.</span><span class="nx">counts</span><span class="p">[</span><span class="nx">y</span><span class="p">]</span>

                    <span class="k">if</span> <span class="o">!</span><span class="nx">array</span><span class="o">?</span>
                        <span class="nv">array = </span><span class="p">[]</span>
                        <span class="nx">hash</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="nx">y</span><span class="p">]</span> <span class="o">=</span> <span class="nx">array</span>
                    <span class="k">if</span> <span class="o">!</span><span class="nx">counts</span><span class="o">?</span>
                        <span class="nv">counts = </span><span class="p">{}</span>
                        <span class="nx">hash</span><span class="p">.</span><span class="nx">counts</span><span class="p">[</span><span class="nx">y</span><span class="p">]</span> <span class="o">=</span> <span class="nx">counts</span>
                    <span class="k">else</span> <span class="k">if</span> <span class="nx">z</span> <span class="k">in</span> <span class="nx">array</span>
                        <span class="nx">counts</span><span class="p">[</span><span class="nx">z</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="k">return</span>
                    <span class="nx">array</span><span class="p">.</span><span class="nx">push</span> <span class="nx">z</span>
                    <span class="nx">counts</span><span class="p">[</span><span class="nx">z</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span></pre></div>             </td>           </tr>                               <tr id="section-42">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-42">&#182;</a>               </div>               <h3>indexFillSet (private)</h3>

<p>Parameters:</p>

<ul>
<li>index</li>
<li>x, y</li>
<li>set</li>
<li>filter</li>
</ul>

<p>Returns: Nothing.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">indexFillSet = </span><span class="nf">(index, x, y, set, filter) -&gt;</span>
                    <span class="nv">hash = </span><span class="nx">index</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span>

                    <span class="k">if</span> <span class="nx">hash</span><span class="o">?</span>
                        <span class="nv">array = </span><span class="nx">hash</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="nx">y</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nx">array</span><span class="o">?</span>
                            <span class="k">if</span> <span class="nx">filter</span><span class="o">?</span>
                                <span class="k">for</span> <span class="nx">z</span> <span class="k">in</span> <span class="nx">array</span>
                                    <span class="nx">set</span><span class="p">.</span><span class="nx">add</span> <span class="nx">z</span> <span class="k">if</span> <span class="nx">filter</span><span class="p">.</span><span class="nx">contains</span> <span class="nx">z</span>
                            <span class="k">else</span>
                                <span class="nx">set</span><span class="p">.</span><span class="nx">add</span> <span class="nx">z</span> <span class="k">for</span> <span class="nx">z</span> <span class="k">in</span> <span class="nx">array</span></pre></div>             </td>           </tr>                               <tr id="section-43">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-43">&#182;</a>               </div>               <h3>getUnion (private)</h3>

<p>Parameters:</p>

<ul>
<li>index</li>
<li>xSet</li>
<li>y</li>
<li>set</li>
<li>filter</li>
</ul>

<p>Returns:</p>

<p>If set is not defined, then a new set is created and returned. Otherwise, the set passed in is returned
with the additional items added.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">getUnion = </span><span class="nf">(index, xSet, y, set, filter) -&gt;</span>
                    <span class="k">if</span> <span class="o">!</span><span class="nx">set</span><span class="o">?</span>
                        <span class="nv">set = </span><span class="nx">Data</span><span class="p">.</span><span class="nx">initSet</span><span class="p">()</span>

                    <span class="nx">xSet</span><span class="p">.</span><span class="nx">visit</span> <span class="nf">(x) -&gt;</span> <span class="nx">indexFillSet</span> <span class="nx">index</span><span class="p">,</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span><span class="p">,</span> <span class="nx">set</span><span class="p">,</span> <span class="nx">filter</span>
                    <span class="nx">set</span></pre></div>             </td>           </tr>                               <tr id="section-44">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-44">&#182;</a>               </div>               <h3>#addProperty</h3>

<p>Adds metadata about a property.</p>

<p>Parameters:</p>

<ul>
<li>nom - property name</li>
<li>options - object holding metadata about the property</li>
</ul>

<p>Returns:</p>

<p>The property object holding the information.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.addProperty = </span><span class="nf">(nom, options) -&gt;</span>
                    <span class="nv">prop = </span><span class="nx">Data</span><span class="p">.</span><span class="nx">initProperty</span> <span class="nx">nom</span>
                    <span class="k">if</span> <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">valueType</span><span class="o">?</span>
                        <span class="nv">prop.valueType = </span><span class="nx">options</span><span class="p">.</span><span class="nx">valueType</span>
                        <span class="nx">properties</span><span class="p">[</span><span class="nx">nom</span><span class="p">]</span> <span class="o">=</span> <span class="nx">prop</span>
                    <span class="nx">prop</span></pre></div>             </td>           </tr>                               <tr id="section-45">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-45">&#182;</a>               </div>               <h3>#getProperty</h3>

<p>Returns the property object holding the related metadata.</p>

<p>Parameters:</p>

<ul>
<li>nom - property name</li>
</ul>

<p>Returns:</p>

<p>Object holding the property metadata.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.getProperty = </span><span class="nf">(nom) -&gt;</span> <span class="nx">properties</span><span class="p">[</span><span class="nx">nom</span><span class="p">]</span> <span class="o">?</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">initProperty</span><span class="p">(</span><span class="nx">nom</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-46">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-46">&#182;</a>               </div>               <h3>#addType</h3>

<p>Adds metadata about a type.</p>

<p>Parameters:</p>

<ul>
<li>nom - type name</li>
<li>options - object holding metadata about the type</li>
</ul>

<p>Returns:</p>

<p>The type object holding the information.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.addType = </span><span class="nf">(nom, options) -&gt;</span>
                    <span class="nv">type = </span><span class="nx">Data</span><span class="p">.</span><span class="nx">initType</span><span class="p">(</span><span class="nx">nom</span><span class="p">)</span>
                    <span class="nx">types</span><span class="p">[</span><span class="nx">nom</span><span class="p">]</span> <span class="o">=</span> <span class="nx">type</span>
                    <span class="nx">type</span></pre></div>             </td>           </tr>                               <tr id="section-47">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-47">&#182;</a>               </div>               <h3>#getType</h3>

<p>Returns the type object holding the related metadata.</p>

<p>Parameters:</p>

<ul>
<li>nom - type name</li>
</ul>

<p>Returns:</p>

<p>Object holding the type metadata.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.getType = </span><span class="nf">(nom) -&gt;</span> <span class="nx">types</span><span class="p">[</span><span class="nx">nom</span><span class="p">]</span> <span class="o">?</span> <span class="nx">Data</span><span class="p">.</span><span class="nx">initType</span><span class="p">(</span><span class="nx">nom</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-48">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-48">&#182;</a>               </div>               <h3>#getItem</h3>

<p>Returns the triples related to an item ID</p>

<p>Parameters:</p>

<ul>
<li>id - item ID</li>
</ul>

<p>Returns:</p>

<p>An object containing the triples related to the item ID. If the item ID is not in the data store, then
and empty object is returned.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.getItem = </span><span class="nf">(id) -&gt;</span> <span class="nx">spo</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">values</span> <span class="o">?</span> <span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-49">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-49">&#182;</a>               </div>               <h3>#getItems</h3>

<p>Returns an array of objects holding the triples associated with an array of item IDs.</p>

<p>Parameters:</p>

<ul>
<li>ids - array of item IDs</li>
</ul>

<p>Returns:</p>

<p>An array of objects containing the triples related to the item IDs.</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.getItems = </span><span class="nf">(ids) -&gt;</span>
                    <span class="k">return</span> <span class="p">[</span><span class="nx">that</span><span class="p">.</span><span class="nx">getItem</span> <span class="nx">ids</span><span class="p">]</span> <span class="k">if</span> <span class="o">!</span><span class="nx">$</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">ids</span>
                    <span class="nx">$</span><span class="p">.</span><span class="nx">map</span> <span class="nx">ids</span><span class="p">,</span> <span class="nf">(id, idx) -&gt;</span> <span class="nx">that</span><span class="p">.</span><span class="nx">getItem</span> <span class="nx">id</span>
                    </pre></div>             </td>           </tr>                               <tr id="section-50">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-50">&#182;</a>               </div>               <h3>#removeItems</h3>

<p>Removes triples associated with the item IDs.</p>

<p>Parameters:</p>

<ul>
<li>ids - list of item IDs</li>
<li>fn - callback function</li>
</ul>

<p>Returns: Nothing</p>

<p>Events:</p>

<ul>
<li>onModelChange</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.removeItems = </span><span class="nf">(ids, fn) -&gt;</span>
                    <span class="nv">id_list = </span><span class="p">[]</span>
            </pre></div>             </td>           </tr>                               <tr id="section-51">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-51">&#182;</a>               </div>               <h4>indexRemove (private to #removeItems)</h4>

<p>Removes a triple from an index if the reference count is zero.</p>

<p>Parameters:</p>

<ul>
<li>index</li>
<li>x, y, z</li>
</ul>

<p>Returns: Nothing.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nv">indexRemove = </span><span class="nf">(index, x, y, z) -&gt;</span>
                        <span class="nv">hash = </span><span class="nx">index</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span>
                        <span class="k">return</span> <span class="k">if</span> <span class="o">!</span><span class="nx">hash</span><span class="o">?</span>

                        <span class="nv">array = </span><span class="nx">hash</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="nx">y</span><span class="p">];</span>
                        <span class="nv">counts = </span><span class="nx">hash</span><span class="p">.</span><span class="nx">counts</span><span class="p">[</span><span class="nx">y</span><span class="p">];</span>

                        <span class="k">return</span> <span class="k">if</span> <span class="o">!</span><span class="nx">array</span><span class="o">?</span> <span class="o">or</span> <span class="o">!</span><span class="nx">counts</span><span class="o">?</span>

                        <span class="nx">counts</span><span class="p">[</span><span class="nx">z</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="nx">counts</span><span class="p">[</span><span class="nx">z</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span>
                            <span class="nv">i = </span><span class="nx">$</span><span class="p">.</span><span class="nx">inArray</span> <span class="nx">z</span><span class="p">,</span> <span class="nx">array</span>
                            <span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="mi">0</span>
                                <span class="nv">array = </span><span class="nx">array</span><span class="p">[</span><span class="mi">1</span><span class="p">...</span><span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
                            <span class="k">else</span> <span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span>
                                <span class="nv">array = </span><span class="nx">array</span><span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="nx">i</span><span class="p">]</span>
                            <span class="k">else</span> <span class="k">if</span> <span class="nx">i</span> <span class="o">&gt;</span> <span class="mi">0</span>
                                <span class="nv">array = </span><span class="nx">array</span><span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="nx">i</span><span class="p">].</span><span class="nx">concat</span> <span class="nx">array</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">...</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
                            <span class="k">if</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
                                <span class="nx">hash</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="nx">y</span><span class="p">]</span> <span class="o">=</span> <span class="nx">array</span>
                            <span class="k">else</span>
                                <span class="k">delete</span> <span class="nx">hash</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="nx">y</span><span class="p">]</span>
                            <span class="k">delete</span> <span class="nx">counts</span><span class="p">[</span><span class="nx">z</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-52">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-52">&#182;</a>               </div>               <p>TODO: if counts empty, then we need to bubble up the deletion</p>             </td>             <td class="code">               <div class="highlight"><pre>                            <span class="nv">sum = </span><span class="mi">0</span>
                            <span class="k">for</span> <span class="nx">k</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">counts</span>
                                <span class="nx">sum</span> <span class="o">+=</span> <span class="nx">v</span>
                            <span class="k">if</span> <span class="nx">sum</span> <span class="o">==</span> <span class="mi">0</span>
                                <span class="k">delete</span> <span class="nx">index</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-53">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-53">&#182;</a>               </div>               <h4>indexRemoveFn (private to #removeItems)</h4>

<p>Removes the triple from the forward and backward indices.</p>

<p>Parameters:</p>

<ul>
<li>s - subject (item ID)</li>
<li>p - predicate (property)</li>
<li>o - object (value)</li>
</ul>

<p>Returns: Nothing.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nv">indexRemoveFn = </span><span class="nf">(s, p, o) -&gt;</span>
                        <span class="nx">indexRemove</span> <span class="nx">spo</span><span class="p">,</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">o</span>
                        <span class="nx">indexRemove</span> <span class="nx">ops</span><span class="p">,</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">s</span>
            </pre></div>             </td>           </tr>                               <tr id="section-54">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-54">&#182;</a>               </div>               <h4>removeValues (private to #removeItems)</h4>

<p>Removes the listed values for the property associated with the item ID.</p>

<p>Parameters:</p>

<ul>
<li>id - item ID</li>
<li>p - property name</li>
<li>list - list of values associated with the property</li>
</ul>

<p>Returns: Nothing</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nv">removeValues = </span><span class="nf">(id, p, list) -&gt;</span> <span class="nx">indexRemoveFn</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">o</span><span class="p">)</span> <span class="k">for</span> <span class="nx">o</span> <span class="k">in</span> <span class="nx">list</span>
            </pre></div>             </td>           </tr>                               <tr id="section-55">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-55">&#182;</a>               </div>               <h4>removeItem (private to #removeItems)</h4>

<p>Removes the item from the data store.</p>

<p>Parameters:</p>

<ul>
<li>id - item ID</li>
</ul>

<p>Returns: Nothing.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nv">removeItem = </span><span class="nf">(id) -&gt;</span>
                        <span class="nv">entry = </span><span class="nx">that</span><span class="p">.</span><span class="nx">getItem</span> <span class="nx">id</span>
                        <span class="nv">type = </span><span class="nx">entry</span><span class="p">.</span><span class="nx">type</span>
                        <span class="nv">type = </span><span class="nx">type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span>
                
                        <span class="k">for</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">items</span> <span class="k">of</span> <span class="nx">entry</span>
                            <span class="k">continue</span> <span class="k">if</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&quot;string&quot;</span> <span class="o">or</span> <span class="nx">p</span> <span class="k">in</span> <span class="p">[</span><span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="s">&quot;type&quot;</span><span class="p">]</span>
                            <span class="nx">removeValues</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">items</span>
                
                        <span class="nx">removeValues</span> <span class="nx">id</span><span class="p">,</span> <span class="s">&#39;type&#39;</span><span class="p">,</span> <span class="p">[</span> <span class="nx">type</span> <span class="p">]</span>
                
                    
                    <span class="k">for</span> <span class="nx">id</span> <span class="k">in</span> <span class="nx">ids</span>
                        <span class="nx">removeItem</span> <span class="nx">id</span>
                        <span class="nx">id_list</span><span class="p">.</span><span class="nx">push</span> <span class="nx">id</span>
                        <span class="nx">set</span><span class="p">.</span><span class="nx">remove</span> <span class="nx">id</span>
                
                    <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onModelChange</span><span class="p">.</span><span class="nx">fire</span> <span class="nx">that</span><span class="p">,</span> <span class="nx">id_list</span>
                    <span class="k">if</span> <span class="nx">fn</span><span class="o">?</span>
                        <span class="nx">fn</span><span class="p">()</span>
                        </pre></div>             </td>           </tr>                               <tr id="section-56">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-56">&#182;</a>               </div>               <h3>#updateItems</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.updateItems = </span><span class="nf">(items, fn) -&gt;</span>
                    <span class="nv">id_list = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-57">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-57">&#182;</a>               </div>               <h4>indexRemove (private to #updateItems)</h4>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nv">indexRemove = </span><span class="nf">(index, x, y, z) -&gt;</span>
                        <span class="nv">hash = </span><span class="nx">index</span><span class="p">[</span><span class="nx">x</span><span class="p">]</span>
                        <span class="k">return</span> <span class="k">if</span> <span class="o">!</span><span class="nx">hash</span><span class="o">?</span>

                        <span class="nv">array = </span><span class="nx">hash</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="nx">y</span><span class="p">]</span>
                        <span class="nv">counts = </span><span class="nx">hash</span><span class="p">.</span><span class="nx">counts</span><span class="p">[</span><span class="nx">y</span><span class="p">]</span>

                        <span class="k">return</span> <span class="k">if</span> <span class="o">!</span><span class="nx">array</span><span class="o">?</span> <span class="o">or</span> <span class="o">!</span><span class="nx">counts</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-58">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-58">&#182;</a>               </div>               <p>we need to remove the old z values</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="nx">counts</span><span class="p">[</span><span class="nx">z</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
                        <span class="k">if</span> <span class="nx">counts</span><span class="p">[</span><span class="nx">z</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">1</span>
                            <span class="nv">i = </span><span class="nx">$</span><span class="p">.</span><span class="nx">inArray</span> <span class="nx">z</span><span class="p">,</span> <span class="nx">array</span>
                            <span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="mi">0</span>
                                <span class="nv">array = </span><span class="nx">array</span><span class="p">[</span><span class="mi">1</span><span class="p">...</span><span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
                            <span class="k">else</span> <span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span>
                                <span class="nv">array = </span><span class="nx">array</span><span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="nx">i</span><span class="p">]</span>
                            <span class="k">else</span> <span class="k">if</span> <span class="nx">i</span> <span class="o">&gt;</span> <span class="mi">0</span>
                                <span class="nv">array = </span><span class="nx">array</span><span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="nx">i</span><span class="p">].</span><span class="nx">concat</span> <span class="nx">array</span><span class="p">[</span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">...</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
                            <span class="k">if</span> <span class="nx">array</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
                                <span class="nx">hash</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="nx">y</span><span class="p">]</span> <span class="o">=</span> <span class="nx">array</span>
                            <span class="k">else</span>
                                <span class="k">delete</span> <span class="nx">hash</span><span class="p">.</span><span class="nx">values</span><span class="p">[</span><span class="nx">y</span><span class="p">]</span>
                            <span class="k">delete</span> <span class="nx">counts</span><span class="p">[</span><span class="nx">z</span><span class="p">]</span>
                        </pre></div>             </td>           </tr>                               <tr id="section-59">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-59">&#182;</a>               </div>               <h4>indexPutFn (private to #updateItems)</h4>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nv">indexPutFn = </span><span class="nf">(s, p, o) -&gt;</span>
                        <span class="nx">indexPut</span> <span class="nx">spo</span><span class="p">,</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">o</span>
                        <span class="nx">indexPut</span> <span class="nx">ops</span><span class="p">,</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">s</span></pre></div>             </td>           </tr>                               <tr id="section-60">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-60">&#182;</a>               </div>               <h4>indexRemoveFn (private to #updateItems)</h4>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nv">indexRemoveFn = </span><span class="nf">(s, p, o) -&gt;</span>
                        <span class="nx">indexRemove</span> <span class="nx">spo</span><span class="p">,</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">o</span>
                        <span class="nx">indexRemove</span> <span class="nx">ops</span><span class="p">,</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">s</span></pre></div>             </td>           </tr>                               <tr id="section-61">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-61">&#182;</a>               </div>               <h4>updateItem (private to #updateItems)</h4>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nv">updateItem = </span><span class="nf">(entry) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-62">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-62">&#182;</a>               </div>               <p>we only update things that are different from the old_item
we also only update properties that are in the new item
if anything is changed, we return true
otherwise, we return false</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="nv">id = </span><span class="nx">entry</span><span class="p">.</span><span class="nx">id</span>
                        <span class="nv">type = </span><span class="nx">entry</span><span class="p">.</span><span class="nx">type</span>
                        <span class="nv">changed = </span><span class="kc">false</span>

                        <span class="nv">itemListIdentical = </span><span class="nf">(to, from) -&gt;</span>
                            <span class="nv">items_same = </span><span class="kc">true</span>
                            <span class="k">return</span> <span class="kc">false</span> <span class="k">if</span> <span class="nx">to</span><span class="p">.</span><span class="nx">length</span> <span class="o">!=</span> <span class="nx">from</span><span class="p">.</span><span class="nx">length</span>
                            <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">to</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
                                <span class="k">if</span> <span class="nx">to</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nx">from</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
                                    <span class="nv">items_same = </span><span class="kc">false</span>
                            <span class="nx">items_same</span>

                        <span class="nv">removeValues = </span><span class="nf">(id, p, list) -&gt;</span> <span class="nx">indexRemoveFn</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">o</span><span class="p">)</span> <span class="k">for</span> <span class="nx">o</span> <span class="k">in</span> <span class="nx">list</span>
                        <span class="nv">putValues = </span><span class="nf">(id, p, list) -&gt;</span> <span class="nx">indexPutFn</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">o</span><span class="p">)</span> <span class="k">for</span> <span class="nx">o</span> <span class="k">in</span> <span class="nx">list</span>
                
                        <span class="nv">id = </span><span class="nx">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
                        <span class="nv">type = </span><span class="nx">type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">type</span><span class="p">)</span>

                        <span class="nv">old_item = </span><span class="nx">that</span><span class="p">.</span><span class="nx">getItem</span> <span class="nx">id</span>

                        <span class="k">for</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">items</span> <span class="k">of</span> <span class="nx">entry</span>
                            <span class="k">continue</span> <span class="k">if</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&quot;string&quot;</span> <span class="o">or</span> <span class="nx">p</span> <span class="k">in</span> <span class="p">[</span><span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="s">&quot;type&quot;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-63">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-63">&#182;</a>               </div>               <p>if entry[p] and old_item[p] have the same members in the same order, then
we do nothing</p>             </td>             <td class="code">               <div class="highlight"><pre>                            <span class="nv">items = </span><span class="p">[</span><span class="nx">items</span><span class="p">]</span> <span class="k">if</span> <span class="o">!</span><span class="nx">$</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">items</span><span class="p">)</span>
                            <span class="nv">s = </span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span>
                            <span class="k">if</span> <span class="o">!</span><span class="nx">old_item</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span><span class="o">?</span>
                                <span class="nx">putValues</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">items</span>
                                <span class="nv">changed = </span><span class="kc">true</span>
                            <span class="k">else</span> <span class="k">if</span> <span class="o">!</span><span class="nx">itemListIdentical</span> <span class="nx">items</span><span class="p">,</span> <span class="nx">old_item</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span>
                                <span class="nv">changed = </span><span class="kc">true</span>
                                <span class="nx">removeValues</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">old_item</span><span class="p">[</span><span class="nx">p</span><span class="p">]</span>
                                <span class="nx">putValues</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">items</span>
                        <span class="nx">changed</span>

                    <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onBeforeUpdating</span><span class="p">.</span><span class="nx">fire</span> <span class="nx">that</span>

                    <span class="nv">n = </span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span>
                    <span class="nv">chunk_size = </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">n</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
                    <span class="nv">chunk_size = </span><span class="mi">200</span> <span class="k">if</span> <span class="nx">chunk_size</span> <span class="o">&gt;</span> <span class="mi">200</span>
                    <span class="nv">chunk_size = </span><span class="mi">1</span> <span class="k">if</span> <span class="nx">chunk_size</span> <span class="o">&lt;</span> <span class="mi">1</span>

                    <span class="nv">f = </span><span class="nf">(start) -&gt;</span>
                        <span class="nv">end = </span><span class="nx">start</span> <span class="o">+</span> <span class="nx">chunk_size</span><span class="p">;</span>
                        <span class="nv">end = </span><span class="nx">n</span> <span class="k">if</span> <span class="nx">end</span> <span class="o">&gt;</span> <span class="nx">n</span>

                        <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="nx">start</span> <span class="p">...</span> <span class="nx">end</span><span class="p">]</span>
                            <span class="nv">entry = </span><span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
                            <span class="k">if</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">entry</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;object&quot;</span> <span class="o">and</span> <span class="nx">updateItem</span> <span class="nx">entry</span>
                                <span class="nx">id_list</span><span class="p">.</span><span class="nx">push</span> <span class="nx">entry</span><span class="p">.</span><span class="nx">id</span>

                        <span class="k">if</span> <span class="nx">end</span> <span class="o">&lt;</span> <span class="nx">n</span>
                            <span class="nx">setTimeout</span> <span class="nf">() -&gt;</span>
                                <span class="nx">f</span> <span class="nx">end</span>
                            <span class="p">,</span>
                            <span class="mi">0</span>
                        <span class="k">else</span>
                            <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onAfterUpdating</span><span class="p">.</span><span class="nx">fire</span> <span class="nx">that</span>
                            <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onModelChange</span><span class="p">.</span><span class="nx">fire</span> <span class="nx">that</span><span class="p">,</span> <span class="nx">id_list</span>
                            <span class="k">if</span> <span class="nx">fn</span><span class="o">?</span>
                                <span class="nx">fn</span><span class="p">()</span>
                    <span class="nx">f</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-64">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-64">&#182;</a>               </div>               <h3>#loadItems</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.loadItems = </span><span class="nf">(items, endFn) -&gt;</span>
                    <span class="nv">id_list = </span><span class="p">[]</span></pre></div>             </td>           </tr>                               <tr id="section-65">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-65">&#182;</a>               </div>               <h4>indexFn (private to #loadItems)</h4>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nv">indexFn = </span><span class="nf">(s, p, o) -&gt;</span>
                        <span class="nx">indexPut</span> <span class="nx">spo</span><span class="p">,</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">o</span>
                        <span class="nx">indexPut</span> <span class="nx">ops</span><span class="p">,</span> <span class="nx">o</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">s</span></pre></div>             </td>           </tr>                               <tr id="section-66">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-66">&#182;</a>               </div>               <h4>loadItem (private to #loadItems)</h4>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nv">loadItem = </span><span class="nf">(item) -&gt;</span>
                        <span class="k">if</span> <span class="o">!</span><span class="nx">item</span><span class="p">.</span><span class="nx">id</span><span class="o">?</span>
                            <span class="k">throw</span> <span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">error</span> <span class="s">&quot;Item entry has no id: &quot;</span><span class="p">,</span> <span class="nx">item</span>
                        <span class="k">if</span> <span class="o">!</span><span class="nx">item</span><span class="p">.</span><span class="nx">type</span><span class="o">?</span>
                            <span class="k">throw</span> <span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">error</span> <span class="s">&quot;Item entry has no type: &quot;</span><span class="p">,</span> <span class="nx">item</span>

                        <span class="nv">id = </span><span class="nx">item</span><span class="p">.</span><span class="nx">id</span>
                        <span class="nv">type = </span><span class="nx">item</span><span class="p">.</span><span class="nx">type</span>

                        <span class="nv">id = </span><span class="nx">id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">id</span>
                        <span class="nv">type = </span><span class="nx">type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="nx">isArray</span> <span class="nx">type</span>

                        <span class="nx">set</span><span class="p">.</span><span class="nx">add</span> <span class="nx">id</span>
                        <span class="nx">id_list</span><span class="p">.</span><span class="nx">push</span> <span class="nx">id</span>

                        <span class="nx">indexFn</span> <span class="nx">id</span><span class="p">,</span> <span class="s">&quot;type&quot;</span><span class="p">,</span> <span class="nx">type</span>
                        <span class="nx">indexFn</span> <span class="nx">id</span><span class="p">,</span> <span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="nx">id</span>
                
                        <span class="k">for</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">v</span> <span class="k">of</span> <span class="nx">item</span>
                            <span class="k">if</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">p</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&quot;string&quot;</span>
                                <span class="k">continue</span>
                        
                            <span class="k">if</span> <span class="nx">p</span> <span class="o">not</span> <span class="k">in</span> <span class="p">[</span><span class="s">&quot;id&quot;</span><span class="p">,</span> <span class="s">&quot;type&quot;</span><span class="p">]</span>
                                <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
                                    <span class="nx">indexFn</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">vv</span> <span class="k">for</span> <span class="nx">vv</span> <span class="k">in</span> <span class="nx">v</span>
                                <span class="k">else</span> <span class="k">if</span> <span class="nx">v</span><span class="o">?</span>
                                    <span class="nx">indexFn</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">v</span>
                    <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onBeforeLoading</span><span class="p">.</span><span class="nx">fire</span> <span class="nx">that</span>
            
                    <span class="nv">n = </span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span>
                    <span class="k">if</span> <span class="nx">endFn</span><span class="o">?</span>
                        <span class="nv">chunk_size = </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">n</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
                        <span class="nv">chunk_size = </span><span class="mi">200</span> <span class="k">if</span> <span class="nx">chunk_size</span> <span class="o">&gt;</span> <span class="mi">200</span>
                    <span class="k">else</span>
                        <span class="nv">chunk_size = </span><span class="nx">n</span>
                    <span class="nv">chunk_size = </span><span class="mi">1</span> <span class="k">if</span> <span class="nx">chunk_size</span> <span class="o">&lt;</span> <span class="mi">1</span>
            
                    <span class="nv">f = </span><span class="nf">(start) -&gt;</span>
                        <span class="nv">end = </span><span class="nx">start</span> <span class="o">+</span> <span class="nx">chunk_size</span>
                        <span class="nv">end = </span><span class="nx">n</span> <span class="k">if</span> <span class="nx">end</span> <span class="o">&gt;</span> <span class="nx">n</span>

                        <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span> <span class="nx">start</span> <span class="p">...</span> <span class="nx">end</span> <span class="p">]</span>
                            <span class="nv">entry = </span><span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
                            <span class="nx">loadItem</span> <span class="nx">entry</span> <span class="k">if</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">entry</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;object&quot;</span>

                        <span class="k">if</span> <span class="nx">end</span> <span class="o">&lt;</span> <span class="nx">n</span>
                            <span class="nx">setTimeout</span> <span class="nf">() -&gt;</span>
                                <span class="nx">f</span><span class="p">(</span><span class="nx">end</span><span class="p">)</span>
                            <span class="p">,</span> <span class="mi">0</span>
                        <span class="k">else</span>
                            <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onAfterLoading</span><span class="p">.</span><span class="nx">fire</span> <span class="nx">that</span>
                            <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onModelChange</span><span class="p">.</span><span class="nx">fire</span> <span class="nx">that</span><span class="p">,</span> <span class="nx">id_list</span>
                            <span class="nx">setTimeout</span> <span class="nx">endFn</span><span class="p">,</span> <span class="mi">0</span> <span class="k">if</span> <span class="nx">endFn</span><span class="o">?</span>
                    <span class="nx">f</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-67">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-67">&#182;</a>               </div>               <h3>#prepare</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.prepare = </span><span class="nf">(expressions) -&gt;</span>
                    <span class="nv">parser = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initParser</span><span class="p">()</span>
                    <span class="nv">parsed = </span><span class="p">(</span><span class="nx">parser</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="k">for</span> <span class="nx">ex</span> <span class="k">in</span> <span class="nx">expressions</span><span class="p">)</span>
                    <span class="nv">valueType = </span><span class="kc">undefined</span>
                    <span class="nv">evaluate: </span><span class="nf">(id) -&gt;</span>
                        <span class="nv">values = </span><span class="p">[]</span>
                        <span class="nv">valueType = </span><span class="kc">undefined</span>
                        <span class="k">for</span> <span class="nx">ex</span> <span class="k">in</span> <span class="nx">parsed</span>
                            <span class="nx">do</span> <span class="nf">(ex) -&gt;</span>
                                <span class="nv">items = </span><span class="nx">ex</span><span class="p">.</span><span class="nx">evaluateOnItem</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">that</span>
                                <span class="nx">valueType</span> <span class="o">or=</span> <span class="nx">items</span><span class="p">.</span><span class="nx">valueType</span>
                                <span class="nv">values = </span><span class="nx">values</span><span class="p">.</span><span class="nx">concat</span> <span class="nx">items</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">items</span><span class="p">()</span>
                        <span class="nx">values</span>
                    <span class="nv">valueType: </span><span class="nf">() -&gt;</span> <span class="nx">valueType</span></pre></div>             </td>           </tr>                               <tr id="section-68">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-68">&#182;</a>               </div>               <h3>#getObjectsUnion</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.getObjectsUnion = </span><span class="nf">(subjects, p, set, filter) -&gt;</span> <span class="nx">getUnion</span> <span class="nx">spo</span><span class="p">,</span> <span class="nx">subjects</span><span class="p">,</span> <span class="nx">p</span><span class="p">,</span> <span class="nx">set</span><span class="p">,</span> <span class="nx">filter</span>
                </pre></div>             </td>           </tr>                               <tr id="section-69">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-69">&#182;</a>               </div>               <h3>#getSubjectsUnion</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.getSubjectsUnion = </span><span class="nf">(objects, p, set, filter) -&gt;</span> <span class="nx">getUnion</span> <span class="nx">ops</span><span class="p">,</span> <span class="nx">objects</span><span class="p">,</span>  <span class="nx">p</span><span class="p">,</span> <span class="nx">set</span><span class="p">,</span> <span class="nx">filter</span></pre></div>             </td>           </tr>                               <tr id="section-70">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-70">&#182;</a>               </div>               <h3>#registerPresentation</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.registerPresentation = </span><span class="nf">(ob) -&gt;</span>
                    <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onModelChange</span><span class="p">.</span><span class="nx">addListener</span> <span class="nf">(m, i) -&gt;</span> <span class="nx">ob</span><span class="p">.</span><span class="nx">eventModelChange</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">i</span>
                    <span class="nx">ob</span><span class="p">.</span><span class="nx">eventModelChange</span> <span class="nx">that</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">items</span><span class="p">()</span>
            
                <span class="nx">that</span></pre></div>             </td>           </tr>                               <tr id="section-71">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-71">&#182;</a>               </div>               <h1>Data View</h1>

<p>Provides a filtered view of a data store based on configured filters (e.g., facets). The filtered view can
also be constrained based on item types or other simple property value expectations.</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Data</span><span class="p">.</span><span class="nx">namespace</span> <span class="s">&#39;View&#39;</span><span class="p">,</span> <span class="nf">(View) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-72">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-72">&#182;</a>               </div>               <h2>View.initInstance</h2>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nv">View.initInstance = </span><span class="nf">(options) -&gt;</span>
                <span class="nv">that = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">initView</span> <span class="s">&quot;MITHGrid.Data.View&quot;</span><span class="p">,</span> <span class="nx">options</span>
        
                <span class="nv">set = </span><span class="nx">Data</span><span class="p">.</span><span class="nx">initSet</span><span class="p">()</span>
        </pre></div>             </td>           </tr>                               <tr id="section-73">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-73">&#182;</a>               </div>               <h3>filterItem (private)</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">filterItem = </span><span class="nf">(id) -&gt;</span>
                    <span class="kc">false</span> <span class="o">!=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onFilterItem</span><span class="p">.</span><span class="nx">fire</span> <span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">,</span> <span class="nx">id</span></pre></div>             </td>           </tr>                               <tr id="section-74">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-74">&#182;</a>               </div>               <h3>filterItems (private)</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">filterItems = </span><span class="nf">(endFn) -&gt;</span>
                    <span class="nv">ids = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">items</span><span class="p">()</span>
                    <span class="nv">n = </span><span class="nx">ids</span><span class="p">.</span><span class="nx">length</span>
                    <span class="k">if</span> <span class="nx">n</span> <span class="o">==</span> <span class="mi">0</span>
                        <span class="nx">endFn</span><span class="p">()</span>
                        <span class="k">return</span>

                    <span class="k">if</span> <span class="nx">n</span> <span class="o">&gt;</span> <span class="mi">200</span>
                        <span class="nv">chunk_size = </span><span class="nb">parseInt</span><span class="p">(</span><span class="nx">n</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
                        <span class="nv">chunk_size = </span><span class="mi">200</span> <span class="k">if</span> <span class="nx">chunk_size</span> <span class="o">&gt;</span> <span class="mi">200</span>
                    <span class="k">else</span>
                        <span class="nv">chunk_size = </span><span class="nx">n</span>
                    <span class="nv">chunk_size = </span><span class="mi">1</span> <span class="k">if</span> <span class="nx">chunk_size</span> <span class="o">&lt;</span> <span class="mi">1</span>

                    <span class="nv">f = </span><span class="nf">(start) -&gt;</span>
                        <span class="nv">end = </span><span class="nx">start</span> <span class="o">+</span> <span class="nx">chunk_size</span>
                        <span class="nv">end = </span><span class="nx">n</span> <span class="k">if</span> <span class="nx">end</span> <span class="o">&gt;</span> <span class="nx">n</span>

                        <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span> <span class="nx">start</span> <span class="p">...</span> <span class="nx">end</span> <span class="p">]</span>
                            <span class="nv">id = </span><span class="nx">ids</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
                            <span class="k">if</span> <span class="nx">filterItem</span> <span class="nx">id</span>
                                <span class="nx">set</span><span class="p">.</span><span class="nx">add</span> <span class="nx">id</span>
                            <span class="k">else</span>
                                <span class="nx">set</span><span class="p">.</span><span class="nx">remove</span> <span class="nx">id</span>
                        <span class="k">if</span> <span class="nx">end</span> <span class="o">&lt;</span> <span class="nx">n</span>
                            <span class="nx">setTimeout</span> <span class="nf">() -&gt;</span>
                                <span class="nx">f</span> <span class="nx">end</span>
                            <span class="p">,</span> <span class="mi">0</span>
                        <span class="k">else</span>
                            <span class="nv">that.items = </span><span class="nx">set</span><span class="p">.</span><span class="nx">items</span>
                            <span class="nv">that.size = </span><span class="nx">set</span><span class="p">.</span><span class="nx">size</span>
                            <span class="nv">that.contains = </span><span class="nx">set</span><span class="p">.</span><span class="nx">contains</span>
                            <span class="nv">that.visit = </span><span class="nx">set</span><span class="p">.</span><span class="nx">visit</span>
                            <span class="k">if</span> <span class="nx">endFn</span><span class="o">?</span>
                                <span class="nx">setTimeout</span> <span class="nx">endFn</span><span class="p">,</span> <span class="mi">0</span>
                    <span class="nx">f</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-75">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-75">&#182;</a>               </div>               <h3>#registerFilter</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.registerFilter = </span><span class="nf">(ob) -&gt;</span>
                    <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onFilterItem</span><span class="p">.</span><span class="nx">addListener</span> <span class="nf">(x, y) -&gt;</span> <span class="nx">ob</span><span class="p">.</span><span class="nx">eventFilterItem</span> <span class="nx">x</span><span class="p">,</span> <span class="nx">y</span>
                    <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onModelChange</span><span class="p">.</span><span class="nx">addListener</span> <span class="nf">(m, i) -&gt;</span> <span class="nx">ob</span><span class="p">.</span><span class="nx">eventModelChange</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">i</span>
                    <span class="nx">ob</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onFilterChange</span><span class="p">.</span><span class="nx">addListener</span> <span class="nx">that</span><span class="p">.</span><span class="nx">eventFilterChange</span></pre></div>             </td>           </tr>                               <tr id="section-76">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-76">&#182;</a>               </div>               <h3>#registerPresentation</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.registerPresentation = </span><span class="nf">(ob) -&gt;</span>
                    <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onModelChange</span><span class="p">.</span><span class="nx">addListener</span> <span class="nf">(m, i) -&gt;</span> <span class="nx">ob</span><span class="p">.</span><span class="nx">eventModelChange</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">i</span>
                    <span class="nx">filterItems</span> <span class="nf">() -&gt;</span> <span class="nx">ob</span><span class="p">.</span><span class="nx">eventModelChange</span> <span class="nx">that</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">items</span><span class="p">()</span>

                </pre></div>             </td>           </tr>                               <tr id="section-77">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-77">&#182;</a>               </div>               <h3>#items (see Set#items)</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.items = </span><span class="nx">set</span><span class="p">.</span><span class="nx">items</span></pre></div>             </td>           </tr>                               <tr id="section-78">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-78">&#182;</a>               </div>               <h3>#contains (see Set#contains)</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.contains = </span><span class="nx">set</span><span class="p">.</span><span class="nx">contains</span></pre></div>             </td>           </tr>                               <tr id="section-79">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-79">&#182;</a>               </div>               <h3>#visit (see Set#visit)</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.visit = </span><span class="nx">set</span><span class="p">.</span><span class="nx">visit</span></pre></div>             </td>           </tr>                               <tr id="section-80">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-80">&#182;</a>               </div>               <h3>#size (see Set#size)</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.size = </span><span class="nx">set</span><span class="p">.</span><span class="nx">size</span>
        
                <span class="nv">that.eventFilterChange = </span><span class="nf">() -&gt;</span>
                    <span class="nv">current_set = </span><span class="nx">Data</span><span class="p">.</span><span class="nx">initSet</span> <span class="nx">that</span><span class="p">.</span><span class="nx">items</span><span class="p">()</span>
                    <span class="nx">filterItems</span> <span class="nf">() -&gt;</span>
                        <span class="nv">changed_set = </span><span class="nx">Data</span><span class="p">.</span><span class="nx">initSet</span><span class="p">()</span>
                        <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">current_set</span><span class="p">.</span><span class="nx">items</span><span class="p">()</span>
                            <span class="k">if</span> <span class="o">!</span><span class="nx">that</span><span class="p">.</span><span class="nx">contains</span> <span class="nx">i</span>
                                <span class="nx">changed_set</span><span class="p">.</span><span class="nx">add</span> <span class="nx">i</span>
                        <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">that</span><span class="p">.</span><span class="nx">items</span><span class="p">()</span>
                            <span class="k">if</span> <span class="o">!</span><span class="nx">current_set</span><span class="p">.</span><span class="nx">contains</span> <span class="nx">i</span>
                                <span class="nx">changed_set</span><span class="p">.</span><span class="nx">add</span> <span class="nx">i</span>
                        <span class="k">if</span> <span class="nx">changed_set</span><span class="p">.</span><span class="nx">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>
                            <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onModelChange</span><span class="p">.</span><span class="nx">fire</span> <span class="nx">that</span><span class="p">,</span> <span class="nx">changed_set</span><span class="p">.</span><span class="nx">items</span><span class="p">()</span>
                
                <span class="nv">that.eventModelChange = </span><span class="nf">(model, items) -&gt;</span>
                    <span class="nv">changed_set = </span><span class="nx">Data</span><span class="p">.</span><span class="nx">initSet</span><span class="p">()</span>
                
                    <span class="k">for</span> <span class="nx">id</span> <span class="k">in</span> <span class="nx">items</span>
                        <span class="k">if</span> <span class="nx">model</span><span class="p">.</span><span class="nx">contains</span> <span class="nx">id</span>
                            <span class="k">if</span> <span class="nx">filterItem</span> <span class="nx">id</span>
                                <span class="nx">set</span><span class="p">.</span><span class="nx">add</span> <span class="nx">id</span>
                                <span class="nx">changed_set</span><span class="p">.</span><span class="nx">add</span> <span class="nx">id</span>
                            <span class="k">else</span>
                                <span class="k">if</span> <span class="nx">set</span><span class="p">.</span><span class="nx">contains</span> <span class="nx">id</span>
                                    <span class="nx">changed_set</span><span class="p">.</span><span class="nx">add</span> <span class="nx">id</span>
                                    <span class="nx">set</span><span class="p">.</span><span class="nx">remove</span> <span class="nx">id</span>
                        <span class="k">else</span>
                            <span class="nx">changed_set</span><span class="p">.</span><span class="nx">add</span> <span class="nx">id</span>
                            <span class="nx">set</span><span class="p">.</span><span class="nx">remove</span> <span class="nx">id</span>

                    <span class="k">if</span> <span class="nx">changed_set</span><span class="p">.</span><span class="nx">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>
                        <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onModelChange</span><span class="p">.</span><span class="nx">fire</span> <span class="nx">that</span><span class="p">,</span> <span class="nx">changed_set</span><span class="p">.</span><span class="nx">items</span><span class="p">()</span>

                <span class="k">if</span> <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">types</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="p">(</span><span class="nf">(types) -&gt;</span>
                        <span class="nx">that</span><span class="p">.</span><span class="nx">registerFilter</span>
                            <span class="nv">eventFilterItem: </span><span class="nf">(model, id) -&gt;</span>
                                <span class="nv">item = </span><span class="nx">model</span><span class="p">.</span><span class="nx">getItem</span> <span class="nx">id</span>
                                <span class="k">return</span> <span class="kc">false</span> <span class="k">if</span> <span class="o">!</span><span class="nx">item</span><span class="p">.</span><span class="nx">type</span><span class="o">?</span>
                                <span class="k">for</span> <span class="nx">t</span> <span class="k">in</span> <span class="nx">types</span>
                                    <span class="k">return</span> <span class="k">if</span> <span class="nx">t</span> <span class="k">in</span> <span class="nx">item</span><span class="p">.</span><span class="nx">type</span>
                                <span class="k">return</span> <span class="kc">false</span>
                            <span class="nv">eventModelChange: </span><span class="nf">(x, y) -&gt;</span>
                            <span class="nv">events:</span>
                                <span class="nv">onFilterChange:</span>
                                    <span class="nv">addListener: </span><span class="nf">(x) -&gt;</span>
                    <span class="p">)(</span><span class="nx">options</span><span class="p">.</span><span class="nx">types</span><span class="p">)</span>

                <span class="k">if</span> <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">filters</span><span class="o">?</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="p">(</span><span class="nf">(filters) -&gt;</span>
                        <span class="nv">parser = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initParser</span><span class="p">()</span>
                        <span class="nv">parsedFilters = </span><span class="p">(</span><span class="nx">parser</span><span class="p">.</span><span class="nx">parse</span><span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="k">for</span> <span class="nx">ex</span> <span class="k">in</span> <span class="nx">filters</span><span class="p">)</span>
                        <span class="nx">that</span><span class="p">.</span><span class="nx">registerFilter</span>
                            <span class="nv">eventFilterItem: </span><span class="nf">(model, id) -&gt;</span>
                                <span class="k">for</span> <span class="nx">ex</span> <span class="k">in</span> <span class="nx">parsedFilters</span>
                                    <span class="nv">values = </span><span class="nx">ex</span><span class="p">.</span><span class="nx">evaluateOnItem</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">model</span><span class="p">)</span>
                                    <span class="nv">values = </span><span class="nx">values</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">items</span><span class="p">()</span>
                                    <span class="k">for</span> <span class="nx">v</span> <span class="k">in</span> <span class="nx">values</span>
                                        <span class="k">return</span> <span class="k">if</span> <span class="nx">v</span> <span class="o">!=</span> <span class="s">&quot;false&quot;</span>
                                <span class="k">return</span> <span class="kc">false</span>
                            <span class="nv">eventModelChange: </span><span class="nf">(x, y) -&gt;</span>
                            <span class="nv">events:</span>
                                <span class="nv">onFilterChange:</span>
                                    <span class="nv">addListener: </span><span class="nf">(x) -&gt;</span>
                    <span class="p">)(</span><span class="nx">options</span><span class="p">.</span><span class="nx">filters</span><span class="p">)</span>

                <span class="k">if</span> <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">collection</span><span class="o">?</span>
                    <span class="nx">that</span><span class="p">.</span><span class="nx">registerFilter</span>
                        <span class="nv">eventFilterItem: </span><span class="nx">options</span><span class="p">.</span><span class="nx">collection</span>
                        <span class="nv">eventModelChange: </span><span class="nf">(x, y) -&gt;</span>
                        <span class="nv">events:</span>
                            <span class="nv">onFilterChange:</span>
                                <span class="nv">addListener: </span><span class="nf">(x) -&gt;</span>

                <span class="k">if</span> <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">expressions</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-81">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-81">&#182;</a>               </div>               <p>We want a way to make our set of items depend on running expressions on the items
passed to us from the parent dataView/dataStore.
It needs to be quick, similar to the current propagation of changes.
<strong>N.B.:</strong> These are not event-based expressions.
The expressions must result in itemIds that are contained in the parent dataStore.</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nv">expressions = </span><span class="nx">options</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">prepare</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">expressions</span><span class="p">)</span>
                    <span class="nv">prevEventModelChange = </span><span class="nx">that</span><span class="p">.</span><span class="nx">eventModelChange</span>
                    <span class="nv">intermediateDataStore = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">initStore</span><span class="p">({})</span>
                    <span class="nv">subjectSet = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">initSet</span><span class="p">()</span>
                    <span class="nv">that.eventModelChange = </span><span class="nf">(model, items) -&gt;</span>
                        <span class="nv">itemList = </span><span class="p">[]</span>
                        <span class="nv">removedItems = </span><span class="p">[]</span>
                        <span class="nv">intermediateSet = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">initSet</span><span class="p">()</span>
                        <span class="nv">intermediateSet = </span><span class="nx">intermediateDataStore</span><span class="p">.</span><span class="nx">getObjectsUnion</span> <span class="nx">subjectSet</span><span class="p">,</span> <span class="s">&quot;mapsTo&quot;</span><span class="p">,</span> <span class="nx">intermediateSet</span>
                        <span class="k">for</span> <span class="nx">id</span> <span class="k">in</span> <span class="nx">items</span>
                            <span class="k">if</span> <span class="nx">intermediateSet</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
                                <span class="nx">itemList</span><span class="p">.</span><span class="nx">push</span> <span class="nx">id</span>
                                <span class="k">if</span> <span class="o">!</span><span class="nx">model</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-82">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-82">&#182;</a>               </div>               <p>we need to find everything that maps to id</p>             </td>             <td class="code">               <div class="highlight"><pre>                                    <span class="nv">idSet = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">initSet</span><span class="p">()</span>
                                    <span class="nx">intermediateDataStore</span><span class="p">.</span><span class="nx">getSubjectsUnion</span> <span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">initSet</span><span class="p">([</span><span class="nx">id</span><span class="p">]),</span> <span class="s">&quot;mapsTo&quot;</span><span class="p">,</span> <span class="nx">idSet</span>
                                    <span class="nx">idSet</span><span class="p">.</span><span class="nx">visit</span> <span class="nf">(x) -&gt;</span>
                                        <span class="nv">item = </span><span class="nx">intermediateDataStore</span><span class="p">.</span><span class="nx">getItem</span> <span class="nx">x</span>
                                        <span class="nv">mapsTo = </span><span class="nx">item</span><span class="p">.</span><span class="nx">mapsTo</span>
                                        <span class="k">if</span> <span class="nx">mapsTo</span><span class="o">?</span>
                                            <span class="nv">i = </span><span class="nx">mapsTo</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
                                            <span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="mi">0</span>
                                                <span class="nv">mapsTo = </span><span class="nx">mapsTo</span><span class="p">[</span><span class="mi">1</span> <span class="p">...</span> <span class="nx">mapsTo</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
                                            <span class="k">else</span> <span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="nx">mapsTo</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span>
                                                <span class="nv">mapsTo = </span><span class="nx">mapsTo</span><span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="nx">mapsTo</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                            <span class="k">else</span> <span class="k">if</span> <span class="nx">i</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">1</span>
                                                <span class="nv">mapsTo = </span><span class="nx">mapsTo</span><span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="nx">i</span><span class="p">].</span><span class="nx">concat</span> <span class="nx">mapsTo</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span> <span class="p">...</span> <span class="nx">mapsTo</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
                                            <span class="nx">intermediateDataStore</span><span class="p">.</span><span class="nx">updateItems</span> <span class="p">[</span>
                                                <span class="nv">id: </span><span class="nx">x</span>
                                                <span class="nv">mapsTo: </span><span class="nx">mapsTo</span>
                                            <span class="p">]</span>           
                            <span class="k">else</span> <span class="k">if</span> <span class="nx">model</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
                                <span class="nv">itemSet = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">initSet</span><span class="p">()</span>
                                <span class="k">for</span> <span class="nx">v</span> <span class="k">in</span> <span class="nx">expressions</span><span class="p">.</span><span class="nx">evaluate</span><span class="p">([</span><span class="nx">id</span><span class="p">])</span>
                                    <span class="nx">itemSet</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
                                <span class="k">if</span> <span class="nx">intermediateDataStore</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
                                    <span class="nx">intermediateDataStore</span><span class="p">.</span><span class="nx">updateItems</span> <span class="p">[</span>
                                        <span class="nv">id: </span><span class="nx">id</span>
                                        <span class="nv">mapsTo: </span><span class="nx">itemSet</span><span class="p">.</span><span class="nx">items</span><span class="p">()</span>
                                    <span class="p">]</span>
                                <span class="k">else</span>
                                    <span class="nx">intermediateDataStore</span><span class="p">.</span><span class="nx">loadItems</span> <span class="p">[</span>
                                        <span class="nv">id: </span><span class="nx">id</span>
                                        <span class="nv">mapsTo: </span><span class="nx">itemSet</span><span class="p">.</span><span class="nx">items</span><span class="p">()</span>
                                    <span class="p">]</span>
                            <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-83">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-83">&#182;</a>               </div>               <p>push onto itemList the items mapped to by this id</p>             </td>             <td class="code">               <div class="highlight"><pre>                                <span class="nv">itemList = </span><span class="nx">itemList</span><span class="p">.</span><span class="nx">concat</span><span class="p">(</span><span class="nx">intermediateDataStore</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="nx">id</span><span class="p">).</span><span class="nx">mapsTo</span><span class="p">)</span>
                                <span class="nx">removedItems</span><span class="p">.</span><span class="nx">push</span> <span class="nx">id</span>

                        <span class="k">if</span> <span class="nx">removedItems</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
                            <span class="nx">intermediateDataStore</span><span class="p">.</span><span class="nx">removeItems</span><span class="p">(</span><span class="nx">removedItems</span><span class="p">)</span>

                        <span class="nv">intermediateSet = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">initSet</span><span class="p">()</span>
                        <span class="nx">intermediateDataStore</span><span class="p">.</span><span class="nx">getObjectsUnion</span> <span class="nx">subjectSet</span><span class="p">,</span> <span class="s">&quot;mapsTo&quot;</span><span class="p">,</span> <span class="nx">intermediateSet</span>
                        <span class="nv">itemList = </span><span class="p">(</span><span class="nx">item</span> <span class="k">for</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">itemList</span> <span class="k">when</span> <span class="nx">item</span> <span class="k">in</span> <span class="nx">items</span><span class="p">)</span>
                        <span class="nx">prevEventModelChange</span> <span class="nx">intermediateSet</span><span class="p">,</span> <span class="nx">itemList</span>

                <span class="nv">that.dataStore = </span><span class="nx">options</span><span class="p">.</span><span class="nx">dataStore</span></pre></div>             </td>           </tr>                               <tr id="section-84">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-84">&#182;</a>               </div>               <h3>#getItems (see Data Store #getItems)</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.getItems = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">getItems</span>
                </pre></div>             </td>           </tr>                               <tr id="section-85">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-85">&#182;</a>               </div>               <h3>#getItem (see Data Store #getItem)</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.getItem = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">getItem</span>
                </pre></div>             </td>           </tr>                               <tr id="section-86">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-86">&#182;</a>               </div>               <h3>#removeItems (see Data Store #removeItems)</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.removeItems = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">removeItems</span>
                </pre></div>             </td>           </tr>                               <tr id="section-87">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-87">&#182;</a>               </div>               <h3>#updateItems (see Data Store #updateItems)</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.updateItems = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">updateItems</span>
                </pre></div>             </td>           </tr>                               <tr id="section-88">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-88">&#182;</a>               </div>               <h3>#loadItems (see Data Store #loadItems)</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.loadItems = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">loadItems</span>
                </pre></div>             </td>           </tr>                               <tr id="section-89">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-89">&#182;</a>               </div>               <h3>#prepare (see Data Store #prepare)</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.prepare = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">prepare</span>
                </pre></div>             </td>           </tr>                               <tr id="section-90">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-90">&#182;</a>               </div>               <h3>#addType (see Data Store #addType)</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.addType = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">addType</span>
                </pre></div>             </td>           </tr>                               <tr id="section-91">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-91">&#182;</a>               </div>               <h3>#getType (see Data Store #getType)</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.getType = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">getType</span>
                </pre></div>             </td>           </tr>                               <tr id="section-92">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-92">&#182;</a>               </div>               <h3>#addProperty (see Data Store #addProperty)</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.addProperty = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">addProperty</span>
                </pre></div>             </td>           </tr>                               <tr id="section-93">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-93">&#182;</a>               </div>               <h3>#getProperty (see Data Store #getProperty)</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.getProperty = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">getProperty</span>
                </pre></div>             </td>           </tr>                               <tr id="section-94">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-94">&#182;</a>               </div>               <h3>#getObjectsUnion (see Data Store #getObjectsUnion)</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.getObjectsUnion = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">getObjectsUnion</span>
                </pre></div>             </td>           </tr>                               <tr id="section-95">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-95">&#182;</a>               </div>               <h3>#getSubjectsUnion (see Data Store #getSubjectsUnion)</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.getSubjectsUnion = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">getSubjectsUnion</span>
        
                <span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onModelChange</span><span class="p">.</span><span class="nx">addListener</span> <span class="nx">that</span><span class="p">.</span><span class="nx">eventModelChange</span>

                <span class="nx">that</span><span class="p">.</span><span class="nx">eventModelChange</span> <span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">items</span><span class="p">()</span>

                <span class="nx">that</span>
        </pre></div>             </td>           </tr>                               <tr id="section-96">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-96">&#182;</a>               </div>               <h1>Data Subset View</h1>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Data</span><span class="p">.</span><span class="nx">namespace</span> <span class="s">&#39;SubSet&#39;</span><span class="p">,</span> <span class="nf">(SubSet) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-97">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-97">&#182;</a>               </div>               <h2>SubSet.initInstance</h2>

<p>Given a set of expressions and a key value, the resulting set of items will consist of all items which
satisfy the expressions by producing the key value.</p>

<p>Note that this is a fragile data view. Expressions that hop through other items may result in inconsistent
lists of items.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nv">SubSet.initInstance = </span><span class="nf">(options) -&gt;</span>
                <span class="nv">that = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">initView</span> <span class="s">&quot;MITHGrid.Data.SubSet&quot;</span><span class="p">,</span> <span class="nx">options</span>
                <span class="nv">options = </span><span class="nx">that</span><span class="p">.</span><span class="nx">options</span>
                <span class="nv">key = </span><span class="nx">options</span><span class="p">.</span><span class="nx">key</span>
        
                <span class="nv">set = </span><span class="nx">Data</span><span class="p">.</span><span class="nx">initSet</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-98">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-98">&#182;</a>               </div>               <h3>#items (see Set#items)</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.items = </span><span class="nx">set</span><span class="p">.</span><span class="nx">items</span></pre></div>             </td>           </tr>                               <tr id="section-99">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-99">&#182;</a>               </div>               <h3>#contains (see Set#contains)</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.contains = </span><span class="nx">set</span><span class="p">.</span><span class="nx">contains</span></pre></div>             </td>           </tr>                               <tr id="section-100">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-100">&#182;</a>               </div>               <h3>#visit (see Set#visit)</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.visit = </span><span class="nx">set</span><span class="p">.</span><span class="nx">visit</span></pre></div>             </td>           </tr>                               <tr id="section-101">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-101">&#182;</a>               </div>               <h3>#size (see Set#size)</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.size = </span><span class="nx">set</span><span class="p">.</span><span class="nx">size</span>
        </pre></div>             </td>           </tr>                               <tr id="section-102">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-102">&#182;</a>               </div>               <h3>#setKey</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.setKey = </span><span class="nf">(k) -&gt;</span>
                    <span class="nv">key = </span><span class="nx">k</span>
                    <span class="nx">that</span><span class="p">.</span><span class="nx">eventModelChange</span> <span class="nx">options</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">items</span><span class="p">()</span>

                <span class="nv">expressions = </span><span class="nx">options</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">prepare</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">expressions</span><span class="p">)</span>
                </pre></div>             </td>           </tr>                               <tr id="section-103">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-103">&#182;</a>               </div>               <h3>#eventModelChange</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.eventModelChange = </span><span class="nf">(model, items) -&gt;</span>
                    <span class="k">if</span> <span class="nx">key</span><span class="o">?</span>
                        <span class="nv">newItems = </span><span class="nx">Data</span><span class="p">.</span><span class="nx">initSet</span><span class="p">(</span><span class="nx">expressions</span><span class="p">.</span><span class="nx">evaluate</span><span class="p">([</span><span class="nx">key</span><span class="p">]))</span>
                    <span class="k">else</span>
                        <span class="nv">newItems = </span><span class="nx">Data</span><span class="p">.</span><span class="nx">initSet</span><span class="p">()</span>
                
                    <span class="nv">changed = </span><span class="p">[]</span>
            
                    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="nx">items</span>
                        <span class="k">if</span> <span class="nx">set</span><span class="p">.</span><span class="nx">contains</span> <span class="nx">i</span>
                            <span class="nx">changed</span><span class="p">.</span><span class="nx">push</span> <span class="nx">i</span>
                            <span class="k">if</span> <span class="o">!</span><span class="nx">newItems</span><span class="p">.</span><span class="nx">contains</span> <span class="nx">i</span>
                                <span class="nx">set</span><span class="p">.</span><span class="nx">remove</span> <span class="nx">i</span>
                        <span class="k">else</span> <span class="k">if</span> <span class="nx">newItems</span><span class="p">.</span><span class="nx">contains</span> <span class="nx">i</span>
                            <span class="nx">set</span><span class="p">.</span><span class="nx">add</span> <span class="nx">i</span>
                            <span class="nx">changed</span><span class="p">.</span><span class="nx">push</span> <span class="nx">i</span>
                    <span class="k">if</span> <span class="nx">changed</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
                        <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onModelChange</span><span class="p">.</span><span class="nx">fire</span> <span class="nx">that</span><span class="p">,</span> <span class="nx">changed</span>
                    
                <span class="nv">that.dataStore = </span><span class="nx">options</span><span class="p">.</span><span class="nx">dataStore</span></pre></div>             </td>           </tr>                               <tr id="section-104">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-104">&#182;</a>               </div>               <p>these mappings allow a data View to stand in for a data Store</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.getItems = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">getItems</span>
                <span class="nv">that.getItem = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">getItem</span>
                <span class="nv">that.removeItems = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">removeItems</span>
                <span class="nv">that.fetchData = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">fetchData</span>
                <span class="nv">that.updateItems = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">updateItems</span>
                <span class="nv">that.loadItems = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">loadItems</span>
                <span class="nv">that.prepare = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">prepare</span>
                <span class="nv">that.addType = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">addType</span>
                <span class="nv">that.getType = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">getType</span>
                <span class="nv">that.addProperty = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">addProperty</span>
                <span class="nv">that.getProperty = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">getProperty</span>
                <span class="nv">that.getObjectsUnion = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">getObjectsUnion</span>
                <span class="nv">that.getSubjectsUnion = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">getSubjectsUnion</span>
        
                <span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onModelChange</span><span class="p">.</span><span class="nx">addListener</span> <span class="nx">that</span><span class="p">.</span><span class="nx">eventModelChange</span>

                <span class="nx">that</span><span class="p">.</span><span class="nx">eventModelChange</span> <span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">items</span><span class="p">()</span>
        
                <span class="nv">that.registerPresentation = </span><span class="nf">(ob) -&gt;</span>
                    <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onModelChange</span><span class="p">.</span><span class="nx">addListener</span> <span class="nf">(m, i) -&gt;</span> <span class="nx">ob</span><span class="p">.</span><span class="nx">eventModelChange</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">i</span>
                    <span class="nx">setTimeout</span> <span class="nf">() -&gt;</span> 
                        <span class="nx">ob</span><span class="p">.</span><span class="nx">eventModelChange</span> <span class="nx">that</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">items</span><span class="p">()</span>
                    <span class="p">,</span> <span class="mi">0</span>
        
                <span class="nx">that</span>
        </pre></div>             </td>           </tr>                               <tr id="section-105">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-105">&#182;</a>               </div>               <h1>Data List Pager</h1>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Data</span><span class="p">.</span><span class="nx">namespace</span> <span class="s">&#39;ListPager&#39;</span><span class="p">,</span> <span class="nf">(ListPager) -&gt;</span>
            <span class="nv">ListPager.initInstance = </span><span class="nf">(options) -&gt;</span>
                <span class="nv">that = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">initInstance</span> <span class="s">&quot;MITHGrid.Data.ListPager&quot;</span><span class="p">,</span> <span class="nx">options</span>
                <span class="nv">options = </span><span class="nx">that</span><span class="p">.</span><span class="nx">options</span>

                <span class="nv">itemList = </span><span class="p">[]</span>
                <span class="nv">itemListStart = </span><span class="mi">0</span>
                <span class="nv">itemListStop = </span><span class="o">-</span><span class="mi">1</span>
                <span class="nv">leftKey = </span><span class="kc">undefined</span>
                <span class="nv">rightKey = </span><span class="kc">undefined</span>
            
                <span class="nv">findItemPosition = </span><span class="nf">(itemId) -&gt;</span> <span class="nx">itemList</span><span class="p">.</span><span class="nx">indexOf</span> <span class="nx">itemId</span>
            
                <span class="nv">set = </span><span class="nx">Data</span><span class="p">.</span><span class="nx">initSet</span><span class="p">()</span>

                <span class="nv">that.items = </span><span class="nx">set</span><span class="p">.</span><span class="nx">items</span>
                <span class="nv">that.size = </span><span class="nx">set</span><span class="p">.</span><span class="nx">size</span>
                <span class="nv">that.contains = </span><span class="nx">set</span><span class="p">.</span><span class="nx">contains</span>
                <span class="nv">that.visit = </span><span class="nx">set</span><span class="p">.</span><span class="nx">visit</span>

                <span class="nv">that.dataStore = </span><span class="nx">options</span><span class="p">.</span><span class="nx">dataStore</span></pre></div>             </td>           </tr>                               <tr id="section-106">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-106">&#182;</a>               </div>               <p>these mappings allow a data pager to stand in for a data Store</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.getItems = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">getItems</span>
                <span class="nv">that.getItem = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">getItem</span>
                <span class="nv">that.removeItems = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">removeItems</span>
                <span class="nv">that.fetchData = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">fetchData</span>
                <span class="nv">that.updateItems = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">updateItems</span>
                <span class="nv">that.loadItems = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">loadItems</span>
                <span class="nv">that.prepare = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">prepare</span>
                <span class="nv">that.addType = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">addType</span>
                <span class="nv">that.getType = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">getType</span>
                <span class="nv">that.addProperty = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">addProperty</span>
                <span class="nv">that.getProperty = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">getProperty</span>
                <span class="nv">that.getObjectsUnion = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">getObjectsUnion</span>
                <span class="nv">that.getSubjectsUnion = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">getSubjectsUnion</span>
        
                <span class="nv">that.setList = </span><span class="nf">(idList) -&gt;</span>
                    <span class="nv">itemList = </span><span class="nx">idList</span>
                    <span class="nv">changedItems = </span><span class="p">[]</span>
                    <span class="k">for</span> <span class="nx">id</span> <span class="k">in</span> <span class="nx">itemList</span>
                        <span class="k">if</span> <span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="o">and</span> <span class="o">!</span><span class="nx">set</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nx">itemListStart</span> <span class="o">&lt;=</span> <span class="nx">itemList</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nx">itemListStop</span>
                                <span class="nx">changedItems</span><span class="p">.</span><span class="nx">push</span> <span class="nx">id</span>
                                <span class="nx">set</span><span class="p">.</span><span class="nx">add</span> <span class="nx">id</span>
                        <span class="k">else</span> <span class="k">if</span> <span class="nx">set</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="o">and</span> <span class="o">!</span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
                            <span class="nx">changedItems</span><span class="p">.</span><span class="nx">push</span> <span class="nx">id</span>
                            <span class="nx">set</span><span class="p">.</span><span class="nx">remove</span> <span class="nx">id</span>
                    <span class="k">for</span> <span class="nx">id</span> <span class="k">in</span> <span class="nx">set</span><span class="p">.</span><span class="nx">items</span><span class="p">()</span>
                        <span class="k">if</span> <span class="o">!</span><span class="nx">id</span> <span class="k">in</span> <span class="nx">itemList</span> <span class="o">or</span> <span class="o">!</span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">contains</span> <span class="nx">id</span>
                            <span class="nx">changedItems</span><span class="p">.</span><span class="nx">push</span> <span class="nx">id</span>
                            <span class="nx">set</span><span class="p">.</span><span class="nx">remove</span> <span class="nx">id</span>
                    <span class="k">if</span> <span class="nx">changedItems</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
                        <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onModelChange</span><span class="p">.</span><span class="nx">fire</span> <span class="nx">that</span><span class="p">,</span> <span class="nx">changedItems</span>
    
                <span class="nv">that.eventModelChange = </span><span class="nf">(model, items) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-107">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-107">&#182;</a>               </div>               <p>we're modifying the items we're tracking, possibly expanding or decreasing the set</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nv">changedItems = </span><span class="p">[]</span> <span class="c1"># to propogate on to the next level</span>
                    <span class="k">for</span> <span class="nx">itemId</span> <span class="k">in</span> <span class="nx">items</span>
                        <span class="k">if</span> <span class="nx">model</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">itemId</span><span class="p">)</span>
                            <span class="nv">key = </span><span class="nx">findItemPosition</span> <span class="nx">itemId</span>
                            <span class="k">if</span> <span class="nx">set</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">itemId</span><span class="p">)</span>
                                <span class="nx">changedItems</span><span class="p">.</span><span class="nx">push</span> <span class="nx">itemId</span>
                                <span class="k">if</span> <span class="o">!</span><span class="p">(</span><span class="nx">itemListStart</span> <span class="o">&lt;=</span> <span class="nx">key</span> <span class="o">&lt;</span> <span class="nx">itemListStop</span><span class="p">)</span>
                                    <span class="nx">set</span><span class="p">.</span><span class="nx">remove</span> <span class="nx">itemId</span>
                            <span class="k">else</span>
                                <span class="k">if</span> <span class="nx">itemListStart</span> <span class="o">&lt;=</span> <span class="nx">key</span> <span class="o">&lt;</span> <span class="nx">itemListStop</span>
                                    <span class="nx">set</span><span class="p">.</span><span class="nx">add</span> <span class="nx">itemId</span>
                                    <span class="nx">changedItems</span><span class="p">.</span><span class="nx">push</span> <span class="nx">itemId</span>
                        <span class="k">else</span>
                            <span class="nx">set</span><span class="p">.</span><span class="nx">remove</span> <span class="nx">itemId</span>
                            <span class="nx">changedItems</span><span class="p">.</span><span class="nx">push</span> <span class="nx">itemId</span>

                    <span class="k">if</span> <span class="nx">changedItems</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
                        <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onModelChange</span><span class="p">.</span><span class="nx">fire</span> <span class="nx">that</span><span class="p">,</span> <span class="nx">changedItems</span>

                <span class="nv">that.setKeyRange = </span><span class="nf">(l, r) -&gt;</span>
                    <span class="k">if</span> <span class="nx">l</span> <span class="o">&lt;</span> <span class="nx">r</span>
                        <span class="nv">itemListStart = </span><span class="nx">l</span>
                        <span class="nv">itemListStop = </span><span class="nx">r</span>
                    <span class="k">else</span>
                        <span class="nv">itemListStart = </span><span class="nx">r</span>
                        <span class="nv">itemListStop = </span><span class="nx">l</span>
            
                    <span class="nv">oldSet = </span><span class="nx">set</span>
                    <span class="nv">changedItems = </span><span class="nx">Data</span><span class="p">.</span><span class="nx">initSet</span><span class="p">()</span>
                    <span class="nv">set = </span><span class="nx">Data</span><span class="p">.</span><span class="nx">initSet</span><span class="p">()</span>
                    <span class="nv">that.items = </span><span class="nx">set</span><span class="p">.</span><span class="nx">items</span>
                    <span class="nv">that.size = </span><span class="nx">set</span><span class="p">.</span><span class="nx">size</span>
                    <span class="nv">that.contains = </span><span class="nx">set</span><span class="p">.</span><span class="nx">contains</span>
                    <span class="nv">that.visit = </span><span class="nx">set</span><span class="p">.</span><span class="nx">visit</span>
            
                    <span class="k">if</span> <span class="nx">itemListStart</span> <span class="o">&lt;</span> <span class="nx">itemListStop</span>
                        <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="nx">itemListStart</span><span class="p">..</span><span class="nx">itemListStop</span><span class="p">]</span>
                            <span class="nv">itemId = </span><span class="nx">itemList</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
                            <span class="k">if</span> <span class="o">!</span><span class="nx">oldSet</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">itemId</span><span class="p">)</span>
                                <span class="nx">changedItems</span><span class="p">.</span><span class="nx">add</span> <span class="nx">itemId</span>
                            <span class="nx">set</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">itemId</span><span class="p">)</span>
                    <span class="nx">oldSet</span><span class="p">.</span><span class="nx">visit</span> <span class="nf">(x) -&gt;</span>
                        <span class="k">if</span> <span class="o">!</span><span class="nx">set</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
                            <span class="nx">changedItems</span><span class="p">.</span><span class="nx">add</span> <span class="nx">x</span>
                    <span class="k">if</span> <span class="nx">changedItems</span><span class="p">.</span><span class="nx">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>
                        <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onModelChange</span><span class="p">.</span><span class="nx">fire</span> <span class="nx">that</span><span class="p">,</span> <span class="nx">changedItems</span><span class="p">.</span><span class="nx">items</span><span class="p">()</span>

        
                <span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">registerPresentation</span> <span class="nx">that</span>

                <span class="nv">that.registerPresentation = </span><span class="nf">(ob) -&gt;</span>
                    <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onModelChange</span><span class="p">.</span><span class="nx">addListener</span> <span class="nf">(m, i) -&gt;</span> <span class="nx">ob</span><span class="p">.</span><span class="nx">eventModelChange</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">i</span>
                    <span class="nx">ob</span><span class="p">.</span><span class="nx">eventModelChange</span> <span class="nx">that</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">items</span><span class="p">()</span>

                <span class="nx">that</span>
    </pre></div>             </td>           </tr>                               <tr id="section-108">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-108">&#182;</a>               </div>               <h1>Data Pager</h1>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Data</span><span class="p">.</span><span class="nx">namespace</span> <span class="s">&#39;Pager&#39;</span><span class="p">,</span> <span class="nf">(Pager) -&gt;</span>
            <span class="nv">Pager.initInstance = </span><span class="nf">(options) -&gt;</span>
                <span class="nv">that = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">initInstance</span> <span class="s">&quot;MITHGrid.Data.Pager&quot;</span><span class="p">,</span> <span class="nx">options</span>
                <span class="nv">options = </span><span class="nx">that</span><span class="p">.</span><span class="nx">options</span>

                <span class="nv">itemList = </span><span class="p">[]</span>
                <span class="nv">itemListStart = </span><span class="o">-</span><span class="mi">1</span>
                <span class="nv">itemListStop = </span><span class="o">-</span><span class="mi">1</span>
                <span class="nv">leftKey = </span><span class="kc">undefined</span>
                <span class="nv">rightKey = </span><span class="kc">undefined</span>
        </pre></div>             </td>           </tr>                               <tr id="section-109">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-109">&#182;</a>               </div>               <p>returns the first index that has a key greater than or equal to the given key</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">findLeftPoint = </span><span class="nf">(key) -&gt;</span>
                    <span class="k">if</span> <span class="o">!</span><span class="nx">key</span><span class="o">?</span>
                        <span class="k">return</span> <span class="mi">0</span>
                    <span class="nv">left = </span><span class="mi">0</span>
                    <span class="k">if</span> <span class="nx">key</span><span class="o">?</span>
                        <span class="nv">right = </span><span class="nx">itemList</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span>
                        <span class="k">while</span> <span class="nx">left</span> <span class="o">&lt;</span> <span class="nx">right</span>
                            <span class="nv">mid = </span><span class="o">~~</span><span class="p">((</span><span class="nx">left</span> <span class="o">+</span> <span class="nx">right</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                
                            <span class="k">if</span> <span class="nx">itemList</span><span class="p">[</span><span class="nx">mid</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nx">key</span>
                                <span class="nv">left = </span><span class="nx">mid</span> <span class="o">+</span> <span class="mi">1</span>
                            <span class="k">else</span> <span class="k">if</span> <span class="nx">itemList</span><span class="p">[</span><span class="nx">mid</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="nx">key</span>
                                <span class="nv">right = </span><span class="nx">mid</span>
                            <span class="k">else</span>
                                <span class="nv">right = </span><span class="nx">mid</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="nx">left</span>
            </pre></div>             </td>           </tr>                               <tr id="section-110">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-110">&#182;</a>               </div>               <p>returns the last index that has a key less than or equal to the given key</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">findRightPoint = </span><span class="nf">(key) -&gt;</span>
                    <span class="k">if</span> <span class="o">!</span><span class="nx">key</span><span class="o">?</span>
                        <span class="k">return</span> <span class="nx">itemList</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="nv">left = </span><span class="mi">0</span>
                    <span class="nv">right = </span><span class="nx">itemList</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="k">if</span> <span class="nx">key</span><span class="o">?</span>
                        <span class="k">while</span> <span class="nx">left</span> <span class="o">&lt;</span> <span class="nx">right</span>
                            <span class="nv">mid = </span><span class="o">~~</span><span class="p">((</span><span class="nx">left</span> <span class="o">+</span> <span class="nx">right</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nx">itemList</span><span class="p">[</span><span class="nx">mid</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="nx">key</span>
                                <span class="nv">left = </span><span class="nx">mid</span> <span class="o">+</span> <span class="mi">1</span>
                            <span class="k">else</span>
                                <span class="nv">right = </span><span class="nx">mid</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="nx">right</span>
            
                <span class="nv">findItemPosition = </span><span class="nf">(itemId) -&gt;</span>
                    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="nx">itemList</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
                        <span class="k">return</span> <span class="nx">i</span> <span class="k">if</span> <span class="nx">itemList</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="nx">itemId</span>
                    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
            

                <span class="nv">set = </span><span class="nx">Data</span><span class="p">.</span><span class="nx">initSet</span><span class="p">()</span>
        
                <span class="nv">that.items = </span><span class="nx">set</span><span class="p">.</span><span class="nx">items</span>
                <span class="nv">that.size = </span><span class="nx">set</span><span class="p">.</span><span class="nx">size</span>
                <span class="nv">that.contains = </span><span class="nx">set</span><span class="p">.</span><span class="nx">contains</span>
                <span class="nv">that.visit = </span><span class="nx">set</span><span class="p">.</span><span class="nx">visit</span>
        
                <span class="nv">that.dataStore = </span><span class="nx">options</span><span class="p">.</span><span class="nx">dataStore</span></pre></div>             </td>           </tr>                               <tr id="section-111">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-111">&#182;</a>               </div>               <p>these mappings allow a data pager to stand in for a data Store</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.getItems = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">getItems</span>
                <span class="nv">that.getItem = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">getItem</span>
                <span class="nv">that.removeItems = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">removeItems</span>
                <span class="nv">that.fetchData = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">fetchData</span>
                <span class="nv">that.updateItems = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">updateItems</span>
                <span class="nv">that.loadItems = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">loadItems</span>
                <span class="nv">that.prepare = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">prepare</span>
                <span class="nv">that.addType = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">addType</span>
                <span class="nv">that.getType = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">getType</span>
                <span class="nv">that.addProperty = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">addProperty</span>
                <span class="nv">that.getProperty = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">getProperty</span>
                <span class="nv">that.getObjectsUnion = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">getObjectsUnion</span>
                <span class="nv">that.getSubjectsUnion = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">getSubjectsUnion</span>
        
                <span class="nv">expressions = </span><span class="nx">that</span><span class="p">.</span><span class="nx">prepare</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">expressions</span><span class="p">)</span>
            
                <span class="nv">that.eventModelChange = </span><span class="nf">(model, items) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-112">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-112">&#182;</a>               </div>               <p>we're modifying the items we're tracking, possibly expanding or decreasing the set</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nv">changedItems = </span><span class="p">[]</span> <span class="c1"># to propogate on to the next level</span>
                    <span class="k">for</span> <span class="nx">itemId</span> <span class="k">in</span> <span class="nx">items</span>
                        <span class="k">if</span> <span class="nx">model</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">itemId</span><span class="p">)</span>
                            <span class="nv">keys = </span><span class="nx">expressions</span><span class="p">.</span><span class="nx">evaluate</span><span class="p">(</span><span class="nx">itemId</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nx">keys</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
                                <span class="k">if</span> <span class="nx">expressions</span><span class="p">.</span><span class="nx">valueType</span><span class="p">()</span> <span class="o">==</span> <span class="s">&quot;numeric&quot;</span>
                                    <span class="nv">key = </span><span class="nb">parseFloat</span><span class="p">(</span><span class="nx">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                                <span class="k">else</span>
                                    <span class="nv">key = </span><span class="nx">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="k">if</span> <span class="nx">set</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">itemId</span><span class="p">)</span>
                                    <span class="nv">i = </span><span class="nx">findItemPosition</span> <span class="nx">itemId</span>
                                    <span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span>
                                        <span class="nx">itemList</span><span class="p">.</span><span class="nx">push</span> <span class="p">[</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">itemId</span> <span class="p">]</span>
                                    <span class="k">else</span>
                                        <span class="nx">itemList</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nx">key</span>
                                    <span class="nx">changedItems</span><span class="p">.</span><span class="nx">push</span> <span class="nx">itemId</span>
                                    <span class="k">if</span> <span class="nx">leftKey</span><span class="o">?</span> <span class="o">and</span> <span class="nx">key</span> <span class="o">&lt;</span> <span class="nx">leftKey</span> <span class="o">or</span> <span class="nx">rightKey</span><span class="o">?</span> <span class="o">and</span> <span class="nx">key</span> <span class="o">&gt;</span> <span class="nx">rightKey</span>
                                        <span class="nx">set</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">itemId</span><span class="p">)</span>
                                <span class="k">else</span>
                                    <span class="nx">itemList</span><span class="p">.</span><span class="nx">push</span> <span class="p">[</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">itemId</span> <span class="p">]</span>
                                    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">leftKey</span><span class="o">?</span> <span class="o">or</span> <span class="nx">key</span> <span class="o">&gt;=</span> <span class="nx">leftKey</span><span class="p">)</span> <span class="o">and</span> <span class="p">(</span><span class="o">!</span><span class="nx">rightKey</span><span class="o">?</span> <span class="o">or</span> <span class="nx">key</span> <span class="o">&lt;=</span> <span class="nx">rightKey</span><span class="p">)</span>
                                        <span class="nx">set</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">itemId</span><span class="p">)</span>
                                        <span class="nx">changedItems</span><span class="p">.</span><span class="nx">push</span> <span class="nx">itemId</span>                            
                            <span class="k">else</span>
                                <span class="k">if</span> <span class="nx">set</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">itemId</span><span class="p">)</span>
                                    <span class="nv">i = </span><span class="nx">findItemPosition</span> <span class="nx">itemId</span>
                                    <span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="mi">0</span>
                                        <span class="nv">itemList = </span><span class="nx">itemList</span><span class="p">[</span><span class="mi">1</span><span class="p">...</span><span class="nx">itemList</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
                                    <span class="k">else</span> <span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="nx">itemList</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span>
                                        <span class="nv">itemList = </span><span class="nx">itemList</span><span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">itemList</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                                    <span class="k">else</span> <span class="k">if</span> <span class="nx">i</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
                                        <span class="nv">itemList = </span><span class="nx">itemList</span><span class="p">[</span><span class="mi">0</span><span class="p">...</span><span class="nx">i</span><span class="p">].</span><span class="nx">concat</span> <span class="nx">itemList</span><span class="p">[</span><span class="nx">i</span><span class="o">+</span><span class="mi">1</span><span class="p">...</span><span class="nx">itemList</span><span class="p">.</span><span class="nx">length</span><span class="p">]</span>
                                    <span class="nx">set</span><span class="p">.</span><span class="nx">remove</span><span class="p">(</span><span class="nx">itemId</span><span class="p">)</span>
                                    <span class="nx">changedItems</span><span class="p">.</span><span class="nx">push</span> <span class="nx">itemId</span>
                        <span class="k">else</span>
                            <span class="nx">set</span><span class="p">.</span><span class="nx">remove</span> <span class="nx">itemId</span>
                            <span class="nx">changedItems</span><span class="p">.</span><span class="nx">push</span> <span class="nx">itemId</span></pre></div>             </td>           </tr>                               <tr id="section-113">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-113">&#182;</a>               </div>               <p>now sort itemList
and redo left and right positions
and double check set and changedItems list?</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nx">itemList</span><span class="p">.</span><span class="nx">sort</span> <span class="nf">(a,b) -&gt;</span>
                        <span class="k">return</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">return</span>  <span class="mi">1</span> <span class="k">if</span> <span class="nx">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="nx">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="k">return</span>  <span class="mi">0</span>
                    <span class="nv">itemListStart = </span><span class="nx">findLeftPoint</span> <span class="nx">leftKey</span>
                    <span class="nv">itemListStop  = </span><span class="nx">findRightPoint</span> <span class="nx">rightKey</span>

                    <span class="k">if</span> <span class="nx">changedItems</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
                        <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onModelChange</span><span class="p">.</span><span class="nx">fire</span> <span class="nx">that</span><span class="p">,</span> <span class="nx">changedItems</span>

                <span class="nv">that.setKeyRange = </span><span class="nf">(l, r) -&gt;</span>
                    <span class="k">if</span> <span class="nx">l</span><span class="o">?</span> <span class="o">and</span> <span class="nx">r</span><span class="o">?</span>
                        <span class="k">if</span> <span class="nx">l</span> <span class="o">&lt;</span> <span class="nx">r</span>
                            <span class="nv">leftKey = </span><span class="nx">l</span>
                            <span class="nv">rightKey = </span><span class="nx">r</span>
                        <span class="k">else</span>
                            <span class="nv">leftKey = </span><span class="nx">r</span>
                            <span class="nv">rightKey = </span><span class="nx">l</span>
                    <span class="k">else</span>
                        <span class="nv">leftKey = </span><span class="nx">l</span>
                        <span class="nv">rightKey = </span><span class="nx">r</span>
                
                    <span class="nv">itemListStart = </span><span class="nx">findLeftPoint</span> <span class="nx">leftKey</span>
                    <span class="nv">itemListStop  = </span><span class="nx">findRightPoint</span> <span class="nx">rightKey</span>
                    <span class="nv">changedItems = </span><span class="nx">Data</span><span class="p">.</span><span class="nx">initSet</span><span class="p">()</span>
                    <span class="nv">oldSet = </span><span class="nx">set</span>
            
                    <span class="nv">set = </span><span class="nx">Data</span><span class="p">.</span><span class="nx">initSet</span><span class="p">()</span>
                    <span class="nv">that.items = </span><span class="nx">set</span><span class="p">.</span><span class="nx">items</span>
                    <span class="nv">that.size = </span><span class="nx">set</span><span class="p">.</span><span class="nx">size</span>
                    <span class="nv">that.contains = </span><span class="nx">set</span><span class="p">.</span><span class="nx">contains</span>
                    <span class="nv">that.visit = </span><span class="nx">set</span><span class="p">.</span><span class="nx">visit</span>
            
                    <span class="k">if</span> <span class="nx">itemListStart</span> <span class="o">&lt;</span> <span class="nx">itemListStop</span>
                        <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="nx">itemListStart</span><span class="p">..</span><span class="nx">itemListStop</span><span class="p">]</span>
                            <span class="nv">itemId = </span><span class="nx">itemList</span><span class="p">[</span><span class="nx">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                            <span class="k">if</span> <span class="o">!</span><span class="nx">oldSet</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">itemId</span><span class="p">)</span>
                                <span class="nx">changedItems</span><span class="p">.</span><span class="nx">add</span> <span class="nx">itemId</span>
                            <span class="nx">set</span><span class="p">.</span><span class="nx">add</span><span class="p">(</span><span class="nx">itemId</span><span class="p">)</span>
                    <span class="nx">oldSet</span><span class="p">.</span><span class="nx">visit</span> <span class="nf">(x) -&gt;</span>
                        <span class="k">if</span> <span class="o">!</span><span class="nx">set</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">x</span><span class="p">)</span>
                            <span class="nx">changedItems</span><span class="p">.</span><span class="nx">add</span> <span class="nx">x</span>
                    <span class="k">if</span> <span class="nx">changedItems</span><span class="p">.</span><span class="nx">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>
                        <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onModelChange</span><span class="p">.</span><span class="nx">fire</span> <span class="nx">that</span><span class="p">,</span> <span class="nx">changedItems</span><span class="p">.</span><span class="nx">items</span><span class="p">()</span>

        
                <span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">registerPresentation</span> <span class="nx">that</span>

                <span class="nv">that.registerPresentation = </span><span class="nf">(ob) -&gt;</span>
                    <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onModelChange</span><span class="p">.</span><span class="nx">addListener</span> <span class="nf">(m, i) -&gt;</span> <span class="nx">ob</span><span class="p">.</span><span class="nx">eventModelChange</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">i</span>
                    <span class="nx">ob</span><span class="p">.</span><span class="nx">eventModelChange</span> <span class="nx">that</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">items</span><span class="p">()</span>

                <span class="nx">that</span>
    </pre></div>             </td>           </tr>                               <tr id="section-114">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-114">&#182;</a>               </div>               <h1>Data Range Pager</h1>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nx">Data</span><span class="p">.</span><span class="nx">namespace</span> <span class="s">&#39;RangePager&#39;</span><span class="p">,</span> <span class="nf">(RangePager) -&gt;</span>
            <span class="nv">RangePager.initInstance = </span><span class="nf">(options) -&gt;</span>
                <span class="nv">that = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">initInstance</span> <span class="s">&quot;MITHGrid.Data.RangePager&quot;</span><span class="p">,</span> <span class="nx">options</span>
                <span class="nv">options = </span><span class="nx">that</span><span class="p">.</span><span class="nx">options</span>

                <span class="nv">leftPager = </span><span class="nx">Data</span><span class="p">.</span><span class="nx">Pager</span><span class="p">.</span><span class="nx">initInstance</span>
                    <span class="nv">dataStore: </span><span class="nx">options</span><span class="p">.</span><span class="nx">dataStore</span>
                    <span class="nv">expressions: </span><span class="nx">options</span><span class="p">.</span><span class="nx">leftExpressions</span>
                <span class="nv">rightPager = </span><span class="nx">Data</span><span class="p">.</span><span class="nx">Pager</span><span class="p">.</span><span class="nx">initInstance</span>
                    <span class="nv">dataStore: </span><span class="nx">options</span><span class="p">.</span><span class="nx">dataStore</span>
                    <span class="nv">expressions: </span><span class="nx">options</span><span class="p">.</span><span class="nx">rightExpressions</span>
        
                <span class="nv">set = </span><span class="nx">Data</span><span class="p">.</span><span class="nx">initSet</span><span class="p">()</span>
                <span class="nv">that.items = </span><span class="nx">set</span><span class="p">.</span><span class="nx">items</span>
                <span class="nv">that.size = </span><span class="nx">set</span><span class="p">.</span><span class="nx">size</span>
                <span class="nv">that.contains = </span><span class="nx">set</span><span class="p">.</span><span class="nx">contains</span>
                <span class="nv">that.visit = </span><span class="nx">set</span><span class="p">.</span><span class="nx">visit</span>
        
                <span class="nv">that.dataStore = </span><span class="nx">options</span><span class="p">.</span><span class="nx">dataStore</span></pre></div>             </td>           </tr>                               <tr id="section-115">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-115">&#182;</a>               </div>               <p>these mappings allow a data pager to stand in for a data Store</p>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="nv">that.getItems = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">getItems</span>
                <span class="nv">that.getItem = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">getItem</span>
                <span class="nv">that.removeItems = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">removeItems</span>
                <span class="nv">that.fetchData = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">fetchData</span>
                <span class="nv">that.updateItems = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">updateItems</span>
                <span class="nv">that.loadItems = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">loadItems</span>
                <span class="nv">that.prepare = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">prepare</span>
                <span class="nv">that.addType = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">addType</span>
                <span class="nv">that.getType = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">getType</span>
                <span class="nv">that.addProperty = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">addProperty</span>
                <span class="nv">that.getProperty = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">getProperty</span>
                <span class="nv">that.getObjectsUnion = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">getObjectsUnion</span>
                <span class="nv">that.getSubjectsUnion = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">.</span><span class="nx">getSubjectsUnion</span>
            
                <span class="nv">that.eventModelChange = </span><span class="nf">(model, itemIds) -&gt;</span>
                    <span class="nv">changedIds = </span><span class="p">[]</span>
                    <span class="k">for</span> <span class="nx">id</span> <span class="k">in</span> <span class="nx">itemIds</span>
                        <span class="k">if</span> <span class="nx">leftPager</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span> <span class="o">and</span> <span class="nx">rightPager</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
                            <span class="nx">changedIds</span><span class="p">.</span><span class="nx">push</span> <span class="nx">id</span>
                            <span class="nx">set</span><span class="p">.</span><span class="nx">add</span> <span class="nx">id</span>
                        <span class="k">else</span>
                            <span class="nx">changedIds</span><span class="p">.</span><span class="nx">push</span> <span class="nx">id</span> <span class="k">if</span> <span class="nx">set</span><span class="p">.</span><span class="nx">contains</span> <span class="nx">id</span>
                            <span class="nx">set</span><span class="p">.</span><span class="nx">remove</span> <span class="nx">id</span>
                    <span class="k">if</span> <span class="nx">changedIds</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
                        <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onModelChange</span><span class="p">.</span><span class="nx">fire</span> <span class="nx">that</span><span class="p">,</span> <span class="nx">changedIds</span> 

                <span class="nv">that.setKeyRange = </span><span class="nf">(l, r) -&gt;</span>
                    <span class="k">if</span> <span class="nx">l</span> <span class="o">&gt;</span> <span class="nx">r</span>
                        <span class="p">[</span><span class="nx">l</span><span class="p">,</span> <span class="nx">r</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">r</span><span class="p">,</span> <span class="nx">l</span><span class="p">]</span>
            
                    <span class="nx">leftPager</span><span class="p">.</span><span class="nx">setKeyRange</span>  <span class="kc">undefined</span><span class="p">,</span> <span class="nx">r</span>
                    <span class="nx">rightPager</span><span class="p">.</span><span class="nx">setKeyRange</span> <span class="nx">l</span><span class="p">,</span> <span class="kc">undefined</span>

                <span class="nx">that</span><span class="p">.</span><span class="nx">setKeyRange</span> <span class="kc">undefined</span><span class="p">,</span> <span class="kc">undefined</span>
        
                <span class="nx">leftPager</span><span class="p">.</span><span class="nx">registerPresentation</span> <span class="nx">that</span>
                <span class="nx">rightPager</span><span class="p">.</span><span class="nx">registerPresentation</span> <span class="nx">that</span>
        
                <span class="nv">that.registerPresentation = </span><span class="nf">(ob) -&gt;</span>
                    <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onModelChange</span><span class="p">.</span><span class="nx">addListener</span> <span class="nf">(m, i) -&gt;</span> <span class="nx">ob</span><span class="p">.</span><span class="nx">eventModelChange</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">i</span>
                    <span class="nx">ob</span><span class="p">.</span><span class="nx">eventModelChange</span> <span class="nx">that</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">items</span><span class="p">()</span>
                
                <span class="nx">that</span></pre></div>             </td>           </tr>                               <tr id="section-116">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-116">&#182;</a>               </div>               <h1>Expression Parser</h1>

<p>Everything here is private except for a few exported objects and functions.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">namespace</span> <span class="s">&quot;Expression&quot;</span><span class="p">,</span> <span class="nf">(exports) -&gt;</span>
        <span class="nv">Expression = </span><span class="p">{}</span>
        <span class="nv">_operators =</span>
            <span class="s">&quot;+&quot;</span><span class="o">:</span>
                <span class="nv">argumentType: </span><span class="s">&quot;number&quot;</span>
                <span class="nv">valueType: </span><span class="s">&quot;number&quot;</span>
                <span class="nv">f: </span><span class="nf">(a, b) -&gt;</span> <span class="nx">a</span> <span class="o">+</span> <span class="nx">b</span>
            <span class="s">&quot;-&quot;</span><span class="o">:</span>
                <span class="nv">argumentType: </span><span class="s">&quot;number&quot;</span>
                <span class="nv">valueType: </span><span class="s">&quot;number&quot;</span>
                <span class="nv">f: </span><span class="nf">(a, b) -&gt;</span> <span class="nx">a</span> <span class="o">-</span> <span class="nx">b</span>
            <span class="s">&quot;*&quot;</span><span class="o">:</span>
                <span class="nv">argumentType: </span><span class="s">&quot;number&quot;</span>
                <span class="nv">valueType: </span><span class="s">&quot;number&quot;</span>
                <span class="nv">f: </span><span class="nf">(a, b) -&gt;</span> <span class="nx">a</span> <span class="o">*</span> <span class="nx">b</span>
            <span class="s">&quot;/&quot;</span><span class="o">:</span>
                <span class="nv">argumentType: </span><span class="s">&quot;number&quot;</span>
                <span class="nv">valueType: </span><span class="s">&quot;number&quot;</span>
                <span class="nv">f: </span><span class="nf">(a, b) -&gt;</span> <span class="nx">a</span> <span class="o">/</span> <span class="nx">b</span>
            <span class="s">&quot;=&quot;</span><span class="o">:</span>
                <span class="nv">valueType: </span><span class="s">&quot;boolean&quot;</span>
                <span class="nv">f: </span><span class="nf">(a, b) -&gt;</span> <span class="nx">a</span> <span class="o">==</span> <span class="nx">b</span>
            <span class="s">&quot;&lt;&gt;&quot;</span><span class="o">:</span>
                <span class="nv">valueType: </span><span class="s">&quot;boolean&quot;</span>
                <span class="nv">f: </span><span class="nf">(a, b) -&gt;</span> <span class="nx">a</span> <span class="o">!=</span> <span class="nx">b</span>
            <span class="s">&quot;&gt;&lt;&quot;</span><span class="o">:</span>
                <span class="nv">valueType: </span><span class="s">&quot;boolean&quot;</span>
                <span class="nv">f: </span><span class="nf">(a, b) -&gt;</span> <span class="nx">a</span> <span class="o">!=</span> <span class="nx">b</span>
            <span class="s">&quot;&lt;&quot;</span><span class="o">:</span>
                <span class="nv">valueType: </span><span class="s">&quot;boolean&quot;</span>
                <span class="nv">f: </span><span class="nf">(a, b) -&gt;</span> <span class="nx">a</span> <span class="o">&lt;</span> <span class="nx">b</span>
            <span class="s">&quot;&gt;&quot;</span><span class="o">:</span>
                <span class="nv">valueType: </span><span class="s">&quot;boolean&quot;</span>
                <span class="nv">f: </span><span class="nf">(a, b) -&gt;</span> <span class="nx">a</span> <span class="o">&gt;</span> <span class="nx">b</span>
            <span class="s">&quot;&lt;=&quot;</span><span class="o">:</span>
                <span class="nv">valueType: </span><span class="s">&quot;boolean&quot;</span>
                <span class="nv">f: </span><span class="nf">(a, b) -&gt;</span> <span class="nx">a</span> <span class="o">&lt;=</span> <span class="nx">b</span>
            <span class="s">&quot;&gt;=&quot;</span><span class="o">:</span>
                <span class="nv">valueType: </span><span class="s">&quot;boolean&quot;</span>
                <span class="nv">f: </span><span class="nf">(a, b) -&gt;</span> <span class="nx">a</span> <span class="o">&gt;=</span> <span class="nx">b</span></pre></div>             </td>           </tr>                               <tr id="section-117">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-117">&#182;</a>               </div>               <h2>MITHGrid.Expression.controls</h2>

<p>Control functions may be defined for use in expressions. See the existing control functions for examples of
how to write them.</p>

<p>All control functions take the following parameters:</p>

<ul>
<li>args</li>
<li>roots</li>
<li>rootValueTypes</li>
<li>defaultRootName</li>
<li>database</li>
</ul>

<p>All control functions should return a collection of items (using MITHGrid.Expression.initCollection collections)</p>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">Expression.controls = exports.controls =</span></pre></div>             </td>           </tr>                               <tr id="section-118">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-118">&#182;</a>               </div>               <h3>if</h3>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="s">&quot;if&quot;</span><span class="o">:</span>
                <span class="nv">f: </span><span class="nf">(args, roots, rootValueTypes, defaultRootName, database) -&gt;</span>
                    <span class="nv">conditionCollection = </span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">evaluate</span> <span class="nx">roots</span><span class="p">,</span> <span class="nx">rootValueTypes</span><span class="p">,</span> <span class="nx">defaultRootName</span><span class="p">,</span> <span class="nx">database</span>
                    <span class="nv">condition = </span><span class="kc">false</span>
                    <span class="nx">conditionCollection</span><span class="p">.</span><span class="nx">forEachValue</span> <span class="nf">(v) -&gt;</span>
                        <span class="k">if</span> <span class="nx">v</span>
                            <span class="nv">condition = </span><span class="kc">true</span>
                            <span class="k">return</span> <span class="kc">true</span>
                        <span class="k">else</span>
                            <span class="k">return</span> <span class="kc">undefined</span>
                
                    <span class="k">if</span> <span class="nx">condition</span>
                        <span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">evaluate</span> <span class="nx">roots</span><span class="p">,</span> <span class="nx">rootValueTypes</span><span class="p">,</span> <span class="nx">defaultRootName</span><span class="p">,</span> <span class="nx">database</span>
                    <span class="k">else</span>
                        <span class="nx">args</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="nx">evaluate</span> <span class="nx">roots</span><span class="p">,</span> <span class="nx">rootValueTypes</span><span class="p">,</span> <span class="nx">defaultRootName</span><span class="p">,</span> <span class="nx">database</span>
            <span class="s">&quot;foreach&quot;</span><span class="o">:</span>
                <span class="nv">f: </span><span class="nf">(args, roots, rootValueTypes, defaultRootName, database) -&gt;</span>
                    <span class="nv">collection = </span><span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">evaluate</span> <span class="nx">roots</span><span class="p">,</span> <span class="nx">rootValueTypes</span><span class="p">,</span> <span class="nx">defaultRootName</span><span class="p">,</span> <span class="nx">database</span>
                    <span class="nv">oldValue = </span><span class="nx">roots</span><span class="p">.</span><span class="nx">value</span>
                    <span class="nv">oldValueType = </span><span class="nx">rootValueTypes</span><span class="p">.</span><span class="nx">value</span>
                    <span class="nv">results = </span><span class="p">[]</span>
                    <span class="nv">valueType = </span><span class="s">&quot;text&quot;</span>

                    <span class="nv">rootValueTypes.value = </span><span class="nx">collection</span><span class="p">.</span><span class="nx">valueType</span>

                    <span class="nx">collection</span><span class="p">.</span><span class="nx">forEachValue</span> <span class="nf">(element) -&gt;</span>
                        <span class="nv">roots.value = </span><span class="nx">element</span>
                        <span class="nv">collection2 = </span><span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">evaluate</span> <span class="nx">roots</span><span class="p">,</span> <span class="nx">rootValueTypes</span><span class="p">,</span> <span class="nx">defaultRootName</span><span class="p">,</span> <span class="nx">database</span>
                        <span class="nv">valueType = </span><span class="nx">collection2</span><span class="p">.</span><span class="nx">valueType</span>

                        <span class="nx">collection2</span><span class="p">.</span><span class="nx">forEachValue</span> <span class="nf">(result) -&gt;</span>
                            <span class="nx">results</span><span class="p">.</span><span class="nx">push</span> <span class="nx">result</span>

                    <span class="nv">roots.value = </span><span class="nx">oldValue</span>
                    <span class="nv">rootValueTypes.value = </span><span class="nx">oldValueType</span>

                    <span class="nx">Expression</span><span class="p">.</span><span class="nx">initCollection</span> <span class="nx">results</span><span class="p">,</span> <span class="nx">valueType</span>
            <span class="s">&quot;default&quot;</span><span class="o">:</span>
                <span class="nv">f: </span><span class="nf">(args, roots, rootValueTypes, defaultRootName, database) -&gt;</span>
                    <span class="k">for</span> <span class="nx">arg</span> <span class="k">in</span> <span class="nx">args</span>
                        <span class="nv">collection = </span><span class="nx">arg</span><span class="p">.</span><span class="nx">evaluate</span> <span class="nx">roots</span><span class="p">,</span> <span class="nx">rootValueTypes</span><span class="p">,</span> <span class="nx">defaultRootName</span><span class="p">,</span> <span class="nx">database</span>
                        <span class="k">if</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>
                            <span class="k">return</span> <span class="nx">collection</span>
                    <span class="nx">Expression</span><span class="p">.</span><span class="nx">initCollection</span> <span class="p">[],</span> <span class="s">&quot;text&quot;</span>

        <span class="nv">Expression.initExpression = </span><span class="nf">(rootNode) -&gt;</span>
            <span class="nv">that = </span><span class="p">{}</span>

            <span class="nv">that.evaluate = </span><span class="nf">(roots, rootValueTypes, defaultRootName, database) -&gt;</span>
                <span class="nv">collection = </span><span class="nx">rootNode</span><span class="p">.</span><span class="nx">evaluate</span> <span class="nx">roots</span><span class="p">,</span> <span class="nx">rootValueTypes</span><span class="p">,</span> <span class="nx">defaultRootName</span><span class="p">,</span> <span class="nx">database</span>
                <span class="k">return</span> <span class="p">{</span>
                    <span class="nv">values: </span><span class="nx">collection</span><span class="p">.</span><span class="nx">getSet</span><span class="p">()</span>
                    <span class="nv">valueType: </span><span class="nx">collection</span><span class="p">.</span><span class="nx">valueType</span>
                    <span class="nv">size: </span><span class="nx">collection</span><span class="p">.</span><span class="nx">size</span>
                <span class="p">}</span>
            
            <span class="nv">that.evaluateOnItem = </span><span class="nf">(itemID, database) -&gt;</span>
                <span class="k">this</span><span class="p">.</span><span class="nx">evaluate</span><span class="p">({</span>
                    <span class="s">&quot;value&quot;</span><span class="o">:</span> <span class="nx">itemID</span>
                <span class="p">},</span> <span class="p">{</span>
                    <span class="s">&quot;value&quot;</span><span class="o">:</span> <span class="s">&quot;item&quot;</span>
                <span class="p">},</span>
                <span class="s">&quot;value&quot;</span><span class="p">,</span>
                <span class="nx">database</span>
                <span class="p">)</span>

            <span class="nv">that.evaluateSingle = </span><span class="nf">(roots, rootValueTypes, defaultRootName, database) -&gt;</span>
                <span class="nv">collection = </span><span class="nx">rootNode</span><span class="p">.</span><span class="nx">evaluate</span> <span class="nx">roots</span><span class="p">,</span> <span class="nx">rootValueTypes</span><span class="p">,</span> <span class="nx">defaultRootName</span><span class="p">,</span> <span class="nx">database</span>
                <span class="nv">result =</span>
                    <span class="nv">value: </span><span class="kc">null</span>
                    <span class="nv">valueType: </span><span class="nx">collection</span><span class="p">.</span><span class="nx">valueType</span>

                <span class="nx">collection</span><span class="p">.</span><span class="nx">forEachValue</span> <span class="nf">(v) -&gt;</span>
                    <span class="nv">result.value = </span><span class="nx">v</span>
                    <span class="kc">true</span>

                <span class="nx">result</span><span class="p">;</span>

            <span class="nv">that.isPath = </span><span class="nx">rootNode</span><span class="p">.</span><span class="nx">isPath</span>

            <span class="k">if</span> <span class="nx">that</span><span class="p">.</span><span class="nx">isPath</span>
                <span class="nv">that.getPath = </span><span class="nf">() -&gt;</span> <span class="nx">rootNode</span> 
                <span class="nv">that.testExists = </span><span class="nf">(roots, rootValueTypes, defaultRootName, database) -&gt;</span>
                    <span class="nx">rootNode</span><span class="p">.</span><span class="nx">testExists</span> <span class="nx">roots</span><span class="p">,</span> <span class="nx">rootValueTypes</span><span class="p">,</span> <span class="nx">defaultRootName</span><span class="p">,</span> <span class="nx">database</span>
            <span class="k">else</span>
                <span class="nv">that.getPath = </span><span class="nf">() -&gt;</span> <span class="kc">null</span>
                <span class="nv">that.testExists = </span><span class="nf">(roots, rootValueTypes, defaultRootName, database) -&gt;</span>
                    <span class="nx">that</span><span class="p">.</span><span class="nx">evaluate</span><span class="p">(</span><span class="nx">roots</span><span class="p">,</span> <span class="nx">rootValueTypes</span><span class="p">,</span> <span class="nx">defaultRootName</span><span class="p">,</span> <span class="nx">database</span><span class="p">).</span><span class="nx">values</span><span class="p">.</span><span class="nx">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>
        
            <span class="nv">that.evaluateBackward = </span><span class="nf">(value, valueType, filter, database) -&gt;</span>
                <span class="nx">rootNode</span><span class="p">.</span><span class="nx">walkBackward</span> <span class="p">[</span><span class="nx">value</span><span class="p">],</span> <span class="nx">valueType</span><span class="p">,</span> <span class="nx">filter</span><span class="p">,</span> <span class="nx">database</span>

            <span class="nv">that.walkForward = </span><span class="nf">(values, valueType, database) -&gt;</span>
                <span class="nx">rootNode</span><span class="p">.</span><span class="nx">walkForward</span> <span class="nx">values</span><span class="p">,</span> <span class="nx">valueType</span><span class="p">,</span> <span class="nx">database</span>

            <span class="nv">that.walkBackward = </span><span class="nf">(values, valueType, filter, database) -&gt;</span>
                <span class="nx">rootNode</span><span class="p">.</span><span class="nx">walkBackward</span> <span class="nx">values</span><span class="p">,</span> <span class="nx">valueType</span><span class="p">,</span> <span class="nx">filter</span><span class="p">,</span> <span class="nx">database</span>

            <span class="nx">that</span>

        <span class="nv">Expression.initCollection = exports.initCollection = </span><span class="nf">(values, valueType) -&gt;</span>
            <span class="nv">that =</span>
                <span class="nv">valueType: </span><span class="nx">valueType</span>

            <span class="k">if</span> <span class="nx">values</span> <span class="k">instanceof</span> <span class="nb">Array</span>

                <span class="nv">that.forEachValue = </span><span class="nf">(f) -&gt;</span>
                    <span class="k">for</span> <span class="nx">v</span> <span class="k">in</span> <span class="nx">values</span>
                        <span class="k">if</span> <span class="nx">f</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span> <span class="o">==</span> <span class="kc">true</span>
                            <span class="k">break</span><span class="p">;</span>

                <span class="nv">that.getSet = </span><span class="nf">() -&gt;</span> <span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">initSet</span> <span class="nx">values</span>

                <span class="nv">that.contains = </span><span class="nf">(v) -&gt;</span> <span class="nx">v</span> <span class="k">in</span> <span class="nx">values</span>

                <span class="nv">that.size = </span><span class="nf">() -&gt;</span> <span class="nx">values</span><span class="p">.</span><span class="nx">length</span>
            <span class="k">else</span>
                <span class="nv">that.forEachValue = </span><span class="nx">values</span><span class="p">.</span><span class="nx">visit</span>
                <span class="nv">that.size = </span><span class="nx">values</span><span class="p">.</span><span class="nx">size</span>
                <span class="nv">that.getSet = </span><span class="nf">() -&gt;</span> <span class="nx">values</span>
                <span class="nv">that.contains = </span><span class="nx">values</span><span class="p">.</span><span class="nx">contains</span>

            <span class="nv">that.isPath = </span><span class="kc">false</span><span class="p">;</span>

            <span class="nx">that</span>

        <span class="nv">Expression.initConstant = </span><span class="nf">(value, valueType) -&gt;</span>
            <span class="nv">that = </span><span class="p">{}</span>

            <span class="nv">that.evaluate = </span><span class="nf">(roots, rootValueTypes, defaultRootName, database) -&gt;</span> <span class="nx">Expression</span><span class="p">.</span><span class="nx">initCollection</span> <span class="p">[</span><span class="nx">value</span><span class="p">],</span> <span class="nx">valueType</span>

            <span class="nv">that.isPath = </span><span class="kc">false</span><span class="p">;</span>

            <span class="nx">that</span>

        <span class="nv">Expression.initOperator = </span><span class="nf">(operator, args) -&gt;</span>
            <span class="nv">that = </span><span class="p">{}</span>
            <span class="nv">_operator = </span><span class="nx">operator</span>
            <span class="nv">_args = </span><span class="nx">args</span>

            <span class="nv">that.evaluate = </span><span class="nf">(roots, rootValueTypes, defaultRootName, database) -&gt;</span>
                <span class="nv">values = </span><span class="p">[]</span>
                <span class="nv">args = </span><span class="p">[]</span>

                <span class="nx">args</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">evaluate</span> <span class="nx">roots</span><span class="p">,</span> <span class="nx">rootValueTypes</span><span class="p">,</span> <span class="nx">defaultRootName</span><span class="p">,</span> <span class="nx">database</span><span class="p">)</span> <span class="k">for</span> <span class="nx">a</span> <span class="k">in</span> <span class="nx">_args</span>

                <span class="nv">operator = </span><span class="nx">_operators</span><span class="p">[</span><span class="nx">_operator</span><span class="p">]</span>
                <span class="nv">f = </span><span class="nx">operator</span><span class="p">.</span><span class="nx">f</span>
                <span class="k">if</span>  <span class="nx">operator</span><span class="p">.</span><span class="nx">argumentType</span> <span class="o">==</span> <span class="s">&quot;number&quot;</span>
                    <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">forEachValue</span> <span class="nf">(v1) -&gt;</span>
                        <span class="k">if</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">v1</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&quot;number&quot;</span>
                            <span class="nv">v1 = </span><span class="nb">parseFloat</span> <span class="nx">v1</span>

                        <span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">forEachValue</span> <span class="nf">(v2) -&gt;</span>
                            <span class="k">if</span> <span class="k">typeof</span><span class="p">(</span><span class="nx">v2</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&quot;number&quot;</span>
                                <span class="nv">v2 = </span><span class="nb">parseFloat</span> <span class="nx">v2</span>

                            <span class="nx">values</span><span class="p">.</span><span class="nx">push</span> <span class="nx">f</span><span class="p">(</span><span class="nx">v1</span><span class="p">,</span> <span class="nx">v2</span><span class="p">)</span>
                <span class="k">else</span>
                    <span class="nx">args</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nx">forEachValue</span> <span class="nf">(v1) -&gt;</span>
                        <span class="nx">args</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="nx">forEachValue</span> <span class="nf">(v2) -&gt;</span> <span class="nx">values</span><span class="p">.</span><span class="nx">push</span> <span class="nx">f</span><span class="p">(</span><span class="nx">v1</span><span class="p">,</span> <span class="nx">v2</span><span class="p">)</span>

                <span class="nx">Expression</span><span class="p">.</span><span class="nx">initCollection</span> <span class="nx">values</span><span class="p">,</span> <span class="nx">operator</span><span class="p">.</span><span class="nx">valueType</span>

            <span class="nv">that.isPath = </span><span class="kc">false</span>

            <span class="nx">that</span>

        <span class="nv">Expression.initFunctionCall = </span><span class="nf">(name, args) -&gt;</span>
            <span class="nv">that = </span><span class="p">{}</span>
            <span class="nv">_args = </span><span class="nx">args</span>

            <span class="nv">that.evaluate = </span><span class="nf">(roots, rootValueTypes, defaultRootName, database) -&gt;</span>
                <span class="nv">args = </span><span class="p">[]</span>

                <span class="nx">args</span><span class="p">.</span><span class="nx">push</span><span class="p">(</span><span class="nx">a</span><span class="p">.</span><span class="nx">evaluate</span> <span class="nx">roots</span><span class="p">,</span> <span class="nx">rootValueTypes</span><span class="p">,</span> <span class="nx">defaultRootName</span><span class="p">,</span> <span class="nx">database</span> <span class="p">)</span> <span class="k">for</span> <span class="nx">a</span> <span class="k">in</span> <span class="nx">_args</span>

                <span class="k">if</span> <span class="nx">Expression</span><span class="p">.</span><span class="nx">functions</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="nx">f</span><span class="o">?</span>
                    <span class="k">return</span> <span class="nx">Expression</span><span class="p">.</span><span class="nx">functions</span><span class="p">[</span><span class="nx">name</span><span class="p">].</span><span class="nx">f</span> <span class="nx">args</span>
                <span class="k">else</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;No such function named </span><span class="si">#{</span><span class="nx">_name</span><span class="si">}</span><span class="s">&quot;</span>

            <span class="nv">that.isPath = </span><span class="kc">false</span>

            <span class="nx">that</span>

        <span class="nv">Expression.initControlCall = </span><span class="nf">(name, args) -&gt;</span>
            <span class="nv">that = </span><span class="p">{}</span>

            <span class="nv">that.evaluate = </span><span class="nf">(roots, rootValueTypes, defaultRootName, database) -&gt;</span>
                <span class="nx">Expression</span><span class="p">.</span><span class="nx">controls</span><span class="p">[</span><span class="nx">name</span><span class="p">].</span><span class="nx">f</span> <span class="nx">args</span><span class="p">,</span> <span class="nx">roots</span><span class="p">,</span> <span class="nx">rootValueTypes</span><span class="p">,</span> <span class="nx">defaultRootName</span><span class="p">,</span> <span class="nx">database</span>

            <span class="nv">that.isPath = </span><span class="kc">false</span>

            <span class="nx">that</span>

        <span class="nv">Expression.initPath = </span><span class="nf">(property, forward) -&gt;</span>
            <span class="nv">that = </span><span class="p">{}</span>
            <span class="nv">_rootName = </span><span class="kc">null</span>
            <span class="nv">_segments = </span><span class="p">[]</span>
        
            <span class="nv">walkForward = </span><span class="nf">(collection, database) -&gt;</span>
                <span class="nv">forwardArraySegmentFn = </span><span class="nf">(segment) -&gt;</span>
                    <span class="nv">a = </span><span class="p">[]</span>
                    <span class="nx">collection</span><span class="p">.</span><span class="nx">forEachValue</span> <span class="nf">(v) -&gt;</span>
                        <span class="nx">database</span><span class="p">.</span><span class="nx">getObjects</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">property</span><span class="p">).</span><span class="nx">visit</span> <span class="nf">(v2) -&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">push</span> <span class="nx">v2</span>
                    <span class="nx">a</span>

                <span class="nv">backwardArraySegmentFn = </span><span class="nf">(segment) -&gt;</span>
                    <span class="nv">a = </span><span class="p">[]</span>
                    <span class="nx">collection</span><span class="p">.</span><span class="nx">forEachValue</span> <span class="nf">(v) -&gt;</span>
                        <span class="nx">database</span><span class="p">.</span><span class="nx">getSubjects</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">property</span><span class="p">).</span><span class="nx">visit</span> <span class="nf">(v2) -&gt;</span> <span class="nx">a</span><span class="p">.</span><span class="nx">push</span> <span class="nx">v2</span>
                    <span class="nx">a</span>

                <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span> <span class="mi">0</span> <span class="p">...</span> <span class="nx">_segments</span><span class="p">.</span><span class="nx">length</span> <span class="p">]</span>
                    <span class="nv">segment = </span><span class="nx">_segments</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">isMultiple</span>
                        <span class="nv">a = </span><span class="p">[]</span>
                        <span class="k">if</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">forward</span>
                            <span class="nv">a = </span><span class="nx">forwardArraySegmentFn</span> <span class="nx">segment</span>
                            <span class="nv">property = </span><span class="nx">database</span><span class="p">.</span><span class="nx">getProperty</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">property</span>
                            <span class="nv">valueType = </span><span class="k">if</span> <span class="nx">property</span><span class="o">?</span> <span class="k">then</span> <span class="nx">property</span><span class="p">.</span><span class="nx">getValueType</span><span class="p">()</span> <span class="k">else</span> <span class="s">&quot;text&quot;</span>
                        <span class="k">else</span>
                            <span class="nv">a = </span><span class="nx">backwardArraySegmentFn</span> <span class="nx">segment</span>
                            <span class="nv">valueType = </span><span class="s">&quot;item&quot;</span>
                        <span class="nv">collection = </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initCollection</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">valueType</span>
                    <span class="k">else</span>
                        <span class="k">if</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">forward</span>
                            <span class="nv">values = </span><span class="nx">database</span><span class="p">.</span><span class="nx">getObjectsUnion</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">getSet</span><span class="p">(),</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">property</span>
                            <span class="nv">property = </span><span class="nx">database</span><span class="p">.</span><span class="nx">getProperty</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">property</span>
                            <span class="nv">valueType = </span><span class="k">if</span> <span class="nx">property</span><span class="o">?</span> <span class="k">then</span> <span class="nx">property</span><span class="p">.</span><span class="nx">getValueType</span><span class="p">()</span> <span class="k">else</span> <span class="s">&quot;text&quot;</span>
                            <span class="nv">collection = </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initCollection</span> <span class="nx">values</span><span class="p">,</span> <span class="nx">valueType</span>
                        <span class="k">else</span>
                            <span class="nv">values = </span><span class="nx">database</span><span class="p">.</span><span class="nx">getSubjectsUnion</span> <span class="nx">collection</span><span class="p">.</span><span class="nx">getSet</span><span class="p">(),</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">property</span>
                            <span class="nv">collection = </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initCollection</span> <span class="nx">values</span><span class="p">,</span> <span class="s">&quot;item&quot;</span>

                <span class="nx">collection</span>

            <span class="nv">walkBackward = </span><span class="nf">(collection, filter, database) -&gt;</span>
                <span class="nv">forwardArraySegmentFn = </span><span class="nf">(segment) -&gt;</span>
                    <span class="nv">a = </span><span class="p">[]</span>
                    <span class="nx">collection</span><span class="p">.</span><span class="nx">forEachValue</span> <span class="nf">(v) -&gt;</span>
                        <span class="nx">database</span><span class="p">.</span><span class="nx">getSubjects</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">property</span><span class="p">).</span><span class="nx">visit</span> <span class="nf">(v2) -&gt;</span>
                            <span class="nx">a</span><span class="p">.</span><span class="nx">push</span> <span class="nx">v2</span> <span class="k">if</span> <span class="nx">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">or</span> <span class="o">!</span><span class="nx">filter</span><span class="o">?</span> <span class="o">or</span> <span class="nx">filter</span><span class="p">.</span><span class="nx">contains</span> <span class="nx">v2</span>
                    <span class="nx">a</span>

                <span class="nv">backwardArraySegmentFn = </span><span class="nf">(segment) -&gt;</span>
                    <span class="nv">a = </span><span class="p">[]</span>
                    <span class="nx">collection</span><span class="p">.</span><span class="nx">forEachValue</span> <span class="nf">(v) -&gt;</span>
                        <span class="nx">database</span><span class="p">.</span><span class="nx">getObjects</span><span class="p">(</span><span class="nx">v</span><span class="p">,</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">property</span><span class="p">).</span><span class="nx">visit</span> <span class="nf">(v2) -&gt;</span>
                            <span class="nx">a</span><span class="p">.</span><span class="nx">push</span> <span class="nx">v2</span> <span class="k">if</span> <span class="nx">i</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">or</span> <span class="o">!</span><span class="nx">filter</span><span class="o">?</span> <span class="o">or</span> <span class="nx">filter</span><span class="p">.</span><span class="nx">contains</span> <span class="nx">v2</span>
                    <span class="nx">a</span>

                <span class="k">if</span> <span class="nx">filter</span> <span class="k">instanceof</span> <span class="nb">Array</span>
                    <span class="nv">filter = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">initSet</span> <span class="nx">filter</span>

                <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span> <span class="nx">_segments</span><span class="p">.</span><span class="nx">length</span><span class="o">-</span><span class="mi">1</span> <span class="p">..</span> <span class="mi">0</span> <span class="p">]</span>
                    <span class="nv">segment = </span><span class="nx">_segments</span><span class="p">[</span><span class="nx">i</span><span class="p">];</span>
                    <span class="k">if</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">isMultiple</span>
                        <span class="nv">a = </span><span class="p">[]</span>
                        <span class="k">if</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">forward</span>
                            <span class="nv">a = </span><span class="nx">forwardArraySegmentFn</span> <span class="nx">segment</span>
                            <span class="nv">property = </span><span class="nx">database</span><span class="p">.</span><span class="nx">getProperty</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">property</span>
                            <span class="nv">valueType = </span><span class="k">if</span> <span class="nx">property</span><span class="o">?</span> <span class="k">then</span> <span class="nx">property</span><span class="p">.</span><span class="nx">getValueType</span><span class="p">()</span> <span class="k">else</span> <span class="s">&quot;text&quot;</span>
                        <span class="k">else</span>
                            <span class="nv">a = </span><span class="nx">backwardArraySegmentFn</span> <span class="nx">segment</span>
                            <span class="nv">valueType = </span><span class="s">&quot;item&quot;</span>
                        <span class="nv">collection = </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initCollection</span> <span class="nx">a</span><span class="p">,</span> <span class="nx">valueType</span>
                    <span class="k">else</span> <span class="k">if</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">forward</span>
                        <span class="nv">values = </span><span class="nx">database</span><span class="p">.</span><span class="nx">getSubjectsUnion</span><span class="p">(</span><span class="nx">collection</span><span class="p">.</span><span class="nx">getSet</span><span class="p">(),</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">property</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">filter</span> <span class="k">else</span> <span class="kc">null</span><span class="p">)</span>
                        <span class="nv">collection = </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initCollection</span> <span class="nx">values</span><span class="p">,</span> <span class="s">&quot;item&quot;</span>
                    <span class="k">else</span>
                        <span class="nv">values = </span><span class="nx">database</span><span class="p">.</span><span class="nx">getObjectsUnion</span><span class="p">(</span><span class="nx">collection</span><span class="p">.</span><span class="nx">getSet</span><span class="p">(),</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">property</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">filter</span> <span class="k">else</span> <span class="kc">null</span><span class="p">)</span>
                        <span class="nv">property = </span><span class="nx">database</span><span class="p">.</span><span class="nx">getProperty</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">property</span>
                        <span class="nv">valueType = </span><span class="k">if</span> <span class="nx">property</span><span class="o">?</span> <span class="k">then</span> <span class="nx">property</span><span class="p">.</span><span class="nx">getValueType</span><span class="p">()</span> <span class="k">else</span> <span class="s">&quot;text&quot;</span>
                        <span class="nv">collection = </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initCollection</span> <span class="nx">values</span><span class="p">,</span> <span class="nx">valueType</span>

                <span class="nx">collection</span>

            <span class="k">if</span> <span class="nx">property</span><span class="o">?</span>
                <span class="nx">_segments</span><span class="p">.</span><span class="nx">push</span>
                    <span class="nv">property: </span><span class="nx">property</span>
                    <span class="nv">forward: </span><span class="nx">forward</span>
                    <span class="nv">isMultiple: </span><span class="kc">false</span>

            <span class="nv">that.isPath = </span><span class="kc">true</span>

            <span class="nv">that.setRootName = </span><span class="nf">(rootName) -&gt;</span> <span class="nv">_rootName = </span><span class="nx">rootName</span>

            <span class="nv">that.appendSegment = </span><span class="nf">(property, hopOperator) -&gt;</span>
                <span class="nx">_segments</span><span class="p">.</span><span class="nx">push</span>
                    <span class="nv">property: </span><span class="nx">property</span>
                    <span class="nv">forward: </span><span class="nx">hopOperator</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s">&quot;.&quot;</span>
                    <span class="nv">isMultiple: </span><span class="nx">hopOperator</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">1</span>

            <span class="nv">that.getSegment = </span><span class="nf">(index) -&gt;</span>
                <span class="k">if</span> <span class="nx">index</span> <span class="o">&lt;</span> <span class="nx">_segments</span><span class="p">.</span><span class="nx">length</span>
                    <span class="nv">segment = </span><span class="nx">_segments</span><span class="p">[</span><span class="nx">index</span><span class="p">]</span>
                    <span class="k">return</span> <span class="p">{</span>
                        <span class="nv">property: </span><span class="nx">segment</span><span class="p">.</span><span class="nx">property</span>
                        <span class="nv">forward: </span><span class="nx">segment</span><span class="p">.</span><span class="nx">forward</span>
                        <span class="nv">isMultiple: </span><span class="nx">segment</span><span class="p">.</span><span class="nx">isMultiple</span>
                    <span class="p">}</span>
                <span class="k">else</span>
                    <span class="k">return</span> <span class="kc">null</span>

            <span class="nv">that.getLastSegment = </span><span class="nf">() -&gt;</span> <span class="nx">that</span><span class="p">.</span><span class="nx">getSegment</span> <span class="nx">_segments</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span>

            <span class="nv">that.getSegmentCount = </span><span class="nf">() -&gt;</span> <span class="nx">_segments</span><span class="p">.</span><span class="nx">length</span>

            <span class="nv">that.rangeBackward = </span><span class="nf">(from, to, filter, database) -&gt;</span>
                <span class="nv">set = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">initSet</span><span class="p">()</span>
                <span class="nv">valueType = </span><span class="s">&quot;item&quot;</span>

                <span class="k">if</span> <span class="nx">_segments</span><span class="p">.</span><span class="nx">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
                    <span class="nv">segment = </span><span class="nx">_segments</span><span class="p">[</span><span class="nx">_segments</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">forward</span>
                        <span class="nx">database</span><span class="p">.</span><span class="nx">getSubjectsInRange</span><span class="p">(</span><span class="nx">segment</span><span class="p">.</span><span class="nx">property</span><span class="p">,</span> <span class="nx">from</span><span class="p">,</span> <span class="nx">to</span><span class="p">,</span> <span class="kc">false</span><span class="p">,</span> <span class="nx">set</span><span class="p">,</span> <span class="k">if</span> <span class="nx">_segments</span><span class="p">.</span><span class="nx">length</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">then</span> <span class="nx">filter</span> <span class="k">else</span> <span class="kc">null</span><span class="p">)</span>
                    <span class="k">else</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Last path of segment must be forward&quot;</span>

                    <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span> <span class="nx">_segments</span><span class="p">.</span><span class="nx">length</span> <span class="o">-</span> <span class="mi">2</span> <span class="p">..</span> <span class="mi">0</span> <span class="p">]</span>
                        <span class="nv">segment = </span><span class="nx">_segments</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">forward</span>
                            <span class="nv">set = </span><span class="nx">database</span><span class="p">.</span><span class="nx">getSubjectsUnion</span><span class="p">(</span><span class="nx">set</span><span class="p">,</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">property</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">filter</span> <span class="k">else</span> <span class="kc">null</span><span class="p">)</span>
                            <span class="nv">valueType = </span><span class="s">&quot;item&quot;</span>
                        <span class="k">else</span>
                            <span class="nv">set = </span><span class="nx">database</span><span class="p">.</span><span class="nx">getObjectsUnion</span><span class="p">(</span><span class="nx">set</span><span class="p">,</span> <span class="nx">segment</span><span class="p">.</span><span class="nx">property</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span> <span class="k">if</span> <span class="nx">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span> <span class="nx">filter</span> <span class="k">else</span> <span class="kc">null</span><span class="p">)</span>
                            <span class="nv">property = </span><span class="nx">database</span><span class="p">.</span><span class="nx">getPropertysegment</span><span class="p">.</span><span class="nx">property</span>
                            <span class="nv">valueType = </span><span class="k">if</span> <span class="nx">property</span><span class="o">?</span> <span class="k">then</span> <span class="nx">property</span><span class="p">.</span><span class="nx">getValueType</span><span class="p">()</span> <span class="k">else</span> <span class="s">&quot;text&quot;</span>

                <span class="k">return</span> <span class="p">{</span>
                    <span class="nv">valueType: </span><span class="nx">valueType</span>
                    <span class="nv">values: </span><span class="nx">set</span>
                    <span class="nv">count: </span><span class="nx">set</span><span class="p">.</span><span class="nx">size</span><span class="p">()</span>
                <span class="p">}</span>

            <span class="nv">that.evaluate = </span><span class="nf">(roots, rootValueTypes, defaultRootName, database) -&gt;</span>
                <span class="nv">rootName = </span><span class="k">if</span> <span class="nx">_rootName</span><span class="o">?</span> <span class="k">then</span> <span class="nx">_rootName</span> <span class="k">else</span> <span class="nx">defaultRootName</span>
                <span class="nv">valueType = </span><span class="k">if</span> <span class="nx">rootValueTypes</span><span class="p">[</span><span class="nx">rootName</span><span class="p">]</span><span class="o">?</span> <span class="k">then</span> <span class="nx">rootValueTypes</span><span class="p">[</span><span class="nx">rootName</span><span class="p">]</span> <span class="k">else</span> <span class="s">&quot;text&quot;</span>
                <span class="nv">collection = </span><span class="kc">null</span>

                <span class="k">if</span> <span class="nx">roots</span><span class="p">[</span><span class="nx">rootName</span><span class="p">]</span><span class="o">?</span>
                    <span class="nv">root = </span><span class="nx">roots</span><span class="p">[</span><span class="nx">rootName</span><span class="p">]</span>

                    <span class="k">if</span> <span class="nx">root</span><span class="p">.</span><span class="nx">isSet</span> <span class="o">or</span> <span class="nx">root</span> <span class="k">instanceof</span> <span class="nb">Array</span>
                        <span class="nv">collection = </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initCollection</span> <span class="nx">root</span><span class="p">,</span> <span class="nx">valueType</span>
                    <span class="k">else</span>
                        <span class="nv">collection = </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initCollection</span> <span class="p">[</span><span class="nx">root</span><span class="p">],</span> <span class="nx">valueType</span>

                    <span class="k">return</span> <span class="nx">walkForward</span> <span class="nx">collection</span><span class="p">,</span> <span class="nx">database</span>
                <span class="k">else</span>
                    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;No such variable called &quot;</span> <span class="o">+</span> <span class="nx">rootName</span>

            <span class="nv">that.testExists = </span><span class="nf">(roots, rootValueTypes, defaultRootName, database) -&gt;</span>
                <span class="nx">that</span><span class="p">.</span><span class="nx">evaluate</span><span class="p">(</span><span class="nx">roots</span><span class="p">,</span> <span class="nx">rootValueTypes</span><span class="p">,</span> <span class="nx">defaultRootName</span><span class="p">,</span> <span class="nx">database</span><span class="p">).</span><span class="nx">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span>

            <span class="nv">that.evaluateBackward = </span><span class="nf">(value, valueType, filter, database) -&gt;</span>
                <span class="nv">collection = </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initCollection</span> <span class="p">[</span><span class="nx">value</span><span class="p">],</span> <span class="nx">valueType</span>
                <span class="nx">walkBackward</span> <span class="nx">collection</span><span class="p">,</span> <span class="nx">filter</span><span class="p">,</span> <span class="nx">database</span>

            <span class="nv">that.walkForward = </span><span class="nf">(values, valueType, database) -&gt;</span>
                <span class="nx">walkForward</span> <span class="nx">Expression</span><span class="p">.</span><span class="nx">initCollection</span><span class="p">(</span><span class="nx">values</span><span class="p">,</span> <span class="nx">valueType</span><span class="p">),</span> <span class="nx">database</span>

            <span class="nv">that.walkBackward = </span><span class="nf">(values, valueType, filter, database) -&gt;</span>
                <span class="nx">walkBackward</span> <span class="nx">Expression</span><span class="p">.</span><span class="nx">initCollection</span><span class="p">(</span><span class="nx">values</span><span class="p">,</span> <span class="nx">valueType</span><span class="p">),</span> <span class="nx">filter</span><span class="p">,</span> <span class="nx">database</span>

            <span class="nx">that</span>

        <span class="nv">Expression.initParser = exports.initParser = </span><span class="nf">() -&gt;</span>
            <span class="nv">that = </span><span class="p">{}</span>
        
            <span class="nv">internalParse = </span><span class="nf">(scanner, several) -&gt;</span>
                <span class="nv">token = </span><span class="nx">scanner</span><span class="p">.</span><span class="nx">token</span><span class="p">()</span>
                <span class="nv">Scanner = </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initScanner</span>
            
                <span class="nv">next = </span><span class="nf">() -&gt;</span>
                    <span class="nx">scanner</span><span class="p">.</span><span class="nx">next</span><span class="p">()</span>
                    <span class="nv">token = </span><span class="nx">scanner</span><span class="p">.</span><span class="nx">token</span><span class="p">()</span>

                <span class="nv">parseTerm = </span><span class="nf">() -&gt;</span>
                    <span class="nv">term = </span><span class="nx">parseFactor</span><span class="p">()</span>

                    <span class="k">while</span> <span class="nx">token</span><span class="o">?</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">Scanner</span><span class="p">.</span><span class="nx">OPERATOR</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="k">in</span> <span class="p">[</span> <span class="s">&quot;*&quot;</span><span class="p">,</span> <span class="s">&quot;/&quot;</span> <span class="p">]</span>
                        <span class="nv">operator = </span><span class="nx">token</span><span class="p">.</span><span class="nx">value</span>
                        <span class="nx">next</span><span class="p">()</span>

                        <span class="nv">term = </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initOperator</span> <span class="nx">operator</span><span class="p">,</span> <span class="p">[</span><span class="nx">term</span><span class="p">,</span> <span class="nx">parseFactor</span><span class="p">()]</span>
                    <span class="nx">term</span>

                <span class="nv">parseSubExpression = </span><span class="nf">() -&gt;</span>
                    <span class="nv">subExpression = </span><span class="nx">parseTerm</span><span class="p">()</span>

                    <span class="k">while</span> <span class="nx">token</span><span class="o">?</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">Scanner</span><span class="p">.</span><span class="nx">OPERATOR</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="k">in</span> <span class="p">[</span> <span class="s">&quot;+&quot;</span><span class="p">,</span> <span class="s">&quot;-&quot;</span> <span class="p">]</span>
                        <span class="nv">operator = </span><span class="nx">token</span><span class="p">.</span><span class="nx">value</span>
                        <span class="nx">next</span><span class="p">()</span>

                        <span class="nv">subExpression = </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initOperator</span> <span class="nx">operator</span><span class="p">,</span> <span class="p">[</span><span class="nx">subExpression</span><span class="p">,</span> <span class="nx">parseTerm</span><span class="p">()]</span>
                    <span class="nx">subExpression</span>

                <span class="nv">parseExpression = </span><span class="nf">() -&gt;</span>
                    <span class="nv">expression = </span><span class="nx">parseSubExpression</span><span class="p">()</span>

                    <span class="k">while</span> <span class="nx">token</span><span class="o">?</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">Scanner</span><span class="p">.</span><span class="nx">OPERATOR</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="k">in</span> <span class="p">[</span> <span class="s">&quot;=&quot;</span><span class="p">,</span> <span class="s">&quot;&lt;&gt;&quot;</span><span class="p">,</span> <span class="s">&quot;&lt;&quot;</span><span class="p">,</span> <span class="s">&quot;&gt;&quot;</span><span class="p">,</span> <span class="s">&quot;&lt;=&quot;</span><span class="p">,</span> <span class="s">&quot;&gt;=&quot;</span> <span class="p">]</span>
                        <span class="nv">operator = </span><span class="nx">token</span><span class="p">.</span><span class="nx">value</span>
                        <span class="nx">next</span><span class="p">()</span>

                        <span class="nv">expression = </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initOperator</span> <span class="nx">operator</span><span class="p">,</span> <span class="p">[</span><span class="nx">expression</span><span class="p">,</span> <span class="nx">parseSubExpression</span><span class="p">()]</span>
                    <span class="nx">expression</span>

                <span class="nv">parseExpressionList = </span><span class="nf">() -&gt;</span>
                    <span class="nv">expressions = </span><span class="p">[</span><span class="nx">parseExpression</span><span class="p">()]</span>
                    <span class="k">while</span> <span class="nx">token</span><span class="o">?</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">Scanner</span><span class="p">.</span><span class="nx">DELIMITER</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="o">==</span> <span class="s">&quot;,&quot;</span>
                        <span class="nx">next</span><span class="p">()</span>
                        <span class="nx">expressions</span><span class="p">.</span><span class="nx">push</span> <span class="nx">parseExpression</span><span class="p">()</span>
                    <span class="nx">expressions</span>

                <span class="nv">makePosition = </span><span class="nf">() -&gt;</span> <span class="k">if</span> <span class="nx">token</span><span class="o">?</span> <span class="k">then</span> <span class="nx">token</span><span class="p">.</span><span class="nx">start</span> <span class="k">else</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">index</span><span class="p">()</span>

                <span class="nv">parsePath = </span><span class="nf">() -&gt;</span>
                    <span class="nv">path = </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initPath</span><span class="p">()</span>

                    <span class="k">while</span> <span class="nx">token</span><span class="o">?</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">Scanner</span><span class="p">.</span><span class="nx">PATH_OPERATOR</span>
                        <span class="nv">hopOperator = </span><span class="nx">token</span><span class="p">.</span><span class="nx">value</span>
                        <span class="nx">next</span><span class="p">()</span>
                    
                        <span class="k">if</span> <span class="nx">token</span><span class="o">?</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">Scanner</span><span class="p">.</span><span class="nx">IDENTIFIER</span>
                            <span class="nx">path</span><span class="p">.</span><span class="nx">appendSegment</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="nx">hopOperator</span>
                            <span class="nx">next</span><span class="p">()</span>
                        <span class="k">else</span>
                            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Missing property ID at position &quot;</span> <span class="o">+</span> <span class="nx">makePosition</span><span class="p">()</span>
                    <span class="nx">path</span>

                <span class="nv">parseFactor = </span><span class="nf">() -&gt;</span>
                    <span class="nv">result = </span><span class="kc">null</span>
                    <span class="nv">args = </span><span class="p">[]</span>

                    <span class="k">if</span> <span class="o">!</span><span class="nx">token</span><span class="o">?</span>
                        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Missing factor at end of expression&quot;</span>

                    <span class="k">switch</span> <span class="nx">token</span><span class="p">.</span><span class="nx">type</span>
                        <span class="k">when</span> <span class="nx">Scanner</span><span class="p">.</span><span class="nx">NUMBER</span>
                            <span class="nv">result = </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initConstant</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="s">&quot;number&quot;</span>
                            <span class="nx">next</span><span class="p">()</span>
                        <span class="k">when</span> <span class="nx">Scanner</span><span class="p">.</span><span class="nx">STRING</span>
                            <span class="nv">result = </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initConstant</span><span class="p">(</span><span class="nx">token</span><span class="p">.</span><span class="nx">value</span><span class="p">,</span> <span class="s">&quot;text&quot;</span><span class="p">);</span>
                            <span class="nx">next</span><span class="p">();</span>
                        <span class="k">when</span> <span class="nx">Scanner</span><span class="p">.</span><span class="nx">PATH_OPERATOR</span> <span class="k">then</span> <span class="nv">result = </span><span class="nx">parsePath</span><span class="p">()</span>
                        <span class="k">when</span> <span class="nx">Scanner</span><span class="p">.</span><span class="nx">IDENTIFIER</span>
                            <span class="nv">identifier = </span><span class="nx">token</span><span class="p">.</span><span class="nx">value</span>
                            <span class="nx">next</span><span class="p">()</span>

                            <span class="k">if</span> <span class="nx">Expression</span><span class="p">.</span><span class="nx">controls</span><span class="p">[</span><span class="nx">identifier</span><span class="p">]</span><span class="o">?</span>
                                <span class="k">if</span> <span class="nx">token</span><span class="o">?</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">Scanner</span><span class="p">.</span><span class="nx">DELIMITER</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="o">==</span> <span class="s">&quot;(&quot;</span>
                                    <span class="nx">next</span><span class="p">()</span>

                                    <span class="k">if</span> <span class="nx">token</span><span class="o">?</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">Scanner</span><span class="p">.</span><span class="nx">DELIMITER</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="o">==</span> <span class="s">&quot;)&quot;</span> 
                                        <span class="nv">args = </span><span class="p">[]</span>
                                    <span class="k">else</span>
                                        <span class="nv">args = </span><span class="nx">parseExpressionList</span><span class="p">()</span>
                                    <span class="nv">result = </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initControlCall</span> <span class="nx">identifier</span><span class="p">,</span> <span class="nx">args</span>

                                    <span class="k">if</span> <span class="nx">token</span><span class="o">?</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">Scanner</span><span class="p">.</span><span class="nx">DELIMITER</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="o">==</span> <span class="s">&quot;)&quot;</span>
                                        <span class="nx">next</span><span class="p">()</span>
                                    <span class="k">else</span>
                                        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Missing ) to end &quot;</span> <span class="o">+</span> <span class="nx">identifier</span> <span class="o">+</span> <span class="s">&quot; at position &quot;</span> <span class="o">+</span> <span class="nx">makePosition</span><span class="p">()</span>
                                <span class="k">else</span>
                                    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Missing ( to start &quot;</span> <span class="o">+</span> <span class="nx">identifier</span> <span class="o">+</span> <span class="s">&quot; at position &quot;</span> <span class="o">+</span> <span class="nx">makePosition</span><span class="p">()</span>
                            <span class="k">else</span>
                                <span class="k">if</span> <span class="nx">token</span><span class="o">?</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">Scanner</span><span class="p">.</span><span class="nx">DELIMITER</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="o">==</span> <span class="s">&quot;(&quot;</span>
                                    <span class="nx">next</span><span class="p">()</span>
                                
                                    <span class="k">if</span> <span class="nx">token</span><span class="o">?</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">Scanner</span><span class="p">.</span><span class="nx">DELIMITER</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="o">==</span> <span class="s">&quot;)&quot;</span>
                                        <span class="nv">args = </span><span class="p">[]</span>
                                    <span class="k">else</span>
                                        <span class="nv">args = </span><span class="nx">parseExpressionList</span><span class="p">()</span>
                                    <span class="nv">result = </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initFunctionCall</span> <span class="nx">identifier</span><span class="p">,</span> <span class="nx">args</span>

                                    <span class="k">if</span> <span class="nx">token</span><span class="o">?</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">Scanner</span><span class="p">.</span><span class="nx">DELIMITER</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="o">==</span> <span class="s">&quot;)&quot;</span>
                                        <span class="nx">next</span><span class="p">()</span>
                                    <span class="k">else</span>
                                        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Missing ) after function call &quot;</span> <span class="o">+</span> <span class="nx">identifier</span> <span class="o">+</span> <span class="s">&quot; at position &quot;</span> <span class="o">+</span> <span class="nx">makePosition</span><span class="p">()</span>
                                <span class="k">else</span>
                                    <span class="nv">result = </span><span class="nx">parsePath</span><span class="p">()</span>
                                    <span class="nx">result</span><span class="p">.</span><span class="nx">setRootName</span> <span class="nx">identifier</span>
                        <span class="k">when</span> <span class="nx">Scanner</span><span class="p">.</span><span class="nx">DELIMITER</span>
                            <span class="k">if</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="o">==</span> <span class="s">&quot;(&quot;</span>
                                <span class="nx">next</span><span class="p">()</span>

                                <span class="nv">result = </span><span class="nx">parseExpression</span><span class="p">()</span>
                                <span class="k">if</span> <span class="nx">token</span><span class="o">?</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">type</span> <span class="o">==</span> <span class="nx">Scanner</span><span class="p">.</span><span class="nx">DELIMITER</span> <span class="o">and</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="o">==</span> <span class="s">&quot;)&quot;</span>
                                    <span class="nx">next</span><span class="p">()</span>
                                <span class="k">else</span>
                                    <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Missing ) at position &quot;</span> <span class="o">+</span> <span class="nx">makePosition</span><span class="p">()</span>
                            <span class="k">else</span>
                                <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Unexpected text &quot;</span> <span class="o">+</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="o">+</span> <span class="s">&quot; at position &quot;</span> <span class="o">+</span> <span class="nx">makePosition</span><span class="p">()</span>
                        <span class="k">else</span>
                            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Unexpected text &quot;</span> <span class="o">+</span> <span class="nx">token</span><span class="p">.</span><span class="nx">value</span> <span class="o">+</span> <span class="s">&quot; at position &quot;</span> <span class="o">+</span> <span class="nx">makePosition</span><span class="p">()</span>
                    <span class="nx">result</span>

                <span class="k">if</span> <span class="nx">several</span>
                    <span class="nv">roots = </span><span class="nx">parseExpressionList</span><span class="p">()</span>
                    <span class="nv">expressions = </span><span class="p">[]</span>
                    <span class="nx">expressions</span><span class="p">.</span><span class="nx">push</span> <span class="nx">Expression</span><span class="p">.</span><span class="nx">initExpression</span><span class="p">(</span><span class="nx">r</span><span class="p">)</span> <span class="k">for</span> <span class="nx">r</span> <span class="k">in</span> <span class="nx">roots</span>
                    <span class="k">return</span> <span class="nx">expressions</span>
                <span class="k">else</span>
                    <span class="k">return</span> <span class="p">[</span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initExpression</span><span class="p">(</span><span class="nx">parseExpression</span><span class="p">())]</span>

            <span class="nv">that.parse = </span><span class="nf">(s, startIndex, results) -&gt;</span>
                <span class="nx">startIndex</span> <span class="o">?=</span> <span class="mi">0</span>
                <span class="nx">results</span> <span class="o">?=</span> <span class="p">{}</span>

                <span class="nv">scanner = </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initScanner</span> <span class="nx">s</span><span class="p">,</span> <span class="nx">startIndex</span>
                <span class="k">try</span>
                    <span class="k">return</span> <span class="nx">internalParse</span><span class="p">(</span><span class="nx">scanner</span><span class="p">,</span> <span class="kc">false</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">finally</span>
                    <span class="nv">results.index = </span><span class="k">if</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">token</span><span class="p">()</span><span class="o">?</span> <span class="k">then</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">token</span><span class="p">().</span><span class="nx">start</span> <span class="k">else</span> <span class="nx">scanner</span><span class="p">.</span><span class="nx">index</span><span class="p">()</span>

            <span class="nx">that</span>

        <span class="nv">Expression.initScanner = </span><span class="nf">(text, startIndex) -&gt;</span>
            <span class="nv">that = </span><span class="p">{}</span>
            <span class="nv">_text = </span><span class="nx">text</span> <span class="o">+</span> <span class="s">&quot; &quot;</span>
            <span class="nv">_maxIndex = </span><span class="nx">text</span><span class="p">.</span><span class="nx">length</span>
            <span class="nv">_index = </span><span class="nx">startIndex</span>
            <span class="nv">_token = </span><span class="kc">null</span>

            <span class="nv">isDigit = </span><span class="nf">(c) -&gt;</span> <span class="s">&quot;0123456789&quot;</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>

            <span class="nv">that.token = </span><span class="nf">() -&gt;</span> <span class="nx">_token</span>

            <span class="nv">that.index = </span><span class="nf">() -&gt;</span> <span class="nx">_index</span>

            <span class="nv">that.next = </span><span class="nf">() -&gt;</span>
                <span class="nv">_token = </span><span class="kc">null</span>

                <span class="nx">_index</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">while</span> <span class="nx">_index</span> <span class="o">&lt;</span> <span class="nx">_maxIndex</span> <span class="o">and</span> <span class="s">&quot; \t\r\n&quot;</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">_text</span><span class="p">.</span><span class="nx">charAt</span> <span class="nx">_index</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>

                <span class="k">if</span> <span class="nx">_index</span> <span class="o">&lt;</span> <span class="nx">_maxIndex</span>
                    <span class="nv">c1 = </span><span class="nx">_text</span><span class="p">.</span><span class="nx">charAt</span> <span class="nx">_index</span>
                    <span class="nv">c2 = </span><span class="nx">_text</span><span class="p">.</span><span class="nx">charAt</span> <span class="nx">_index</span> <span class="o">+</span> <span class="mi">1</span>

                    <span class="k">if</span> <span class="s">&quot;.!&quot;</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">c1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
                        <span class="k">if</span> <span class="nx">c2</span> <span class="o">==</span> <span class="s">&quot;@&quot;</span>
                            <span class="nv">_token =</span>
                                <span class="nv">type: </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initScanner</span><span class="p">.</span><span class="nx">PATH_OPERATOR</span>
                                <span class="nv">value: </span><span class="nx">c1</span> <span class="o">+</span> <span class="nx">c2</span>
                                <span class="nv">start: </span><span class="nx">_index</span>
                                <span class="nv">end: </span><span class="nx">_index</span> <span class="o">+</span> <span class="mi">2</span>
                            <span class="nx">_index</span> <span class="o">+=</span> <span class="mi">2</span>
                        <span class="k">else</span>
                            <span class="nv">_token =</span>
                                <span class="nv">type: </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initScanner</span><span class="p">.</span><span class="nx">PATH_OPERATOR</span>
                                <span class="nv">value: </span><span class="nx">c1</span>
                                <span class="nv">start: </span><span class="nx">_index</span>
                                <span class="nv">end: </span><span class="nx">_index</span> <span class="o">+</span> <span class="mi">1</span>
                            <span class="nx">_index</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span> <span class="k">if</span> <span class="s">&quot;&lt;&gt;&quot;</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">c1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
                        <span class="k">if</span> <span class="p">(</span><span class="nx">c2</span> <span class="o">==</span> <span class="s">&quot;=&quot;</span><span class="p">)</span> <span class="o">or</span> <span class="p">(</span><span class="s">&quot;&lt;&gt;&quot;</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">c2</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">and</span> <span class="nx">c1</span> <span class="o">!=</span> <span class="nx">c2</span><span class="p">)</span>
                            <span class="nv">_token =</span>
                                <span class="nv">type: </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initScanner</span><span class="p">.</span><span class="nx">OPERATOR</span>
                                <span class="nv">value: </span><span class="nx">c1</span> <span class="o">+</span> <span class="nx">c2</span>
                                <span class="nv">start: </span><span class="nx">_index</span>
                                <span class="nv">end: </span><span class="nx">_index</span> <span class="o">+</span> <span class="mi">2</span>
                            <span class="nx">_index</span> <span class="o">+=</span> <span class="mi">2</span>
                        <span class="k">else</span>
                            <span class="nv">_token =</span>
                                <span class="nv">type: </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initScanner</span><span class="p">.</span><span class="nx">OPERATOR</span>
                                <span class="nv">value: </span><span class="nx">c1</span>
                                <span class="nv">start: </span><span class="nx">_index</span>
                                <span class="nv">end: </span><span class="nx">_index</span> <span class="o">+</span> <span class="mi">1</span>
                            <span class="nx">_index</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span> <span class="k">if</span> <span class="s">&quot;+-*/=&quot;</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">c1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
                        <span class="nv">_token =</span>
                            <span class="nv">type: </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initScanner</span><span class="p">.</span><span class="nx">OPERATOR</span>
                            <span class="nv">value: </span><span class="nx">c1</span>
                            <span class="nv">start: </span><span class="nx">_index</span>
                            <span class="nv">end: </span><span class="nx">_index</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="nx">_index</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span> <span class="k">if</span> <span class="s">&quot;()&quot;</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">c1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
                        <span class="nv">_token =</span>
                            <span class="nv">type: </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initScanner</span><span class="p">.</span><span class="nx">DELIMITER</span>
                            <span class="nv">value: </span><span class="nx">c1</span>
                            <span class="nv">start: </span><span class="nx">_index</span>
                            <span class="nv">end: </span><span class="nx">_index</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="nx">_index</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">else</span> <span class="k">if</span> <span class="s">&quot;\&quot;&#39;&quot;</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">c1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span></pre></div>             </td>           </tr>                               <tr id="section-119">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-119">&#182;</a>               </div>               <p>quoted strings</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="nv">i = </span><span class="nx">_index</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="k">while</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">_maxIndex</span>
                            <span class="k">break</span> <span class="k">if</span> <span class="nx">_text</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">==</span> <span class="nx">c1</span> <span class="o">and</span> <span class="nx">_text</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="s">&quot;\\&quot;</span>
                            <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span>

                        <span class="k">if</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">_maxIndex</span>
                            <span class="nv">_token =</span>
                                <span class="nv">type: </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initScanner</span><span class="p">.</span><span class="nx">STRING</span>
                                <span class="nv">value: </span><span class="nx">_text</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nx">i</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\&#39;/g</span><span class="p">,</span> <span class="s">&quot;&#39;&quot;</span><span class="p">).</span><span class="nx">replace</span><span class="p">(</span><span class="sr">/\\&quot;/g</span><span class="p">,</span> <span class="s">&#39;&quot;&#39;</span><span class="p">)</span>
                                <span class="nv">start: </span><span class="nx">_index</span>
                                <span class="nv">end: </span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span>
                            <span class="nv">_index = </span><span class="nx">i</span> <span class="o">+</span> <span class="mi">1</span>
                        <span class="k">else</span>
                            <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;Unterminated string starting at &quot;</span> <span class="o">+</span> <span class="nb">String</span><span class="p">(</span><span class="nx">_index</span><span class="p">)</span>
                    <span class="k">else</span> <span class="k">if</span> <span class="nx">isDigit</span> <span class="nx">c1</span></pre></div>             </td>           </tr>                               <tr id="section-120">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-120">&#182;</a>               </div>               <p>number</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="nv">i = </span><span class="nx">_index</span>
                        <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">while</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">_maxIndex</span> <span class="o">and</span> <span class="nx">isDigit</span><span class="p">(</span><span class="nx">_text</span><span class="p">.</span><span class="nx">charAt</span> <span class="nx">i</span><span class="p">)</span>

                        <span class="k">if</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">_maxIndex</span> <span class="o">and</span> <span class="nx">_text</span><span class="p">.</span><span class="nx">charAt</span><span class="p">(</span><span class="nx">i</span><span class="p">)</span> <span class="o">==</span> <span class="s">&quot;.&quot;</span>
                            <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">while</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">_maxIndex</span> <span class="o">and</span> <span class="nx">isDigit</span><span class="p">(</span><span class="nx">_text</span><span class="p">.</span><span class="nx">charAt</span> <span class="nx">i</span><span class="p">)</span>

                        <span class="nv">_token =</span>
                            <span class="nv">type: </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initScanner</span><span class="p">.</span><span class="nx">NUMBER</span>
                            <span class="nv">value: </span><span class="nb">parseFloat</span><span class="p">(</span><span class="nx">_text</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">_index</span><span class="p">,</span> <span class="nx">i</span><span class="p">))</span>
                            <span class="nv">start: </span><span class="nx">_index</span>
                            <span class="nv">end: </span><span class="nx">i</span>
                        <span class="nv">_index = </span><span class="nx">i</span><span class="p">;</span>
                    <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-121">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-121">&#182;</a>               </div>               <p>identifier</p>             </td>             <td class="code">               <div class="highlight"><pre>                        <span class="nv">i = </span><span class="nx">_index</span>

                        <span class="k">while</span> <span class="nx">i</span> <span class="o">&lt;</span> <span class="nx">_maxIndex</span>
                            <span class="nv">c = </span><span class="nx">_text</span><span class="p">.</span><span class="nx">charAt</span> <span class="nx">i</span>
                            <span class="k">break</span> <span class="nx">unless</span> <span class="s">&quot;(),.!@ \t&quot;</span><span class="p">.</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">c</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span>
                            <span class="nx">i</span> <span class="o">+=</span> <span class="mi">1</span>

                        <span class="nv">_token =</span>
                            <span class="nv">type: </span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initScanner</span><span class="p">.</span><span class="nx">IDENTIFIER</span>
                            <span class="nv">value: </span><span class="nx">_text</span><span class="p">.</span><span class="nx">substring</span><span class="p">(</span><span class="nx">_index</span><span class="p">,</span> <span class="nx">i</span><span class="p">)</span>
                            <span class="nv">start: </span><span class="nx">_index</span>
                            <span class="nv">end: </span><span class="nx">i</span>
                        <span class="nv">_index = </span><span class="nx">i</span>

            <span class="nx">that</span><span class="p">.</span><span class="nx">next</span><span class="p">()</span>

            <span class="nx">that</span>

        <span class="nv">Expression.initScanner.DELIMITER = </span><span class="mi">0</span>
        <span class="nv">Expression.initScanner.NUMBER = </span><span class="mi">1</span>
        <span class="nv">Expression.initScanner.STRING = </span><span class="mi">2</span>
        <span class="nv">Expression.initScanner.IDENTIFIER = </span><span class="mi">3</span>
        <span class="nv">Expression.initScanner.OPERATOR = </span><span class="mi">4</span>
        <span class="nv">Expression.initScanner.PATH_OPERATOR = </span><span class="mi">5</span>

        <span class="nv">Expression.functions = </span><span class="p">{</span> <span class="p">}</span>
        <span class="nv">Expression.FunctionUtilities = </span><span class="p">{</span> <span class="p">}</span>
    
        <span class="nv">exports.registerSimpleMappingFunction = </span><span class="nf">(name, f, valueType) -&gt;</span>
            <span class="nx">Expression</span><span class="p">.</span><span class="nx">functions</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span>
                <span class="nv">f: </span><span class="nf">(args) -&gt;</span>
                    <span class="nv">set = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">initSet</span><span class="p">()</span>
                    <span class="nv">evalArg = </span><span class="nf">(arg) -&gt;</span>
                        <span class="nx">arg</span><span class="p">.</span><span class="nx">forEachValue</span> <span class="nf">(v) -&gt;</span>
                            <span class="nv">v2 = </span><span class="nx">f</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
                            <span class="nx">set</span><span class="p">.</span><span class="nx">add</span> <span class="nx">v2</span> <span class="k">if</span> <span class="nx">v2</span><span class="o">?</span>

                    <span class="nx">evalArg</span> <span class="nx">arg</span> <span class="k">for</span> <span class="nx">arg</span> <span class="k">in</span> <span class="nx">args</span>

                    <span class="nx">Expression</span><span class="p">.</span><span class="nx">initCollection</span> <span class="nx">set</span><span class="p">,</span> <span class="nx">valueType</span>
    <span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">namespace</span> <span class="s">&#39;Presentation&#39;</span><span class="p">,</span> <span class="nf">(Presentation) -&gt;</span>
        <span class="nv">Presentation.initInstance = </span><span class="nf">(type, container, options) -&gt;</span>
            <span class="p">[</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">options</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">normalizeArgs</span> <span class="s">&quot;MITHGrid.Presentation&quot;</span><span class="p">,</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">options</span>
            <span class="nv">that = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">initInstance</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">options</span>

            <span class="nv">activeRenderingId = </span><span class="kc">null</span>    
            <span class="nv">renderings = </span><span class="p">{}</span>
            <span class="nv">lenses = </span><span class="nx">that</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">lenses</span> <span class="o">||</span> <span class="p">{}</span>
            <span class="nv">options = </span><span class="nx">that</span><span class="p">.</span><span class="nx">options</span>
        
            <span class="nx">$</span><span class="p">(</span><span class="nx">container</span><span class="p">).</span><span class="nx">empty</span><span class="p">()</span>

            <span class="nv">lensKeyExpression = </span><span class="kc">undefined</span>
            <span class="nx">options</span><span class="p">.</span><span class="nx">lensKey</span> <span class="o">||=</span> <span class="p">[</span> <span class="s">&#39;.type&#39;</span> <span class="p">]</span>

            <span class="nv">that.getLens = </span><span class="nf">(id) -&gt;</span>
                <span class="k">if</span> <span class="nx">lensKeyExpression</span><span class="o">?</span>
                    <span class="nv">keys = </span><span class="nx">lensKeyExpression</span><span class="p">.</span><span class="nx">evaluate</span> <span class="p">[</span><span class="nx">id</span><span class="p">]</span>
                    <span class="nv">key = </span><span class="nx">keys</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nx">key</span><span class="o">?</span> <span class="o">and</span> <span class="nx">lenses</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="o">?</span>
                    <span class="k">return</span> <span class="p">{</span> <span class="nv">render: </span><span class="nx">lenses</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="p">}</span>
        
            <span class="nv">that.addLens = </span><span class="nf">(key, lens) -&gt;</span>
                <span class="nx">lenses</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span> <span class="o">=</span> <span class="nx">lens</span>
            
            <span class="nv">that.removeLens = </span><span class="nf">(key) -&gt;</span>
                <span class="k">delete</span> <span class="nx">lenses</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span>
        
            <span class="nv">that.hasLens = </span><span class="nf">(key) -&gt;</span> <span class="nx">lenses</span><span class="p">[</span><span class="nx">key</span><span class="p">]</span><span class="o">?</span>
        
            <span class="nv">that.visitRenderings = </span><span class="nf">(cb) -&gt;</span>
                <span class="k">for</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">r</span> <span class="k">of</span> <span class="nx">renderings</span>
                    <span class="k">if</span> <span class="kc">false</span> <span class="o">==</span> <span class="nx">cb</span><span class="p">(</span><span class="nx">id</span><span class="p">,</span> <span class="nx">r</span><span class="p">)</span>
                        <span class="k">return</span>

            <span class="nv">that.renderingFor = </span><span class="nf">(id) -&gt;</span> <span class="nx">renderings</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>
        
            <span class="nv">that.renderItems = </span><span class="nf">(model, items) -&gt;</span>
                <span class="k">if</span> <span class="o">!</span><span class="nx">lensKeyExpression</span><span class="o">?</span>
                    <span class="nv">lensKeyExpression = </span><span class="nx">model</span><span class="p">.</span><span class="nx">prepare</span> <span class="nx">options</span><span class="p">.</span><span class="nx">lensKey</span>
            
                <span class="nv">n = </span><span class="nx">items</span><span class="p">.</span><span class="nx">length</span>
                <span class="nv">step = </span><span class="nx">n</span>
                <span class="k">if</span> <span class="nx">step</span> <span class="o">&gt;</span> <span class="mi">200</span>
                    <span class="nv">step = </span><span class="nb">parseInt</span><span class="p">(</span><span class="nb">Math</span><span class="p">.</span><span class="nx">sqrt</span><span class="p">(</span><span class="nx">step</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
                <span class="nv">step = </span><span class="mi">1</span> <span class="k">if</span> <span class="nx">step</span> <span class="o">&lt;</span> <span class="mi">1</span>
            
                <span class="nv">f = </span><span class="nf">(start) -&gt;</span>
                    <span class="k">if</span> <span class="nx">start</span> <span class="o">&lt;</span> <span class="nx">n</span>
                        <span class="nv">end = </span><span class="nx">start</span> <span class="o">+</span> <span class="nx">step</span>
                        <span class="nv">end = </span><span class="nx">n</span> <span class="k">if</span> <span class="nx">end</span> <span class="o">&gt;</span> <span class="nx">n</span>

                        <span class="k">for</span> <span class="nx">i</span> <span class="k">in</span> <span class="p">[</span><span class="nx">start</span> <span class="p">...</span> <span class="nx">end</span><span class="p">]</span>
                            <span class="nv">id = </span><span class="nx">items</span><span class="p">[</span><span class="nx">i</span><span class="p">]</span>
                            <span class="nv">hasItem = </span><span class="nx">model</span><span class="p">.</span><span class="nx">contains</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
                            <span class="k">if</span> <span class="nx">renderings</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span><span class="o">?</span>
                                <span class="k">if</span> <span class="o">!</span><span class="nx">hasItem</span></pre></div>             </td>           </tr>                               <tr id="section-122">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-122">&#182;</a>               </div>               <p>item was removed
we need to remove it from the display
.remove() should not make changes in the model</p>             </td>             <td class="code">               <div class="highlight"><pre>                                    <span class="nx">renderings</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">eventUnfocus</span><span class="p">()</span> <span class="k">if</span> <span class="nx">activeRenderingId</span> <span class="o">==</span> <span class="nx">id</span> <span class="o">and</span> <span class="nx">renderings</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">eventUnfocus</span><span class="o">?</span>
                                    <span class="nx">renderings</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">remove</span><span class="p">()</span> <span class="k">if</span> <span class="nx">renderings</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">remove</span><span class="o">?</span>
                                    <span class="k">delete</span> <span class="nx">renderings</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span>
                                <span class="k">else</span>
                                    <span class="nx">renderings</span><span class="p">[</span><span class="nx">id</span><span class="p">].</span><span class="nx">update</span> <span class="nx">model</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="nx">id</span><span class="p">)</span>
                            <span class="k">else</span> <span class="k">if</span> <span class="nx">hasItem</span>
                                <span class="nv">rendering = </span><span class="nx">that</span><span class="p">.</span><span class="nx">render</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">model</span><span class="p">,</span> <span class="nx">id</span></pre></div>             </td>           </tr>                               <tr id="section-123">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-123">&#182;</a>               </div>               <p>lens = that.getLens id</p>             </td>             <td class="code">               <div class="highlight"><pre>                                <span class="k">if</span> <span class="nx">rendering</span><span class="o">?</span> <span class="c1">#lens?</span>
                                    <span class="nx">renderings</span><span class="p">[</span><span class="nx">id</span><span class="p">]</span> <span class="o">=</span> <span class="nx">rendering</span> <span class="c1">#lens.render container, that, model, id</span>
                                    <span class="k">if</span> <span class="nx">activeRenderingId</span> <span class="o">==</span> <span class="nx">id</span> <span class="o">and</span> <span class="nx">rendering</span><span class="p">.</span><span class="nx">eventFocus</span><span class="o">?</span>
                                        <span class="nx">rendering</span><span class="p">.</span><span class="nx">eventFocus</span><span class="p">()</span>

                        <span class="nx">setTimeout</span> <span class="nf">() -&gt;</span> 
                            <span class="nx">f</span><span class="p">(</span><span class="nx">end</span><span class="p">)</span>
                        <span class="p">,</span> <span class="mi">0</span>
                    <span class="k">else</span>
                        <span class="nx">that</span><span class="p">.</span><span class="nx">finishDisplayUpdate</span><span class="p">()</span>
                
                <span class="nx">that</span><span class="p">.</span><span class="nx">startDisplayUpdate</span><span class="p">()</span>
                <span class="nx">f</span> <span class="mi">0</span>

            <span class="nv">that.render = </span><span class="nf">(c, m, i) -&gt;</span>
                <span class="nv">lens = </span><span class="nx">that</span><span class="p">.</span><span class="nx">getLens</span> <span class="nx">i</span>
                <span class="k">if</span> <span class="nx">lens</span><span class="o">?</span>
                    <span class="nx">lens</span><span class="p">.</span><span class="nx">render</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">that</span><span class="p">,</span> <span class="nx">m</span><span class="p">,</span> <span class="nx">i</span>

            <span class="nv">that.eventModelChange = </span><span class="nx">that</span><span class="p">.</span><span class="nx">renderItems</span>

            <span class="nv">that.startDisplayUpdate = </span><span class="nf">() -&gt;</span>
            <span class="nv">that.finishDisplayUpdate = </span><span class="nf">() -&gt;</span>

            <span class="nv">that.selfRender = </span><span class="nf">() -&gt;</span> 
                <span class="nx">that</span><span class="p">.</span><span class="nx">renderItems</span> <span class="nx">that</span><span class="p">.</span><span class="nx">dataView</span><span class="p">,</span> <span class="nx">that</span><span class="p">.</span><span class="nx">dataView</span><span class="p">.</span><span class="nx">items</span><span class="p">()</span>
            
            <span class="nv">that.eventFocusChange = </span><span class="nf">(id) -&gt;</span>
                <span class="k">if</span> <span class="nx">activeRenderingId</span><span class="o">?</span>
                    <span class="nv">rendering = </span><span class="nx">that</span><span class="p">.</span><span class="nx">renderingFor</span> <span class="nx">activeRenderingId</span>
                <span class="k">if</span> <span class="nx">activeRenderingId</span> <span class="o">!=</span> <span class="nx">id</span>
                    <span class="k">if</span> <span class="nx">rendering</span><span class="o">?</span> <span class="o">and</span> <span class="nx">rendering</span><span class="p">.</span><span class="nx">eventUnfocus</span><span class="o">?</span>
                        <span class="nx">rendering</span><span class="p">.</span><span class="nx">eventUnfocus</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nx">id</span><span class="o">?</span>
                        <span class="nv">rendering = </span><span class="nx">that</span><span class="p">.</span><span class="nx">renderingFor</span> <span class="nx">id</span>
                        <span class="k">if</span> <span class="nx">rendering</span><span class="o">?</span> <span class="o">and</span> <span class="nx">rendering</span><span class="p">.</span><span class="nx">eventFocus</span><span class="o">?</span>
                            <span class="nx">rendering</span><span class="p">.</span><span class="nx">eventFocus</span><span class="p">()</span>
                    <span class="nv">activeRenderingId = </span><span class="nx">id</span>
                <span class="nx">activeRenderingId</span>

            <span class="nv">that.dataView = </span><span class="nx">that</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">dataView</span>
            <span class="nx">that</span><span class="p">.</span><span class="nx">dataView</span><span class="p">.</span><span class="nx">registerPresentation</span><span class="p">(</span><span class="nx">that</span><span class="p">)</span>
            <span class="nx">that</span>

        <span class="nx">Presentation</span><span class="p">.</span><span class="nx">namespace</span> <span class="s">&quot;SimpleText&quot;</span><span class="p">,</span> <span class="nf">(SimpleText) -&gt;</span>
            <span class="nv">SimpleText.initInstance = </span><span class="nf">(klass, container, options) -&gt;</span>
                <span class="p">[</span> <span class="nx">klass</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">options</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">normalizeArgs</span> <span class="s">&quot;MITHGrid.Presentation.SimpleText&quot;</span><span class="p">,</span> <span class="nx">klass</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">options</span>
                <span class="nv">that = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">Presentation</span><span class="p">.</span><span class="nx">initInstance</span> <span class="nx">klass</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">options</span>

                <span class="nx">that</span></pre></div>             </td>           </tr>                               <tr id="section-124">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-124">&#182;</a>               </div>               <h1>Facets</h1>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">namespace</span> <span class="s">&#39;Facet&#39;</span><span class="p">,</span> <span class="nf">(Facet) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-125">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-125">&#182;</a>               </div>               <h2>Facet.initInstance</h2>             </td>             <td class="code">               <div class="highlight"><pre>        <span class="nv">Facet.initInstance = </span><span class="nf">(klass, container, options) -&gt;</span>
            <span class="nv">that = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">initInstance</span><span class="p">(</span><span class="nx">klass</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
        
            <span class="nv">options = </span><span class="nx">that</span><span class="p">.</span><span class="nx">options</span>
        </pre></div>             </td>           </tr>                               <tr id="section-126">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-126">&#182;</a>               </div>               <h3>#selfRender</h3>

<p>Renders the facet UI elements. This <strong>must</strong> be implemented in any subclass.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nv">that.selfRender = </span><span class="nf">() -&gt;</span>
        </pre></div>             </td>           </tr>                               <tr id="section-127">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-127">&#182;</a>               </div>               <h3>#eventFilterItem</h3>

<p>The default event listener for filtering items</p>

<p>Parameters:</p>

<ul>
<li>model - the data store or data view holding data associated with the item</li>
<li>itemId - the item ID of the item being filtered</li>
</ul>

<p>Returns:</p>

<p>If the item should not be included in the data view's list of items, then this
should return the "false" value. The default implementation returns "false" for
all items.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nv">that.eventFilterItem = </span><span class="nf">(model, itemId) -&gt;</span>
                <span class="k">return</span> <span class="kc">false</span>
            </pre></div>             </td>           </tr>                               <tr id="section-128">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-128">&#182;</a>               </div>               <h3>#eventModelChange</h3>

<p>The default event listener for model changes</p>

<p>Parameters:</p>

<ul>
<li>model - the data store or data view holding data associated with the items</li>
<li>itemList - list of item IDs for items which have changed (added, modified, or deleted)</li>
</ul>

<p>Returns: Nothing.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nv">that.eventModelChange = </span><span class="nf">(model, itemList) -&gt;</span>
                </pre></div>             </td>           </tr>                               <tr id="section-129">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-129">&#182;</a>               </div>               <h3>#constructFacetFrame</h3>

<p>Builds a standard HTML scaffold for facets.</p>

<p>Parameters:</p>

<ul>
<li>container - the DOM element in which to build the scaffolding</li>
<li>options - an object holding the configuration options</li>
</ul>

<p>Returns:</p>

<p>An object holding various elements making up the scaffold:</p>

<ul>
<li>.header</li>
<li>.title</li>
<li>.controls</li>
<li>.counter</li>
<li>.bodyFrame</li>
<li>.body</li>
<li>.setSelectionCount(count)</li>
</ul>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nv">that.constructFacetFrame = </span><span class="nf">(container, options) -&gt;</span>
                <span class="nv">dom = </span><span class="p">{}</span>
            
                <span class="nx">$</span><span class="p">(</span><span class="nx">container</span><span class="p">).</span><span class="nx">addClass</span> <span class="s">&quot;mithgrid-facet&quot;</span>
                <span class="nv">dom.header = </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;&lt;div class=&#39;header&#39; /&gt;&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">onClearAllSelections</span><span class="o">?</span>
                    <span class="nv">dom.controls = </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;&lt;div class=&#39;control&#39; title=&#39;Clear Selection&#39;&gt;&quot;</span><span class="p">)</span>
                    <span class="nv">dom.counter = </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;&lt;span class=&#39;counter&#39;&gt;&lt;/span&gt;&quot;</span><span class="p">)</span>
                    <span class="nx">dom</span><span class="p">.</span><span class="nx">controls</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">dom</span><span class="p">.</span><span class="nx">counter</span><span class="p">)</span>
                    <span class="nx">dom</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">dom</span><span class="p">.</span><span class="nx">controls</span><span class="p">)</span>
                <span class="nv">dom.title = </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;&lt;span class=&#39;title&#39;&gt;&lt;/span&gt;&quot;</span><span class="p">)</span>
                <span class="nx">dom</span><span class="p">.</span><span class="nx">title</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">facetLabel</span> <span class="o">or</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
                <span class="nx">dom</span><span class="p">.</span><span class="nx">header</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">dom</span><span class="p">.</span><span class="nx">title</span><span class="p">)</span>
                <span class="nv">dom.bodyFrame = </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;&lt;div class=&#39;body-frame&#39;&gt;&lt;/div&gt;&quot;</span><span class="p">)</span>
                <span class="nv">dom.body = </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;&lt;div class=&#39;body&#39;&gt;&lt;/div&gt;&quot;</span><span class="p">)</span>
                <span class="nx">dom</span><span class="p">.</span><span class="nx">bodyFrame</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">dom</span><span class="p">.</span><span class="nx">body</span><span class="p">)</span>
            
                <span class="nx">$</span><span class="p">(</span><span class="nx">container</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">dom</span><span class="p">.</span><span class="nx">header</span><span class="p">)</span>
                <span class="nx">$</span><span class="p">(</span><span class="nx">container</span><span class="p">).</span><span class="nx">append</span><span class="p">(</span><span class="nx">dom</span><span class="p">.</span><span class="nx">bodyFrame</span><span class="p">)</span>
            
                <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">onClearAllSelections</span><span class="o">?</span>
                    <span class="nx">dom</span><span class="p">.</span><span class="nx">controls</span><span class="p">.</span><span class="nx">bind</span> <span class="s">&quot;click&quot;</span><span class="p">,</span> <span class="nx">options</span><span class="p">.</span><span class="nx">onClearAllSelections</span>
            
                <span class="nv">dom.setSelectionCount = </span><span class="nf">(count) -&gt;</span>
                    <span class="nv">dom.counter.innerHTML = </span><span class="nx">count</span>
                    <span class="k">if</span> <span class="nx">count</span> <span class="o">&gt;</span> <span class="mi">0</span>
                        <span class="nx">dom</span><span class="p">.</span><span class="nx">counter</span><span class="p">.</span><span class="nx">show</span><span class="p">()</span>
                    <span class="k">else</span>
                        <span class="nx">dom</span><span class="p">.</span><span class="nx">counter</span><span class="p">.</span><span class="nx">hide</span><span class="p">()</span>
            
                <span class="nx">dom</span>
        
            <span class="nx">options</span><span class="p">.</span><span class="nx">dataView</span><span class="p">.</span><span class="nx">registerFilter</span> <span class="nx">that</span>
        
            <span class="nx">that</span>
        
        <span class="nx">Facet</span><span class="p">.</span><span class="nx">namespace</span> <span class="s">&#39;TextSearch&#39;</span><span class="p">,</span> <span class="nf">(TextSearch) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-130">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-130">&#182;</a>               </div>               <h2>TextSearch Facet</h2>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="nv">TextSearch.initInstance = </span><span class="nf">(container, options) -&gt;</span>
                <span class="nv">that = </span><span class="nx">Facet</span><span class="p">.</span><span class="nx">initInstance</span><span class="p">(</span><span class="s">&quot;MITHGrid.Facet.TextSearch&quot;</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
        
                <span class="nv">options = </span><span class="nx">that</span><span class="p">.</span><span class="nx">options</span>
        
                <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">expressions</span><span class="o">?</span>
                    <span class="k">if</span> <span class="o">!</span><span class="nx">$</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">expressions</span><span class="p">)</span>
                        <span class="nv">options.expressions = </span><span class="p">[</span> <span class="nx">options</span><span class="p">.</span><span class="nx">expressions</span> <span class="p">]</span>
                        <span class="nv">parsed = </span><span class="p">(</span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initParser</span><span class="p">().</span><span class="nx">parse</span><span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="k">for</span> <span class="nx">ex</span> <span class="k">in</span> <span class="nx">options</span><span class="p">.</span><span class="nx">expressions</span><span class="p">)</span>
        
                <span class="nv">that.eventFilterItem = </span><span class="nf">(dataSource, id) -&gt;</span>
                    <span class="k">if</span> <span class="nx">that</span><span class="p">.</span><span class="nx">text</span><span class="o">?</span> <span class="o">and</span> <span class="nx">options</span><span class="p">.</span><span class="nx">expressions</span><span class="o">?</span>
                        <span class="k">for</span> <span class="nx">ex</span> <span class="k">in</span> <span class="nx">parsed</span>
                            <span class="nv">items = </span><span class="nx">ex</span><span class="p">.</span><span class="nx">evaluateOnItem</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">dataSource</span>
                            <span class="k">for</span> <span class="nx">v</span> <span class="k">in</span> <span class="nx">items</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">items</span><span class="p">()</span>
                                <span class="k">if</span> <span class="nx">v</span><span class="p">.</span><span class="nx">toLowerCase</span><span class="p">().</span><span class="nx">indexOf</span><span class="p">(</span><span class="nx">that</span><span class="p">.</span><span class="nx">text</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
                                    <span class="k">return</span>
            
                    <span class="k">return</span> <span class="kc">false</span>
            
                <span class="nv">that.eventModelChange = </span><span class="nf">(dataView, itemList) -&gt;</span>
        
                <span class="nv">that.selfRender = </span><span class="nf">() -&gt;</span>
                    <span class="nv">dom = </span><span class="nx">that</span><span class="p">.</span><span class="nx">constructFacetFrame</span> <span class="nx">container</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span>
                        <span class="nv">facetLabel: </span><span class="nx">options</span><span class="p">.</span><span class="nx">facetLabel</span>
                    <span class="nx">$</span><span class="p">(</span><span class="nx">container</span><span class="p">).</span><span class="nx">addClass</span> <span class="s">&quot;mithgrid-facet-textsearch&quot;</span>
                    <span class="nv">inputElement = </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;&lt;input type=&#39;text&#39;&gt;&quot;</span><span class="p">)</span>
                    <span class="nx">dom</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">inputElement</span><span class="p">)</span>
                    <span class="nx">inputElement</span><span class="p">.</span><span class="nx">keyup</span> <span class="nf">() -&gt;</span>
                        <span class="nv">that.text = </span><span class="nx">$</span><span class="p">.</span><span class="nx">trim</span><span class="p">(</span><span class="nx">inputElement</span><span class="p">.</span><span class="nx">val</span><span class="p">().</span><span class="nx">toLowerCase</span><span class="p">())</span>
                        <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onFilterChange</span><span class="p">.</span><span class="nx">fire</span><span class="p">()</span>
        
                <span class="nx">that</span>
    
        <span class="nx">Facet</span><span class="p">.</span><span class="nx">namespace</span> <span class="s">&#39;List&#39;</span><span class="p">,</span> <span class="nf">(List) -&gt;</span>
            <span class="nv">List.initInstance = </span><span class="nf">(container, options) -&gt;</span>
                <span class="nv">that = </span><span class="nx">Facet</span><span class="p">.</span><span class="nx">initInstance</span><span class="p">(</span><span class="s">&quot;MITHGrid.Facet.List&quot;</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
        
                <span class="nv">options = </span><span class="nx">that</span><span class="p">.</span><span class="nx">options</span>
        
                <span class="nv">that.selections = </span><span class="p">[]</span>
        
                <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">expressions</span><span class="o">?</span>
                    <span class="k">if</span> <span class="o">!</span><span class="nx">$</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">expressions</span><span class="p">)</span>
                        <span class="nv">options.expressions = </span><span class="p">[</span> <span class="nx">options</span><span class="p">.</span><span class="nx">expressions</span> <span class="p">]</span>
                        <span class="nv">parsed = </span><span class="p">(</span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">Expression</span><span class="p">.</span><span class="nx">initParser</span><span class="p">().</span><span class="nx">parse</span><span class="p">(</span><span class="nx">ex</span><span class="p">)</span> <span class="k">for</span> <span class="nx">ex</span> <span class="k">in</span> <span class="nx">options</span><span class="p">.</span><span class="nx">expressions</span><span class="p">)</span>
        
                <span class="nv">that.eventFilterItem = </span><span class="nf">(dataSource, id) -&gt;</span>
                    <span class="k">if</span> <span class="nx">that</span><span class="p">.</span><span class="nx">text</span><span class="o">?</span> <span class="o">and</span> <span class="nx">options</span><span class="p">.</span><span class="nx">expressions</span><span class="o">?</span>
                        <span class="k">for</span> <span class="nx">ex</span> <span class="k">in</span> <span class="nx">parsed</span>
                            <span class="nv">items = </span><span class="nx">ex</span><span class="p">.</span><span class="nx">evaluateOnItem</span> <span class="nx">id</span><span class="p">,</span> <span class="nx">dataSource</span>
                            <span class="k">for</span> <span class="nx">v</span> <span class="k">in</span> <span class="nx">items</span><span class="p">.</span><span class="nx">values</span><span class="p">.</span><span class="nx">items</span><span class="p">()</span>
                                <span class="k">if</span> <span class="nx">v</span> <span class="k">in</span> <span class="nx">that</span><span class="p">.</span><span class="nx">selections</span>
                                    <span class="k">return</span>
                            
                <span class="nv">that.selfRender = </span><span class="nf">() -&gt;</span>
                    <span class="nv">dom = </span><span class="nx">that</span><span class="p">.</span><span class="nx">constructFacetFrame</span> <span class="nx">container</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span>
                        <span class="nv">facetLabel: </span><span class="nx">options</span><span class="p">.</span><span class="nx">facetLabel</span>
                        <span class="nv">resizable: </span><span class="kc">true</span>
        
                <span class="nx">that</span>
        
        <span class="nx">Facet</span><span class="p">.</span><span class="nx">namespace</span> <span class="s">&#39;Range&#39;</span><span class="p">,</span> <span class="nf">(Range) -&gt;</span>
            <span class="nv">Range.initInstance = </span><span class="nf">(container, options) -&gt;</span>
                <span class="nv">that = </span><span class="nx">Facet</span><span class="p">.</span><span class="nx">initInstance</span><span class="p">(</span><span class="s">&quot;MITHGrid.Facet.Range&quot;</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
        
                <span class="nv">options = </span><span class="nx">that</span><span class="p">.</span><span class="nx">options</span>
                <span class="nx">options</span><span class="p">.</span><span class="nx">min</span> <span class="o">?=</span> <span class="mi">0</span>
                <span class="nx">options</span><span class="p">.</span><span class="nx">max</span> <span class="o">?=</span> <span class="mi">100</span>
                <span class="nx">options</span><span class="p">.</span><span class="nx">step</span> <span class="o">?=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">30.0</span>

                <span class="nv">that.selfRender = </span><span class="nf">() -&gt;</span>
                    <span class="nv">dom = </span><span class="nx">that</span><span class="p">.</span><span class="nx">constructFacetFrame</span> <span class="nx">container</span><span class="p">,</span> <span class="kc">null</span><span class="p">,</span>
                        <span class="nv">facetLabel: </span><span class="nx">options</span><span class="p">.</span><span class="nx">facetLabel</span>
                        <span class="nv">resizable: </span><span class="kc">false</span>

                    <span class="nv">inputElement = </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;&lt;input type=&#39;range&#39;&gt;&quot;</span><span class="p">)</span>
                    <span class="nx">inputElement</span><span class="p">.</span><span class="nx">attr</span>
                        <span class="nv">min: </span><span class="nx">options</span><span class="p">.</span><span class="nx">min</span>
                        <span class="nv">max: </span><span class="nx">options</span><span class="p">.</span><span class="nx">max</span>
                        <span class="nv">step: </span><span class="nx">options</span><span class="p">.</span><span class="nx">step</span>
                    <span class="nx">dom</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">inputElement</span><span class="p">)</span>
                    <span class="nx">inputElement</span><span class="p">.</span><span class="nx">event</span> <span class="nf">() -&gt;</span>
                        <span class="nv">that.value = </span><span class="nx">inputElement</span><span class="p">.</span><span class="nx">val</span><span class="p">()</span>
                        <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">.</span><span class="nx">onFilterChange</span><span class="p">.</span><span class="nx">fire</span><span class="p">()</span>

                <span class="nx">that</span></pre></div>             </td>           </tr>                               <tr id="section-131">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-131">&#182;</a>               </div>               <h1>MITHGrid Controllers</h1>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">namespace</span> <span class="s">&#39;Controller&#39;</span><span class="p">,</span> <span class="nf">(Controller) -&gt;</span>
        <span class="nv">Controller.initInstance = </span><span class="nf">(klass, options) -&gt;</span>
            <span class="p">[</span> <span class="nx">klass</span><span class="p">,</span> <span class="nx">c</span><span class="p">,</span> <span class="nx">options</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">normalizeArgs</span> <span class="s">&quot;MITHGrid.Controller&quot;</span><span class="p">,</span> <span class="nx">klass</span><span class="p">,</span> <span class="kc">undefined</span><span class="p">,</span> <span class="nx">options</span>
            <span class="nv">that = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">initView</span> <span class="nx">klass</span><span class="p">,</span> <span class="nx">options</span>
            <span class="nv">options = </span><span class="nx">that</span><span class="p">.</span><span class="nx">options</span>
            <span class="nx">options</span><span class="p">.</span><span class="nx">selectors</span> <span class="o">or=</span> <span class="p">{}</span>
        </pre></div>             </td>           </tr>                               <tr id="section-132">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-132">&#182;</a>               </div>               <p>We need something that can have functions bindable to an element
this isn't that object, but can produce that object, so this is a kind of controller factory
that can be used by lenses</p>             </td>             <td class="code">               <div class="highlight"><pre>                
            <span class="nv">initDOMBinding = </span><span class="nf">(element) -&gt;</span>
                <span class="nv">binding = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">initView</span> <span class="nx">options</span><span class="p">.</span><span class="nx">bind</span>
                <span class="nv">bindingsCache = </span><span class="p">{</span> <span class="s">&#39;&#39;</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">}</span>
            
                <span class="nv">binding.locate = </span><span class="nf">(internalSelector) -&gt;</span>
                    <span class="nv">selector = </span><span class="nx">options</span><span class="p">.</span><span class="nx">selectors</span><span class="p">[</span><span class="nx">internalSelector</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nx">selector</span><span class="o">?</span>
                        <span class="k">if</span> <span class="nx">selector</span> <span class="o">==</span> <span class="s">&#39;&#39;</span>
                            <span class="nv">el = </span><span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span>
                        <span class="k">else</span>
                            <span class="nv">el = </span><span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="nx">selector</span><span class="p">)</span>
                        <span class="nx">bindingsCache</span><span class="p">[</span><span class="nx">selector</span><span class="p">]</span> <span class="o">=</span> <span class="nx">el</span>
                        <span class="k">return</span> <span class="nx">el</span>
                    <span class="k">return</span> <span class="kc">undefined</span>
            
                <span class="nv">binding.fastLocate = </span><span class="nf">(internalSelector) -&gt;</span>
                    <span class="nv">selector = </span><span class="nx">options</span><span class="p">.</span><span class="nx">selectors</span><span class="p">[</span><span class="nx">internalSelector</span><span class="p">]</span>
                    <span class="k">if</span> <span class="nx">selector</span><span class="o">?</span>
                        <span class="k">if</span> <span class="nx">bindingsCache</span><span class="p">[</span><span class="nx">selector</span><span class="p">]</span><span class="o">?</span>
                            <span class="k">return</span> <span class="nx">bindingsCache</span><span class="p">[</span><span class="nx">selector</span><span class="p">]</span>
                        <span class="k">return</span> <span class="nx">binding</span><span class="p">.</span><span class="nx">locate</span> <span class="nx">internalSelector</span>
                    <span class="k">return</span> <span class="kc">undefined</span>
                
                <span class="nv">binding.refresh = </span><span class="nf">(listOfSelectors) -&gt;</span>
                    <span class="k">for</span> <span class="nx">internalSelector</span> <span class="k">in</span> <span class="nx">listOfSelectors</span>
                        <span class="nv">selector = </span><span class="nx">options</span><span class="p">.</span><span class="nx">selectors</span><span class="p">[</span><span class="nx">internalSelector</span><span class="p">]</span>
                        <span class="k">if</span> <span class="nx">selector</span><span class="o">?</span>
                            <span class="k">if</span> <span class="nx">selector</span> <span class="o">==</span> <span class="s">&#39;&#39;</span>
                                <span class="nx">bindingsCache</span><span class="p">[</span><span class="s">&#39;&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span>
                            <span class="k">else</span>
                                <span class="nx">bindingsCache</span><span class="p">[</span><span class="nx">selector</span><span class="p">]</span> <span class="o">=</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="nx">selector</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">undefined</span>
            
                <span class="nv">binding.clearCache = </span><span class="nf">() -&gt;</span>
                    <span class="nv">bindingsCache = </span><span class="p">{</span> <span class="s">&#39;&#39;</span><span class="o">:</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span> <span class="p">}</span>

                <span class="nx">binding</span>
        
            <span class="nv">initRaphaelBinding = </span><span class="nf">(raphaelDrawing) -&gt;</span>
                <span class="nv">binding = </span><span class="nx">initDOMBinding</span> <span class="nx">raphaelDrawing</span><span class="p">.</span><span class="nx">node</span>

                <span class="nv">superLocate = </span><span class="nx">binding</span><span class="p">.</span><span class="nx">locate</span>
                <span class="nv">superFastLocate = </span><span class="nx">binding</span><span class="p">.</span><span class="nx">fastLocate</span>
                <span class="nv">superRefresh = </span><span class="nx">binding</span><span class="p">.</span><span class="nx">refresh</span>
                <span class="nv">superBind = </span><span class="nx">binding</span><span class="p">.</span><span class="nx">bind</span>

                <span class="nv">binding.locate = </span><span class="nf">(internalSelector) -&gt;</span>
                    <span class="k">if</span> <span class="nx">internalSelector</span> <span class="o">==</span> <span class="s">&#39;raphael&#39;</span>
                        <span class="nx">raphaelDrawing</span>
                    <span class="k">else</span>
                        <span class="nx">superLocate</span> <span class="nx">internalSelector</span>

                <span class="nv">binding.fastLocate = </span><span class="nf">(internalSelector) -&gt;</span>
                    <span class="k">if</span> <span class="nx">internalSelector</span> <span class="o">==</span> <span class="s">&#39;raphael&#39;</span>
                        <span class="nx">raphaelDrawing</span>
                    <span class="k">else</span>
                        <span class="nx">superFastLocate</span> <span class="nx">internalSelector</span>

                <span class="nv">binding.refresh = </span><span class="nf">(listOfSelectors) -&gt;</span>
                    <span class="nv">listOfSelectors = </span><span class="p">(</span><span class="nx">s</span> <span class="k">for</span> <span class="nx">s</span> <span class="k">in</span> <span class="nx">listOfSelectors</span> <span class="k">when</span> <span class="nx">s</span> <span class="o">!=</span> <span class="s">&#39;raphael&#39;</span><span class="p">)</span>
                    <span class="nx">superRefresh</span> <span class="nx">listOfSelectors</span>

                <span class="nx">binding</span>
            
            <span class="nv">that.initBind = </span><span class="nf">(element) -&gt;</span>
                <span class="k">if</span> <span class="k">typeof</span> <span class="nx">element</span> <span class="o">==</span> <span class="s">&quot;string&quot;</span>
                    <span class="nx">initDOMBinding</span> <span class="nx">$</span><span class="p">(</span><span class="nx">element</span><span class="p">)</span>
                <span class="k">else</span> <span class="k">if</span> <span class="nx">element</span><span class="p">.</span><span class="nx">node</span><span class="o">?</span>
                    <span class="nx">initRaphaelBinding</span> <span class="nx">element</span>
                <span class="k">else</span>
                    <span class="nx">initDOMBinding</span> <span class="nx">element</span>
            
            <span class="nv">that.bind = </span><span class="nf">(element, args...) -&gt;</span>
                <span class="nv">binding = </span><span class="nx">that</span><span class="p">.</span><span class="nx">initBind</span> <span class="nx">element</span>
            
                <span class="nx">that</span><span class="p">.</span><span class="nx">applyBindings</span> <span class="nx">binding</span><span class="p">,</span> <span class="nx">args</span><span class="p">...</span>
            
                <span class="nx">binding</span>
        
            <span class="nv">that.applyBindings = </span><span class="nf">(binding, args...) -&gt;</span>
            
            <span class="nx">that</span></pre></div>             </td>           </tr>                               <tr id="section-133">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-133">&#182;</a>               </div>               <h1>Applications</h1>

<h2>MITHGrid.Application.initApp</h2>

<p>Initializes an application instance.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">namespace</span> <span class="s">&#39;Application&#39;</span><span class="p">,</span> <span class="nf">(Application) -&gt;</span>
        <span class="nv">Application.initInstance = </span><span class="nf">(klass, container, options) -&gt;</span>       
            <span class="p">[</span> <span class="nx">klass</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">options</span> <span class="p">]</span> <span class="o">=</span> <span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">normalizeArgs</span> <span class="s">&quot;MITHGrid.Application&quot;</span><span class="p">,</span> <span class="nx">klass</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">options</span>
            <span class="nv">that = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">initView</span><span class="p">(</span><span class="nx">klass</span><span class="p">,</span> <span class="nx">container</span><span class="p">,</span> <span class="nx">options</span><span class="p">)</span>
            <span class="nv">onReady = </span><span class="p">[]</span>
        
            <span class="nv">that.presentation = </span><span class="p">{}</span>
            <span class="nv">that.facet = </span><span class="p">{}</span>
            <span class="nv">that.dataStore = </span><span class="p">{}</span>
            <span class="nv">that.dataView = </span><span class="p">{}</span>
            <span class="nv">that.controller = </span><span class="p">{}</span>
        
            <span class="nv">options = </span><span class="nx">that</span><span class="p">.</span><span class="nx">options</span>
            
            <span class="nv">configureInstance = </span><span class="o">-&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-134">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-134">&#182;</a>               </div>               <p>The following configuration options are available:</p>

<h3>variables</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">variables</span><span class="o">?</span>
                    <span class="k">for</span> <span class="nx">varName</span><span class="p">,</span> <span class="nx">config</span> <span class="k">of</span> <span class="nx">options</span><span class="p">.</span><span class="nx">variables</span>
                        <span class="nx">that</span><span class="p">.</span><span class="nx">addVariable</span> <span class="nx">varName</span><span class="p">,</span> <span class="nx">config</span></pre></div>             </td>           </tr>                               <tr id="section-135">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-135">&#182;</a>               </div>               <h3>dataStores</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">dataStores</span><span class="o">?</span>
                    <span class="k">for</span> <span class="nx">storeName</span><span class="p">,</span> <span class="nx">config</span> <span class="k">of</span> <span class="nx">options</span><span class="p">.</span><span class="nx">dataStores</span>
                        <span class="nx">that</span><span class="p">.</span><span class="nx">addDataStore</span> <span class="nx">storeName</span><span class="p">,</span> <span class="nx">config</span></pre></div>             </td>           </tr>                               <tr id="section-136">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-136">&#182;</a>               </div>               <h3>dataViews</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">dataViews</span><span class="o">?</span>
                    <span class="k">for</span> <span class="nx">viewName</span><span class="p">,</span> <span class="nx">viewConfig</span> <span class="k">of</span> <span class="nx">options</span><span class="p">.</span><span class="nx">dataViews</span>
                        <span class="nx">that</span><span class="p">.</span><span class="nx">addDataView</span> <span class="nx">viewName</span><span class="p">,</span> <span class="nx">viewConfig</span></pre></div>             </td>           </tr>                               <tr id="section-137">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-137">&#182;</a>               </div>               <h3>controllers</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">controllers</span><span class="o">?</span>
                    <span class="k">for</span> <span class="nx">cName</span><span class="p">,</span> <span class="nx">cconfig</span> <span class="k">of</span> <span class="nx">options</span><span class="p">.</span><span class="nx">controllers</span>
                        <span class="nx">that</span><span class="p">.</span><span class="nx">addController</span> <span class="nx">cName</span><span class="p">,</span> <span class="nx">cconfig</span></pre></div>             </td>           </tr>                               <tr id="section-138">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-138">&#182;</a>               </div>               <h3>viewSetup</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">viewSetup</span><span class="o">?</span>
                    <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">viewSetup</span><span class="p">)</span>
                        <span class="nx">that</span><span class="p">.</span><span class="nx">ready</span> <span class="nf">() -&gt;</span> <span class="nx">options</span><span class="p">.</span><span class="nx">viewSetup</span> <span class="nx">$</span><span class="p">(</span><span class="nx">container</span><span class="p">)</span>
                    <span class="k">else</span>
                        <span class="nx">that</span><span class="p">.</span><span class="nx">ready</span> <span class="nf">() -&gt;</span> <span class="nx">$</span><span class="p">(</span><span class="nx">container</span><span class="p">).</span><span class="nx">append</span> <span class="nx">options</span><span class="p">.</span><span class="nx">viewSetup</span>
        </pre></div>             </td>           </tr>                               <tr id="section-139">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-139">&#182;</a>               </div>               <h3>facets</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">facets</span><span class="o">?</span>
                    <span class="k">for</span> <span class="nx">fName</span><span class="p">,</span> <span class="nx">fconfig</span> <span class="k">of</span> <span class="nx">options</span><span class="p">.</span><span class="nx">facets</span>
                        <span class="nx">that</span><span class="p">.</span><span class="nx">addFacet</span> <span class="nx">fName</span><span class="p">,</span> <span class="nx">fconfig</span>
                    </pre></div>             </td>           </tr>                               <tr id="section-140">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-140">&#182;</a>               </div>               <h3>presentations</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">presentations</span><span class="o">?</span>
                    <span class="k">for</span> <span class="nx">pName</span><span class="p">,</span> <span class="nx">pconfig</span> <span class="k">of</span> <span class="nx">options</span><span class="p">.</span><span class="nx">presentations</span>
                        <span class="nx">that</span><span class="p">.</span><span class="nx">addPresentation</span> <span class="nx">pName</span><span class="p">,</span> <span class="nx">pconfig</span>
        </pre></div>             </td>           </tr>                               <tr id="section-141">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-141">&#182;</a>               </div>               <h3>plugins</h3>             </td>             <td class="code">               <div class="highlight"><pre>                <span class="k">if</span> <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">plugins</span><span class="o">?</span>
                    <span class="k">for</span> <span class="nx">pconfig</span> <span class="k">in</span> <span class="nx">options</span><span class="p">.</span><span class="nx">plugins</span>
                        <span class="nx">that</span><span class="p">.</span><span class="nx">addPlugin</span> <span class="nx">pconfig</span>
                
            <span class="nv">that.ready = </span><span class="nf">(fn) -&gt;</span> <span class="nx">onReady</span><span class="p">.</span><span class="nx">push</span> <span class="nx">fn</span>
        
            <span class="nv">that.addVariable = </span><span class="nf">(varName, config) -&gt;</span>
                <span class="nv">value = </span><span class="nx">config</span><span class="p">.</span><span class="nx">default</span>
                <span class="nx">config</span><span class="p">.</span><span class="o">is</span> <span class="o">or=</span> <span class="s">&#39;rw&#39;</span>
                <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="o">is</span> <span class="k">in</span> <span class="p">[</span><span class="s">&#39;rw&#39;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">]</span>
                    <span class="nv">filter = </span><span class="nx">config</span><span class="p">.</span><span class="nx">filter</span>
                    <span class="nv">validate = </span><span class="nx">config</span><span class="p">.</span><span class="nx">validate</span>
                    <span class="nv">eventName = </span><span class="nx">config</span><span class="p">.</span><span class="nx">event</span> <span class="o">||</span> <span class="p">(</span><span class="s">&#39;on&#39;</span> <span class="o">+</span> <span class="nx">varName</span> <span class="o">+</span> <span class="s">&#39;Change&#39;</span><span class="p">)</span>
                    <span class="nv">setName = </span><span class="nx">config</span><span class="p">.</span><span class="nx">setter</span> <span class="o">||</span> <span class="p">(</span><span class="s">&#39;set&#39;</span> <span class="o">+</span> <span class="nx">varName</span><span class="p">)</span>
                    <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">[</span><span class="nx">eventName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">initEventFirer</span><span class="p">()</span>
                    <span class="k">if</span> <span class="nx">filter</span><span class="o">?</span>
                        <span class="k">if</span> <span class="nx">validate</span><span class="o">?</span>
                            <span class="nx">that</span><span class="p">[</span><span class="nx">setName</span><span class="p">]</span> <span class="o">=</span> <span class="nf">(v) -&gt;</span>
                                <span class="nv">v = </span><span class="nx">validate</span> <span class="nx">filter</span> <span class="nx">v</span>
                                <span class="k">if</span> <span class="nx">value</span> <span class="o">!=</span> <span class="nx">v</span>
                                    <span class="nv">value = </span><span class="nx">v</span>
                                    <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">[</span><span class="nx">eventName</span><span class="p">].</span><span class="nx">fire</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
                        <span class="k">else</span>
                            <span class="nx">that</span><span class="p">[</span><span class="nx">setName</span><span class="p">]</span> <span class="o">=</span> <span class="nf">(v) -&gt;</span>
                                <span class="nv">v = </span><span class="nx">filter</span> <span class="nx">v</span>
                                <span class="k">if</span> <span class="nx">value</span> <span class="o">!=</span> <span class="nx">v</span>
                                    <span class="nv">value = </span><span class="nx">v</span>
                                    <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">[</span><span class="nx">eventName</span><span class="p">].</span><span class="nx">fire</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
                    <span class="k">else</span>
                        <span class="k">if</span> <span class="nx">validate</span><span class="o">?</span>
                            <span class="nx">that</span><span class="p">[</span><span class="nx">setName</span><span class="p">]</span> <span class="o">=</span> <span class="nf">(v) -&gt;</span>
                                <span class="nv">v = </span><span class="nx">validate</span> <span class="nx">v</span>
                                <span class="k">if</span> <span class="nx">value</span> <span class="o">!=</span> <span class="nx">v</span>
                                    <span class="nv">value = </span><span class="nx">v</span>
                                    <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">[</span><span class="nx">eventName</span><span class="p">].</span><span class="nx">fire</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
                        <span class="k">else</span>
                            <span class="nx">that</span><span class="p">[</span><span class="nx">setName</span><span class="p">]</span> <span class="o">=</span> <span class="nf">(v) -&gt;</span>
                                <span class="k">if</span> <span class="nx">value</span> <span class="o">!=</span> <span class="nx">v</span>
                                    <span class="nv">value = </span><span class="nx">v</span>
                                    <span class="nx">that</span><span class="p">.</span><span class="nx">events</span><span class="p">[</span><span class="nx">eventName</span><span class="p">].</span><span class="nx">fire</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span>
                <span class="k">if</span> <span class="nx">config</span><span class="p">.</span><span class="o">is</span> <span class="k">in</span> <span class="p">[</span><span class="s">&#39;r&#39;</span><span class="p">,</span> <span class="s">&#39;rw&#39;</span><span class="p">]</span>
                    <span class="nv">getName = </span><span class="nx">config</span><span class="p">.</span><span class="nx">getter</span> <span class="o">||</span> <span class="p">(</span><span class="s">&#39;get&#39;</span> <span class="o">+</span> <span class="nx">varName</span><span class="p">)</span>
                    <span class="nx">that</span><span class="p">[</span><span class="nx">getName</span><span class="p">]</span> <span class="o">=</span> <span class="nf">() -&gt;</span> <span class="nx">value</span>
        
            <span class="nv">that.addDataStore = </span><span class="nf">(storeName, config) -&gt;</span>
                <span class="k">if</span> <span class="o">!</span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">[</span><span class="nx">storeName</span><span class="p">]</span><span class="o">?</span>
                    <span class="nv">store = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">initStore</span><span class="p">()</span>
                    <span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">[</span><span class="nx">storeName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">store</span>
                    <span class="nx">store</span><span class="p">.</span><span class="nx">addType</span> <span class="s">&#39;Item&#39;</span>
                    <span class="nx">store</span><span class="p">.</span><span class="nx">addProperty</span> <span class="s">&#39;label&#39;</span><span class="p">,</span>
                        <span class="nv">valueType: </span><span class="s">&#39;text&#39;</span>
                    <span class="nx">store</span><span class="p">.</span><span class="nx">addProperty</span> <span class="s">&#39;type&#39;</span><span class="p">,</span>
                        <span class="nv">valueType: </span><span class="s">&#39;text&#39;</span>
                    <span class="nx">store</span><span class="p">.</span><span class="nx">addProperty</span> <span class="s">&#39;id&#39;</span><span class="p">,</span>
                        <span class="nv">valueType: </span><span class="s">&#39;text&#39;</span>
                <span class="k">else</span>
                    <span class="nv">store = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">[</span><span class="nx">storeName</span><span class="p">]</span>

                <span class="k">if</span> <span class="nx">config</span><span class="o">?</span><span class="p">.</span><span class="nx">types</span><span class="o">?</span>
                    <span class="nx">store</span><span class="p">.</span><span class="nx">addType</span> <span class="nx">type</span> <span class="k">for</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">typeInfo</span> <span class="k">of</span> <span class="nx">config</span><span class="p">.</span><span class="nx">types</span>

                <span class="k">if</span> <span class="nx">config</span><span class="o">?</span><span class="p">.</span><span class="nx">properties</span><span class="o">?</span>
                    <span class="nx">store</span><span class="p">.</span><span class="nx">addProperty</span> <span class="nx">prop</span><span class="p">,</span> <span class="nx">propOptions</span> <span class="k">for</span> <span class="nx">prop</span><span class="p">,</span> <span class="nx">propOptions</span> <span class="k">of</span> <span class="nx">config</span><span class="p">.</span><span class="nx">properties</span>
        
            <span class="nv">that.addDataView = </span><span class="nf">(viewName, viewConfig) -&gt;</span>
                <span class="k">if</span> <span class="nx">viewConfig</span><span class="p">.</span><span class="nx">type</span><span class="o">?</span> <span class="o">and</span> <span class="nx">viewConfig</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">initInstance</span><span class="o">?</span>
                    <span class="nv">initFn = </span><span class="nx">viewConfig</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">initInstance</span>
                <span class="k">else</span>
                    <span class="nv">initFn = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">initInstance</span>
                <span class="nv">viewOptions =</span>
                    <span class="nv">dataStore: </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">[</span><span class="nx">viewConfig</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">]</span> <span class="o">||</span> <span class="nx">that</span><span class="p">.</span><span class="nx">dataView</span><span class="p">[</span><span class="nx">viewConfig</span><span class="p">.</span><span class="nx">dataStore</span><span class="p">]</span>
        
                <span class="k">if</span> <span class="o">!</span><span class="nx">that</span><span class="p">.</span><span class="nx">dataView</span><span class="p">[</span><span class="nx">viewName</span><span class="p">]</span><span class="o">?</span>
                    <span class="k">for</span> <span class="nx">k</span><span class="p">,</span><span class="nx">v</span> <span class="k">of</span> <span class="nx">viewConfig</span>
                        <span class="k">if</span> <span class="nx">k</span> <span class="o">!=</span> <span class="s">&quot;type&quot;</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nx">viewOptions</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span>
                            <span class="nx">viewOptions</span><span class="p">[</span><span class="nx">k</span><span class="p">]</span> <span class="o">=</span> <span class="nx">v</span>
                
                    <span class="nv">view = </span><span class="nx">initFn</span> <span class="nx">viewOptions</span>
                    <span class="nx">that</span><span class="p">.</span><span class="nx">dataView</span><span class="p">[</span><span class="nx">viewName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">view</span>
        
            <span class="nv">that.addController = </span><span class="nf">(cName, cconfig) -&gt;</span>
                <span class="nv">coptions = </span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">cconfig</span><span class="p">)</span>
                <span class="nx">that</span><span class="p">.</span><span class="nx">ready</span> <span class="nf">() -&gt;</span>
                    <span class="nv">coptions.application = </span><span class="nx">that</span>
                    <span class="nv">controller = </span><span class="nx">cconfig</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">initController</span> <span class="nx">coptions</span>
                    <span class="nx">that</span><span class="p">.</span><span class="nx">controller</span><span class="p">[</span><span class="nx">cName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">controller</span>
        
            <span class="nv">that.addFacet = </span><span class="nf">(fName, fconfig) -&gt;</span>
                <span class="nv">foptions = </span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">fconfig</span><span class="p">)</span>
                <span class="nx">that</span><span class="p">.</span><span class="nx">ready</span> <span class="nf">() -&gt;</span>
                    <span class="nv">fcontainer = </span><span class="nx">$</span><span class="p">(</span><span class="nx">container</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="nx">fconfig</span><span class="p">.</span><span class="nx">container</span><span class="p">)</span>
                    <span class="nv">fcontainer = </span><span class="nx">fcontainer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">fcontainer</span><span class="p">)</span>
                
                    <span class="nv">foptions.dataView = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataView</span><span class="p">[</span><span class="nx">fconfig</span><span class="p">.</span><span class="nx">dataView</span><span class="p">]</span>
                    <span class="nv">foptions.application = </span><span class="nx">that</span>
                
                    <span class="nv">facet = </span><span class="nx">fconfig</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">initFacet</span> <span class="nx">fcontainer</span><span class="p">,</span> <span class="nx">foptions</span>
                    <span class="nx">that</span><span class="p">.</span><span class="nx">facet</span><span class="p">[</span><span class="nx">fName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">facet</span>
                    <span class="nx">facet</span><span class="p">.</span><span class="nx">selfRender</span><span class="p">()</span>
        
            <span class="nv">that.addPresentation = </span><span class="nf">(pName, pconfig) -&gt;</span>
                <span class="nv">poptions = </span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">pconfig</span><span class="p">)</span>
                <span class="nx">that</span><span class="p">.</span><span class="nx">ready</span> <span class="nf">() -&gt;</span>
                    <span class="nv">pcontainer = </span><span class="nx">$</span><span class="p">(</span><span class="nx">container</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="nx">poptions</span><span class="p">.</span><span class="nx">container</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-142">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-142">&#182;</a>               </div>               <p>pcontainer = $('#' + $(container).attr('id') + ' > ' + poptions.container)</p>             </td>             <td class="code">               <div class="highlight"><pre>                    <span class="nv">pcontainer = </span><span class="nx">pcontainer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">pcontainer</span><span class="p">)</span>
                    <span class="nv">poptions.dataView = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataView</span><span class="p">[</span><span class="nx">pconfig</span><span class="p">.</span><span class="nx">dataView</span><span class="p">]</span>
                    <span class="nv">poptions.application = </span><span class="nx">that</span>
                    <span class="k">if</span> <span class="nx">pconfig</span><span class="p">.</span><span class="nx">controllers</span><span class="o">?</span>
                        <span class="nv">poptions.controllers = </span><span class="p">{}</span>
                        <span class="k">for</span> <span class="nx">cName</span><span class="p">,</span> <span class="nx">cconfig</span> <span class="k">of</span> <span class="nx">pconfig</span><span class="p">.</span><span class="nx">controllers</span>
                            <span class="k">if</span> <span class="k">typeof</span> <span class="nx">cconfig</span> <span class="o">==</span> <span class="s">&quot;string&quot;</span>
                                <span class="nx">poptions</span><span class="p">.</span><span class="nx">controllers</span><span class="p">[</span><span class="nx">cName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">that</span><span class="p">.</span><span class="nx">controller</span><span class="p">[</span><span class="nx">cName</span><span class="p">]</span>
                            <span class="k">else</span>
                                <span class="nv">coptions = </span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">cconfig</span><span class="p">)</span>
                                <span class="nv">coptions.application = </span><span class="nx">that</span>
                                <span class="nx">poptions</span><span class="p">.</span><span class="nx">controllers</span><span class="p">[</span><span class="nx">cName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">cconfig</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">initController</span> <span class="nx">coptions</span>
            
                    <span class="nv">presentation = </span><span class="nx">pconfig</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">initPresentation</span> <span class="nx">pcontainer</span><span class="p">,</span> <span class="nx">poptions</span>
                    <span class="nx">that</span><span class="p">.</span><span class="nx">presentation</span><span class="p">[</span><span class="nx">pName</span><span class="p">]</span> <span class="o">=</span> <span class="nx">presentation</span>
                    <span class="nx">presentation</span><span class="p">.</span><span class="nx">selfRender</span><span class="p">()</span>
                
            <span class="nv">that.addPlugin = </span><span class="nf">(pconf) -&gt;</span>
                <span class="nv">pconfig = </span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">pconf</span><span class="p">)</span>
                <span class="nv">pconfig.application = </span><span class="nx">that</span>
                <span class="nx">that</span><span class="p">.</span><span class="nx">ready</span> <span class="nf">() -&gt;</span>
                    <span class="nv">plugin = </span><span class="nx">pconfig</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">initPlugin</span><span class="p">(</span><span class="nx">pconfig</span><span class="p">)</span>
                    <span class="k">if</span> <span class="nx">plugin</span><span class="o">?</span>
                        <span class="k">if</span> <span class="nx">pconfig</span><span class="o">?</span><span class="p">.</span><span class="nx">dataView</span><span class="o">?</span></pre></div>             </td>           </tr>                               <tr id="section-143">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-143">&#182;</a>               </div>               <p>hook plugin up with dataView requested by app configuration</p>             </td>             <td class="code">               <div class="highlight"><pre>                            <span class="nv">plugin.dataView = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataView</span><span class="p">[</span><span class="nx">pconfig</span><span class="p">.</span><span class="nx">dataView</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-144">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-144">&#182;</a>               </div>               <p>add</p>             </td>             <td class="code">               <div class="highlight"><pre>                            <span class="nx">plugin</span><span class="p">.</span><span class="nx">dataView</span><span class="p">.</span><span class="nx">addType</span> <span class="nx">type</span> <span class="k">for</span> <span class="nx">type</span><span class="p">,</span> <span class="nx">typeInfo</span> <span class="k">of</span> <span class="nx">plugin</span><span class="p">.</span><span class="nx">getTypes</span><span class="p">()</span>

                            <span class="nx">plugin</span><span class="p">.</span><span class="nx">dataView</span><span class="p">.</span><span class="nx">addProperty</span> <span class="nx">prop</span><span class="p">,</span> <span class="nx">propOptions</span> <span class="k">for</span> <span class="nx">prop</span><span class="p">,</span> <span class="nx">propOptions</span> <span class="k">of</span> <span class="nx">plugin</span><span class="p">.</span><span class="nx">getProperties</span><span class="p">()</span>

                        <span class="k">for</span> <span class="nx">pname</span><span class="p">,</span> <span class="nx">prconfig</span> <span class="k">of</span> <span class="nx">plugin</span><span class="p">.</span><span class="nx">getPresentations</span><span class="p">()</span>
                            <span class="nv">proptions = </span><span class="nx">$</span><span class="p">.</span><span class="nx">extend</span><span class="p">(</span><span class="kc">true</span><span class="p">,</span> <span class="p">{},</span> <span class="nx">prconfig</span><span class="p">.</span><span class="nx">options</span><span class="p">)</span>
                            <span class="nv">pcontainer = </span><span class="nx">$</span><span class="p">(</span><span class="nx">container</span><span class="p">).</span><span class="nx">find</span><span class="p">(</span><span class="nx">prconfig</span><span class="p">.</span><span class="nx">container</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-145">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-145">&#182;</a>               </div>               <p>pcontainer = $("#" + $(container).attr('id') + ' > ' + prconfig.container)</p>             </td>             <td class="code">               <div class="highlight"><pre>                            <span class="nv">pcontainer = </span><span class="nx">pcontainer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="nx">$</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">pcontainer</span><span class="p">)</span>

                            <span class="nv">proptions.lenses = </span><span class="nx">prconfig</span><span class="p">.</span><span class="nx">lenses</span> <span class="k">if</span> <span class="nx">prconfig</span><span class="o">?</span><span class="p">.</span><span class="nx">lenses</span><span class="o">?</span>
                            <span class="k">if</span> <span class="nx">prconfig</span><span class="p">.</span><span class="nx">dataView</span><span class="o">?</span>
                                <span class="nv">proptions.dataView = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataView</span><span class="p">[</span><span class="nx">prconfig</span><span class="p">.</span><span class="nx">dataView</span><span class="p">]</span> 
                            <span class="k">else</span> <span class="k">if</span> <span class="nx">pconfig</span><span class="p">.</span><span class="nx">dataView</span><span class="o">?</span>
                                <span class="nv">proptions.dataView = </span><span class="nx">that</span><span class="p">.</span><span class="nx">dataView</span><span class="p">[</span><span class="nx">pconfig</span><span class="p">.</span><span class="nx">dataView</span><span class="p">]</span>
                            <span class="nv">proptions.application = </span><span class="nx">that</span>
                            <span class="nv">presentation = </span><span class="nx">prconfig</span><span class="p">.</span><span class="nx">type</span><span class="p">.</span><span class="nx">initPresentation</span> <span class="nx">pcontainer</span><span class="p">,</span> <span class="nx">proptions</span>
                            <span class="nx">plugin</span><span class="p">.</span><span class="nx">presentation</span><span class="p">[</span><span class="nx">pname</span><span class="p">]</span> <span class="o">=</span> <span class="nx">presentation</span>
                            <span class="nx">presentation</span><span class="p">.</span><span class="nx">selfRender</span><span class="p">()</span>
        
            <span class="nx">configureInstance</span><span class="p">()</span>

            <span class="nv">that.run = </span><span class="nf">() -&gt;</span>
                <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">).</span><span class="nx">ready</span> <span class="nf">() -&gt;</span>
                    <span class="nx">fn</span><span class="p">()</span> <span class="k">for</span> <span class="nx">fn</span> <span class="k">in</span> <span class="nx">onReady</span>                      
                    <span class="nv">onReady = </span><span class="p">[]</span>
                    <span class="nv">that.ready = </span><span class="nf">(fn) -&gt;</span> <span class="nx">setTimeout</span> <span class="nx">fn</span><span class="p">,</span> <span class="mi">0</span>
            <span class="nx">that</span>

        <span class="nv">Application.initApp = </span><span class="nx">Application</span><span class="p">.</span><span class="nx">initInstance</span></pre></div>             </td>           </tr>                               <tr id="section-146">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-146">&#182;</a>               </div>               <h1>Plugins</h1>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">namespace</span> <span class="s">&quot;Plugin&quot;</span><span class="p">,</span> <span class="nf">(exports) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-147">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-147">&#182;</a>               </div>               <p>This is the base of a plugin, which can package together various things that augment
an application.</p>

<p>MITHGrid.Plugin.MyPlugin = function(options) {
   var that = MITHGrid.Plugin.initPlugin('MyPlugin', options, { ... })
 };</p>

<p>var myApp = MITHGrid.Application({
   plugins: [ { name: 'MyPlugin', ... } ]
 });</p>             </td>             <td class="code">               <div class="highlight"><pre>        
        <span class="nv">exports.initPlugin = </span><span class="nf">(klass, options) -&gt;</span>
            <span class="nv">that = </span><span class="p">{</span> <span class="nv">options: </span><span class="nx">options</span><span class="p">,</span> <span class="nv">presentation: </span><span class="p">{</span> <span class="p">}</span> <span class="p">}</span>
            <span class="nv">readyFns = </span><span class="p">[</span> <span class="p">]</span>
        
            <span class="nv">that.getTypes = </span><span class="nf">() -&gt;</span>
                <span class="k">if</span> <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">types</span><span class="o">?</span>
                    <span class="nx">options</span><span class="p">.</span><span class="nx">types</span>
                <span class="k">else</span>
                    <span class="p">[</span> <span class="p">]</span>
        
            <span class="nv">that.getProperties = </span><span class="nf">() -&gt;</span>
                <span class="k">if</span> <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">properties</span><span class="o">?</span>
                    <span class="nx">options</span><span class="p">.</span><span class="nx">properties</span>
                <span class="k">else</span>
                    <span class="p">[</span> <span class="p">]</span>
        
            <span class="nv">that.getPresentations = </span><span class="nf">() -&gt;</span>
                <span class="k">if</span> <span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">presentations</span><span class="o">?</span>
                    <span class="nx">options</span><span class="p">.</span><span class="nx">presentations</span><span class="p">;</span>
                <span class="k">else</span>
                    <span class="p">[</span> <span class="p">]</span>
        
            <span class="nv">that.ready = </span><span class="nx">readyFns</span><span class="p">.</span><span class="nx">push</span>
        
            <span class="nv">that.eventReady = </span><span class="nf">(app) -&gt;</span>
                <span class="k">for</span> <span class="nx">fn</span> <span class="k">in</span> <span class="nx">readyFns</span>
                    <span class="nx">fn</span> <span class="nx">app</span>
                <span class="nv">readyFns = </span><span class="p">[]</span>
                <span class="nv">that.ready = </span><span class="nf">(fn) -&gt;</span>
                    <span class="nx">fn</span> <span class="nx">app</span>
        
            <span class="nx">that</span></pre></div>             </td>           </tr>                               <tr id="section-148">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-148">&#182;</a>               </div>               <p>Here, we have our deprecated ways of referring to initializers
<strong>These aliases will be removed in the first public release.</strong></p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">MITHGrid.initView = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">initInstance</span>
    <span class="nv">MITHGrid.Data.initSet = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Set</span><span class="p">.</span><span class="nx">initInstance</span>
    <span class="nv">MITHGrid.Data.initType = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Type</span><span class="p">.</span><span class="nx">initInstance</span>
    <span class="nv">MITHGrid.Data.initProperty = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Property</span><span class="p">.</span><span class="nx">initInstance</span>
    <span class="nv">MITHGrid.Data.initStore = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">Store</span><span class="p">.</span><span class="nx">initInstance</span>
    <span class="nv">MITHGrid.Data.initView = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">Data</span><span class="p">.</span><span class="nx">View</span><span class="p">.</span><span class="nx">initInstance</span>
    <span class="nv">MITHGrid.Controller.initController = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">Controller</span><span class="p">.</span><span class="nx">initInstance</span>
    <span class="nv">MITHGrid.Controller.initRaphaelController = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">Controller</span><span class="p">.</span><span class="nx">initController</span>
    <span class="nv">MITHGrid.Presentation.initPresentation = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">Presentation</span><span class="p">.</span><span class="nx">initInstance</span>
    <span class="nv">MITHGrid.Presentation.SimpleText.initPresentation = </span><span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">Presentation</span><span class="p">.</span><span class="nx">SimpleText</span><span class="p">.</span><span class="nx">initInstance</span>
    
<span class="p">)(</span><span class="nx">jQuery</span><span class="p">,</span> <span class="nx">MITHGrid</span><span class="p">)</span>

<span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">defaults</span> <span class="s">&quot;MITHGrid.Data.Store&quot;</span><span class="p">,</span>
    <span class="nv">events:</span>
        <span class="nv">onModelChange: </span><span class="kc">null</span>
        <span class="nv">onBeforeLoading: </span><span class="kc">null</span>
        <span class="nv">onAfterLoading: </span><span class="kc">null</span>
        <span class="nv">onBeforeUpdating: </span><span class="kc">null</span>
        <span class="nv">onAfterUpdating: </span><span class="kc">null</span>

<span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">defaults</span> <span class="s">&quot;MITHGrid.Data.View&quot;</span><span class="p">,</span>
    <span class="nv">events:</span>
        <span class="nv">onModelChange: </span><span class="kc">null</span>
        <span class="nv">onFilterItem: </span><span class="s">&quot;preventable&quot;</span>

<span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">defaults</span> <span class="s">&quot;MITHGrid.Data.SubSet&quot;</span><span class="p">,</span>
    <span class="nv">events:</span>
        <span class="nv">onModelChange: </span><span class="kc">null</span>

<span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">defaults</span> <span class="s">&quot;MITHGrid.Data.Pager&quot;</span><span class="p">,</span>
    <span class="nv">events:</span>
        <span class="nv">onModelChange: </span><span class="kc">null</span>

<span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">defaults</span> <span class="s">&quot;MITHGrid.Data.RangePager&quot;</span><span class="p">,</span>
    <span class="nv">events:</span>
        <span class="nv">onModelChange: </span><span class="kc">null</span>

<span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">defaults</span> <span class="s">&quot;MITHGrid.Data.ListPager&quot;</span><span class="p">,</span>
    <span class="nv">events:</span>
        <span class="nv">onModelChange: </span><span class="kc">null</span>

<span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">defaults</span> <span class="s">&quot;MITHGrid.Facet&quot;</span><span class="p">,</span>
    <span class="nv">events:</span>
        <span class="nv">onFilterChange: </span><span class="kc">null</span>

<span class="nx">MITHGrid</span><span class="p">.</span><span class="nx">defaults</span> <span class="s">&quot;MITHGrid.Facet.TextSearch&quot;</span><span class="p">,</span>
    <span class="nv">facetLabel: </span><span class="s">&quot;Search&quot;</span>
    <span class="nv">expressions: </span><span class="p">[</span> <span class="s">&quot;.label&quot;</span> <span class="p">]</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 