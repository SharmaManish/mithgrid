/*
 * mithgrid JavaScript Library v0.0.1
 *
 * Date: Sun Jul 3 09:30:40 2011 -0400
 *
 * (c) Copyright University of Maryland 2011.  All rights reserved.
 *
 * (c) Copyright Texas A&M University 2010.  All rights reserved.
 *
 * Portions of this code are copied from The SIMILE Project:
 *  (c) Copyright The SIMILE Project 2006. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 *
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 *
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * 3. The name of the author may not be used to endorse or promote products
 *    derived from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
 * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
 * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
 * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
 * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 */
var MITHGrid=MITHGrid||{};(function(a,b){window.console!==undefined&&window.console.log!==undefined?b.debug=function(){console.log(Array.prototype.slice.call(arguments))}:b.debug=function(){};var c=function(a,d){a[d]===undefined&&(a[d]={namespace:function(b){return c(a[d],b)},debug:b.debug});return a[d]};b.namespace=function(a){return c(b,a)},b.namespace("Data");var d=b.Data;d.Set=function(b){var c={},d={},e=0,f=!0,g=[];c.isSet=!0,c.items=function(){if(f){g=[];for(var a in d)typeof a=="string"&&d[a]===!0&&g.push(a)}return g},c.add=function(a){a in d||(d[a]=!0,f=!0,e+=1)},c.remove=function(a){a in d&&(delete d[a],f=!0,e-=1)},c.visit=function(a){var b;for(b in d)if(a(b)===!0)break},c.contains=function(a){return a in d},c.size=function(){return f?c.items().length:g.length},b instanceof Array&&a(b).each(function(a,b){c.add(b)});return c},d.Type=function(a){var b={};b.name=a,b.custom={};return b},d.Property=function(a){var b={};b.name=a,b.getValueType=function(){return b.valueType||"text"};return b};var e={};d.Source=function(c){var f,g,h=!1,i=d.Set();if(typeof e[c.source]!="undefined")return e[c.source];f=fluid.initView("MITHGrid.Data.Source",a(window),c),e[c.source]=f,f.source=c.source,f.types={},f.properties={},f.spo={},f.ops={},f.items=i.items,f.addProperty=function(a,b){var c=d.Property(a);c.valueType=b.valueType,f.properties[a]=c},f.addType=function(a,b){var c=d.Type(a);f.types[a]=c},f.getItem=function(a){if(a in f.spo)return f.spo[a].values;return{}},f.getItems=function(b){if(!a.isArray(b))return[f.getItem(b)];a.map(b,function(a,b){return f.getItem(a)})},f.fetchData=function(b){a.ajax({url:b,dataType:"json",success:function(a,b){f.loadData(a)}})};var j=function(b,c,d,e){var f=b[c],g,h,i,j;f||(f={values:{},counts:{}},b[c]=f),g=f.values[d],h=f.counts[d],g||(g=[],f.values[d]=g);if(!h)h={},f.counts[d]=h;else if(a.inArray(e,g)!=-1){h[e]+=1;return}g.push(e),h[e]=1};f.updateItems=function(b){var c,d,e,g,h,i,k=[],l,m=function(b,c,d,e){var f=b[c],g,h,i,j;if(!!f){g=f.values[d],h=f.counts[d];if(!g)return;if(!h)return;h[e]-=1,h[e]<1&&(i=a.inArray(e,g),i===0?g=g.slice(1):i==g.length-1?g=g.slice(0,i-1):g=g.slice(0,i-1).concat(g.slice(i+1)),f.values[d]=g)}},n=function(a,b,c){j(f.spo,a,b,c),j(f.ops,c,b,a)},o=function(a,b,c){m(f.spo,a,b,c),m(f.ops,c,b,a)},p=function(b,c,d){var e,g=item.id,h=item.type,i=!1;a.isArray(g)&&(g=g[0]),a.isArray(h)&&(h=h[0]),e=f.getItem(g);var j=function(b,c){var d=!0;if(b.length!=c.length)return!1;a.each(b,function(a,b){b!=c[a]&&(d=!1)});return d},k=function(b,c,e){a.each(e,function(a,e){d(b,c,e)})},l=function(b,d,e){a.each(e,function(a,e){c(b,d,e)})};for(var m in b){if(typeof m!="string"||m=="id"||m=="type")continue;var n=b[m];a.isArray(n)||(n=[n]);var o=n.length;if(m in e){if(j(n,e[m]))continue;i=!0,k(g,m,e[m])}l(g,m,n)}return i};f.events.onBeforeUpdating.fire(f),g=b.length,h=parseInt(g/100,10),h>200&&(h=200),h<1&&(h=1),i=function(a){var c,d;c=a+h,c>g&&(c=g);for(d=a;d<c;d+=1)l=b[d],typeof l=="object"&&p(l,n,o)&&k.push(l.id);c<g?setTimeout(function(){i(c)},0):setTimeout(function(){f.events.onAfterUpdating.fire(f),setTimeout(function(){f.events.onModelChange.fire(f,k)},0)},0)},i(0)},f.loadItems=function(c){var d,e,g,h,k,l=[],m,n=function(a,b,c){j(f.spo,a,b,c),j(f.ops,c,b,a)},o=function(c,d){var e,f,g,h,j;if("id"in c){if(!("type"in c)){b.debug("Item entry has no type: ",c);return}e=c.id,f=c.type,a.isArray(e)&&(e=e[0]),a.isArray(f)&&(f=f[0]),i.add(e),l.push(e),n(e,"type",f),n(e,"id",e);for(g in c){if(typeof g!="string")continue;if(g!="id"&&g!="type"){v=c[g];if(a.isArray(v))for(h=0,j=v.length;h<j;h+=1)n(e,g,v[h]);else v!==undefined&&v!==null&&n(e,g,v)}}}else b.debug("Item entry has no id: ",c)};f.events.onBeforeLoading.fire(f);try{k=c.length,chunk_size=parseInt(k/100,10),chunk_size>200&&(chunk_size=200),chunk_size<1&&(chunk_size=1),m=function(a){var d,e;d=a+chunk_size,d>k&&(d=k);try{for(e=a;e<d;e+=1)h=c[e],typeof h=="object"&&o(h)}catch(g){b.debug("loadData failed: ",g)}d<k?setTimeout(function(){m(d)},0):setTimeout(function(){f.events.onAfterLoading.fire(f),setTimeout(function(){f.events.onModelChange.fire(f,l)},0)},0)},m(0)}catch(p){b.debug("loadData failed: ",p)}},f.prepare=function(c){return a.map(c,function(a){return b.Expression.Parser().parse(a)})},f.evaluate=function(b,c){var d=[];a.each(c,function(a,c){var e=c.evaluateOnItem(b,f);d=d.concat(e.values.items())});return d};var k=function(a,b,c,d,e){var f=a[b],g,h,i,j;if(f){g=f.values[c];if(g)if(e)for(h=0,i=g.length;h<i;h+=1)j=g[h],e.contains(j)&&d.add(j);else for(h=0,i=g.length;h<i;h+=1)d.add(g[h])}},l=function(a,b,c,e,f){e||(e=d.Set()),b.visit(function(b){k(a,b,c,e,f)});return e};f.getObjectsUnion=function(a,b,c,d){return l(f.spo,a,b,c,d)},f.getSubjectsUnion=function(a,b,c,d){return l(f.ops,a,b,c,d)};return f};var f={};d.View=function(b){var c,e=d.Set();if(typeof f[b.label]!="undefined")return f[b.label];c=fluid.initView("MITHGrid.Data.View",a(window),b),c.registerFilter=function(a){c.events.onFilterItem.addListener(function(b,c){return a.eventFilterItem(b,c)}),c.events.onModelChange.addListener(function(b,c){a.eventModelChange(b,c)}),a.events.onFilterChange.addListener(c.eventFilterChange)},c.registerView=function(a){c.events.onModelChange.addListener(function(b,c){a.eventModelChange(b,c)}),c.filterItems(function(){a.eventModelChange(c,c.items())})},c.items=e.items,c.size=e.size,c.filterItems=function(a){var b,f,g,h,i,j;e=d.Set(),c.items=e.items,c.size=e.size,g=c.dataSource.items(),h=g.length;h===0?a():(i=parseInt(h/100,10),i>200&&(i=200),i<1&&(i=1),j=function(d){var f,k;k=d+i,k>h&&(k=h);for(f=d;f<k;f+=1)b=g[f],free=c.events.onFilterItem.fire(c.dataSource,b),free!==!1&&e.add(b);k<h?setTimeout(function(){j(k)},0):a&&setTimeout(a,0)},j(0))},c.eventModelChange=function(a,b){c.filterItems(function(){c.events.onModelChange.fire(c,b)})},c.eventFilterChange=c.eventModelChange,c.dataSource=d.Source({source:b.source}),c.getItems=c.dataSource.getItems,c.getItem=c.dataSource.getItem,c.updateItems=c.dataSource.updateItems,c.prepare=c.dataSource.prepare,c.evaluate=c.dataSource.evaluate,c.addType=c.dataSource.addType,c.addProperty=c.dataSource.addProperty,c.dataSource.events.onModelChange.addListener(c.eventModelChange);return c};var g=b.namespace("Expression");g.Controls={"if":{f:function(a,b,c,d,e){var f=a[0].evaluate(b,c,d,e),g=!1;f.forEachValue(function(a){if(a){g=!0;return!0}});return g?a[1].evaluate(b,c,d,e):a[2].evaluate(b,c,d,e)}},foreach:{f:function(a,b,c,d,e){var f=a[0].evaluate(b,c,d,e),h=b.value,i=c.value,j=[],k="text",l;c.value=f.valueType,f.forEachValue(function(f){b.value=f,l=a[1].evaluate(b,c,d,e),k=l.valueType,l.forEachValue(function(a){j.push(a)})}),b.value=h,c.value=i;return g.Collection(j,k)}},"default":{f:function(a,b,c,d,e){var f,h,i;for(f=0,h=a.length;f<h;f++){i=a[f].evaluate(b,c,d,e);if(i.size()>0)return i}return g.Collection([],"text")}}},g.Expression=function(a){var b={};b.evaluate=function(b,c,d,e){var f=a.evaluate(b,c,d,e);return{values:f.getSet(),valueType:f.valueType,size:f.size()}},b.evaluateOnItem=function(a,b){return this.evaluate({value:a},{value:"item"},"value",b)},b.evaluateSingle=function(b,c,d,e){var f=a.evaluate(b,c,d,e),g={value:null,valueType:f.valueType};f.forEachValue(function(a){g.value=a;return!0});return g},b.isPath=a.isPath,b.getPath=b.isPath?function(){return a}:function(){return null},b.testExists=b.isPath?function(b,c,d,e){return a.testExists(b,c,d,e)}:function(a,c,d,e){return b.evaluate(a,c,d,e).values.size()>0},b.evaluateBackward=function(b,c,d,e){return a.walkBackward([b],c,d,e)},b.walkForward=function(b,c,d){return a.walkForward(b,c,d)},b.walkBackward=function(b,c,d,e){return a.walkBackward(b,c,d,e)};return b},g.Collection=function(a,c){var d={valueType:c};a instanceof Array?(d.forEachValue=function(b){var c=a,d,e;for(d=0,e=c.length;d<e;d++)if(b(c[d])===!0)break},d.getSet=function(){return b.Data.Set(a)},d.contains=function(b){var c=a,d,e;for(d=0,e=c.length;d<e;d++)if(c[d]==b)return!0;return!1},d.size=function(){return a.length}):(d.forEachValue=function(b){return a.visit(b)},d.getSet=function(){return a},d.contains=function(b){return a.contains(b)},d.size=a.size),d.isPath=!1;return d},g.Constant=function(a,b){var c={};c.evaluate=function(c,d,e,f){return g.Collection([a],b)},c.isPath=!1;return c};var h={"+":{argumentType:"number",valueType:"number",f:function(a,b){return a+b}},"-":{argumentType:"number",valueType:"number",f:function(a,b){return a-b}},"*":{argumentType:"number",valueType:"number",f:function(a,b){return a*b}},"/":{argumentType:"number",valueType:"number",f:function(a,b){return a/b}},"=":{valueType:"boolean",f:function(a,b){return a==b}},"<>":{valueType:"boolean",f:function(a,b){return a!=b}},"><":{valueType:"boolean",f:function(a,b){return a!=b}},"<":{valueType:"boolean",f:function(a,b){return a<b}},">":{valueType:"boolean",f:function(a,b){return a>b}},"<=":{valueType:"boolean",f:function(a,b){return a<=b}},">=":{valueType:"boolean",f:function(a,b){return a>=b}}};g.Operator=function(a,b){var c={},d=a,e=b;c.evaluate=function(a,b,c,f){var i=[],j=[],k,l,m,n;for(k=0,l=e.length;k<l;k++)j.push(e[k].evaluate(a,b,c,f));m=h[d],n=m.f,m.argumentType=="number"?j[0].forEachValue(function(a){typeof a!="number"&&(a=parseFloat(a)),j[1].forEachValue(function(b){typeof b!="number"&&(b=parseFloat(b)),i.push(n(a,b))})}):j[0].forEachValue(function(a){j[1].forEachValue(function(b){i.push(n(a,b))})});return g.Collection(i,m.valueType)},c.isPath=!1;return c},g.FunctionCall=function(a,b){var c={},d=a,e=b;c.evaluate=function(a,b,c,f){var h=[],i,j;for(i=0,j=e.length;i<j;i++)h.push(e[i].evaluate(a,b,c,f));if(d in g.Functions)return g.Functions[d].f(h);throw new Error("No such function named "+d)},c.isPath=!1;return c},g.ControlCall=function(a,b){var c={},d=a,e=b;c.evaluate=function(a,b,c,f){return g.Controls[d].f(e,a,b,c,f)},c.isPath=!1;return c},g.Path=function(a,c){var d={},e=null,f=[];typeof a!="undefined"&&f.push({property:a,forward:c,isArray:!1}),d.isPath=!0,d.setRootName=function(a){e=a},d.appendSegment=function(a,b){f.push({property:a,forward:b.charAt(0)==".",isArray:b.length>1})},d.getSegment=function(a){var b;if(a<f.length){b=f[a];return{property:b.property,forward:b.forward,isArray:b.isArray}}return null},d.getLastSegment=function(){return d.getSegment(f.length-1)},d.getSegmentCount=function(){return f.length};var h=function(a,b){var c,d,e,h,i,j,k,l=function(c){var d=[];a.forEachValue(function(a){b.getObjects(a,c.property).visit(function(a){d.push(a)})});return d},m=function(c){var d=[];a.forEachValue(function(a){b.getSubjects(a,c.property).visit(function(a){d.push(a)})});return d};for(c=0,d=f.length;c<d;c++)e=f[c],e.isArray?(h=[],e.forward?(h=l(e),j=b.getProperty(e.property),i=j!==null?j.getValueType():"text"):(h=m(e),i="item"),a=g.Collection(h,i)):e.forward?(k=b.getObjectsUnion(a.getSet(),e.property),j=b.getProperty(e.property),i=j!==null?j.getValueType():"text",a=g.Collection(k,i)):(k=b.getSubjectsUnion(a.getSet(),e.property),a=g.Collection(k,"item"));return a},i=function(a,c,d){var e,h,i,j,k,l;c instanceof Array&&(c=b.Data.Set(c));for(e=f.length-1;e>=0;e--)h=f[e],h.isArray?(i=[],h.forward?(a.forEachValue(function(a){d.getSubjects(a,h.property).visit(function(a){(e>0||c===null||c.contains(a))&&i.push(a)})}),k=d.getProperty(h.property),j=k!==null?k.getValueType():"text"):(a.forEachValue(function(a){d.getObjects(a,h.property).visit(function(a){(e>0||c===null||c.contains(a))&&i.push(a)})}),j="item"),a=g.Collection(i,j)):h.forward?(l=d.getSubjectsUnion(a.getSet(),h.property,null,e===0?c:null),a=g.Collection(l,"item")):(l=d.getObjectsUnion(a.getSet(),h.property,null,e===0?c:null),k=d.getProperty(h.property),j=k!==null?k.getValueType():"text",a=g.Collection(l,j));return a};d.rangeBackward=function(c,d,e,g){var h=b.Data.Set(),i="item",j,k;if(f.length>0){j=f[f.length-1];if(j.forward)g.getSubjectsInRange(j.property,c,d,!1,h,f.length==1?e:null);else throw new Error("Last path of segment must be forward");for(k=f.length-2;k>=0;k--)j=f[k],j.forward?(h=g.getSubjectsUnion(h,j.property,null,k===0?e:null),i="item"):(h=g.getObjectsUnion(h,j.property,null,k===0?e:null),a=g.getProperty(j.property),i=a!==null?a.getValueType():"text")}return{valueType:i,values:h,count:h.size()}},d.evaluate=function(a,b,c,d){var f=e!==null?e:c,i=f in b?b[f]:"text",j=null,k;if(f in a){k=a[f],k.isSet||k instanceof Array?j=g.Collection(k,i):j=g.Collection([k],i);return h(j,d)}throw new Error("No such variable called "+f)},d.testExists=function(a,b,c,e){return d.evaluate(a,b,c,e).size()>0},d.evaluateBackward=function(a,b,c,d){var e=g.Collection([a],b);return i(e,c,d)},d.walkForward=function(a,b,c){return h(g.Collection(a,b),c)},d.walkBackward=function(a,b,c,d){return i(g.Collection(a,b),c,d)};return d},g.Parser=function(){var a={},b=function(a,b){var c=a.token(),d,e,f,h,i=g.Scanner,j=function(){a.next(),c=a.token()},k=function(){return c!==null?c.start:a.index()},l=function(){var a=g.Path(),b;while(c!==null&&c.type==i.PATH_OPERATOR){b=c.value,j();if(c!==null&&c.type==i.IDENTIFIER)a.appendSegment(c.value,b),j();else throw new Error("Missing property ID at position "+k())}return a},m=function(){var a=null,b;if(c===null)throw new Error("Missing factor at end of expression");switch(c.type){case i.NUMBER:a=g.Constant(c.value,"number"),j();break;case i.STRING:a=g.Constant(c.value,"text"),j();break;case i.PATH_OPERATOR:a=l();break;case i.IDENTIFIER:b=c.value,j();if(b in g.Controls){if(c===null||c.type!=i.DELIMITER||c.value!="(")throw new Error("Missing ( to start "+b+" at position "+k());j(),args=c!==null&&c.type==i.DELIMITER&&c.value==")"?[]:q(),a=g.ControlCall(b,args);if(c!==null&&c.type==i.DELIMITER&&c.value==")")j();else throw new Error("Missing ) to end "+b+" at position "+k())}else if(c!==null&&c.type==i.DELIMITER&&c.value=="("){j(),args=c!==null&&c.type==i.DELIMITER&&c.value==")"?[]:q(),a=g.FunctionCall(b,args);if(c!==null&&c.type==i.DELIMITER&&c.value==")")j();else throw new Error("Missing ) after function call "+b+" at position "+k())}else a=l(),a.setRootName(b);break;case i.DELIMITER:if(c.value=="("){j(),a=p();if(c!==null&&c.type==i.DELIMITER&&c.value==")"){j();break}throw new Error("Missing ) at position "+k())}throw new Error("Unexpected text "+c.value+" at position "+k());default:throw new Error("Unexpected text "+c.value+" at position "+k())}return a},n=function(){var a=m(),b;while(c!==null&&c.type==i.OPERATOR&&(c.value=="*"||c.value=="/"))b=c.value,j(),a=g.Operator(b,[a,m()]);return a},o=function(){var a=n(),b;while(c!==null&&c.type==i.OPERATOR&&(c.value=="+"||c.value=="-"))b=c.value,j(),a=g.Operator(b,[a,n()]);return a},p=function(){var a=o(),b;while(c!==null&&c.type==i.OPERATOR&&(c.value=="="||c.value=="<>"||c.value=="<"||c.value=="<="||c.value==">"||c.value==">="))b=c.value,j(),a=g.Operator(b,[a,o]);return a},q=function(){var a=[p()];while(c!==null&&c.type==i.DELIMITER&&c.value==",")j(),a.push(p());return a};if(b){d=q(),e=[];for(f=0,h=d.length;f<h;f++)e.push(g.Expression(d[f]));return e}return g.Expression(p())};a.parse=function(a,c,d){var e;c=c||0,d=d||{},e=g.Scanner(a,c);try{return b(e,!1)}finally{d.index=e.token()!==null?e.token().start:e.index()}};return a},g.Scanner=function(a,b){var c={},d=a+" ",e=a.length,f=b,h=null;c.token=function(){return h},c.index=function(){return f};var i=function(a){return"0123456789".indexOf(a)>=0};c.next=function(){var a,b,c,j;h=null;while(f<e&&" \t\r\n".indexOf(d.charAt(f))>=0)f++;if(f<e){a=d.charAt(f),b=d.charAt(f+1);if(".!".indexOf(a)<0)if("<>".indexOf(a)<0)if("+-*/=".indexOf(a)<0)if("()".indexOf(a)<0)if("\"'".indexOf(a)<0)if(i(a)){c=f;while(c<e&&i(d.charAt(c)))c+=1;if(c<e&&d.charAt(c)=="."){c+=1;while(c<e&&i(d.charAt(c)))c+=1}h={type:g.Scanner.NUMBER,value:parseFloat(d.substring(f,c)),start:f,end:c},f=c}else{c=f;while(c<e){j=d.charAt(c);if("(),.!@ \t".indexOf(j)<0)c+=1;else break}h={type:g.Scanner.IDENTIFIER,value:d.substring(f,c),start:f,end:c},f=c}else{c=f+1;while(c<e){if(d.charAt(c)==a&&d.charAt(c-1)!="\\")break;c+=1}if(c<e)h={type:g.Scanner.STRING,value:d.substring(f+1,c).replace(/\\'/g,"'").replace(/\\"/g,'"'),start:f,end:c+1},f=c+1;else throw new Error("Unterminated string starting at "+f)}else h={type:g.Scanner.DELIMITER,value:a,start:f,end:f+1},f+=1;else h={type:g.Scanner.OPERATOR,value:a,start:f,end:f+1},f+=1;else b=="="||"<>".indexOf(b)>=0&&a!=b?(h={type:g.Scanner.OPERATOR,value:a+b,start:f,end:f+2},f+=2):(h={type:g.Scanner.OPERATOR,value:a,start:f,end:f+1},f+=1);else b=="@"?(h={type:g.Scanner.PATH_OPERATOR,value:a+b,start:f,end:f+2},f+=2):(h={type:g.Scanner.PATH_OPERATOR,value:a,start:f,end:f+1},f+=1)}},c.next();return c},g.Scanner.DELIMITER=0,g.Scanner.NUMBER=1,g.Scanner.STRING=2,g.Scanner.IDENTIFIER=3,g.Scanner.OPERATOR=4,g.Scanner.PATH_OPERATOR=5,b.namespace("Presentation"),b.Presentation.initView=function(b,c,d){var e=fluid.initView("MITHGrid.Presentation."+b,c,d),f={};d=e.options,a(c).empty(),e.eventModelChange=function(a,b){var c;e.renderItems(a,b)},e.renderingFor=function(a){return f[a]},e.renderItems=function(a,b){n=b.length;var d=function(g){var h,i;if(g<n){h=n,n>200&&(h=g+parseInt(Math.sqrt(n),10)+1,h>n&&(h=n));for(i=g;i<h;i+=1){var j=b[i];item=a.getItem(j),item?f[j]?f[j].update(item):(lens=e.getLens(item),lens&&(f[j]=lens.render(c,e,a,b[i]))):f[j]&&f[j].remove()}e.finishDisplayUpdate(),setTimeout(function(){d(h)},0)}};e.startDisplayUpdate(),d(0)},e.startDisplayUpdate=function(){a(c).empty()},e.finishDisplayUpdate=function(){a("<div class='clear'></div>").appendTo(a(c))},e.selfRender=function(){e.startDisplayUpdate(),e.renderItems(e.options.source,e.options.source.items()),e.finishDisplayUpdate()},e.dataView=e.options.source,e.options.source.registerView(e);return e},b.Application=function(c){var d={presentation:{},dataSource:{},dataView:{}},e=[];d.ready=function(a){e.push(a)},"dataSources"in c&&a.each(c.dataSources,function(c,e){var f=b.Data.Source({source:e.label});d.dataSource[e.label]=f,f.addType("Item"),f.addProperty("label",{valueType:"text"}),f.addProperty("type",{valueType:"text"}),f.addProperty("id",{valueType:"text"}),"types"in e&&a.each(e.types,function(a,b){f.addType(b.label)}),"properties"in e&&a.each(e.properties,function(a,b){f.addProperty(b.label,b)})}),"dataViews"in c&&a.each(c.dataViews,function(a,c){var e=b.Data.View({source:c.dataSource,label:c.label});d.dataView[c.label]=e}),"presentations"in c&&d.ready(function(){a.each(c.presentations,function(b,c){var e=a.extend(!0,{},c.options),f=a(c.container);a.isArray(f)&&(f=f[0]),e.source=d.dataView[c.dataView];var g=c.type(f,e);d.presentation[c.label]=g,g.selfRender()})}),"plugins"in c&&d.ready(function(){a.each(c.plugins,function(b,c){var e=c.type(c);e!==undefined&&("dataView"in c&&(e.dataView=d.dataView[c.dataView],a.each(e.types(),function(a,b){e.dataView.addType(b)}),a.each(e.properties(),function(a,b){e.dataView.addProperty(b.label,b)})),a.each(e.presentations(),function(b,f){var g=a.extend(!0,{},f.options),h=a(f.container);a.isArray(h)&&(h=h[0]),"dataView"in f?g.source=d.dataView[f.dataView]:"dataView"in c&&(g.source=d.dataView[c.dataView]);var i=f.type(h,g);e.presentation[f.label]=i,i.selfRender()}))})}),a(document).ready(function(){a.each(e,function(a,b){b()}),d.ready=function(a){setTimeout(a,0)}});return d},b.namespace("Plugin"),b.Plugin.initPlugin=function(b,c){var d={options:c,presentation:{}},e=[];d.types=function(){return"types"in c?c.types:[]},d.properties=function(){return"properties"in c?c.properties:[]},d.presentations=function(){return"presentations"in c?c.presentations:[]},d.ready=function(a){e.push(a)},d.eventReady=function(b){a.each(e,function(a,c){c(b)}),d.ready=function(a){a(b)}};return d}})(jQuery,MITHGrid),fluid.defaults("MITHGrid.Data.Source",{events:{onModelChange:null,onBeforeLoading:null,onAfterLoading:null,onBeforeUpdating:null,onAfterUpdating:null}}),fluid.defaults("MITHGrid.Data.View",{events:{onModelChange:null,onFilterItem:"preventable"}});