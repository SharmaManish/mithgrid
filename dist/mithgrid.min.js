/*
 * mithgrid JavaScript Library v0.0.1
 *
 * Date: Mon Sep 26 11:37:29 2011 -0400
 *
 * (c) Copyright University of Maryland 2011.  All rights reserved.
 *
 * (c) Copyright Texas A&M University 2010.  All rights reserved.
 *
 * 2. Redistributions in binary form must reproduce the above copyright
 *    documentation and/or other materials provided with the distribution.
 *
 * 3. The name of the author may not be used to endorse or promote products
 *    derived from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
 * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
 * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
 * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 */
(function(){var a,b,c,d,e,f,g=Array.prototype.indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(this[b]===a)return b;return-1};a=(d=this.MITHGrid)!=null?d:this.MITHGrid={},b=(e=this.fluid)!=null?e:this.fluid={},c=(f=this.jQuery)!=null?f:this.jQuery={},function(a,c){var d,e,f,h,i,j;(typeof window!="undefined"&&window!==null?(j=window.console)!=null?j.log:void 0:void 0)!=null?c.debug=window.console.log:c.debug=function(){},c.error=function(){c.debug.call({},arguments);return{arguments:arguments}},h=function(a,b){var d;a[b]==null&&(d={namespace:function(a){return h(d,a)},debug:c.debug});return a[b]=d},c.namespace=function(a){return h(c,a)},e=c.namespace("Data"),e.initSet=function(a){var b,c,d,e,f,g,h,i;g={},d={},b=0,f=!0,e=[],g.isSet=!0,g.items=function(){var a;if(f){e=[];for(a in d)typeof a=="string"&&d[a]===!0&&e.push(a)}return e},g.add=function(a){if(d[a]==null){d[a]=!0,f=!0;return b+=1}},g.remove=function(a){if(d[a]!=null){delete d[a],f=!0;return b-=1}},g.visit=function(a){var b,c;c=[];for(b in d)if(a(b)===!0)break;return c},g.contains=function(a){return d[a]!=null},g.size=function(){return f?g.items().length:e.length};if(a instanceof Array)for(h=0,i=a.length;h<i;h++)c=a[h],g.add(c);return g},e.initType=function(a){var b;return b={name:a,custom:{}}},e.initProperty=function(a){var b;return b={name:a,getValueType:function(){var a;return(a=b.valueType)!=null?a:"text"}}},e.initStore=function(d){var f,h,i,j,k,l,m,n,o,p;l=!1,m=e.initSet(),p={},k={},n={},j={},i=function(a,b,c,d){var e,f,h;h=a[b],h==null&&(h={values:{},counts:{}},a[b]=h),e=h.values[c],f=h.counts[c],e==null&&(e=[],h.values[c]=e);if(f==null)f={},h.counts[c]=f;else if(g.call(e,d)>=0){f[d]+=1;return}e.push(d);return f[d]=1},h=function(a,b,c,d,e){var f,g,h,i,j,k,l,m,n;g=a[b];if(g!=null){f=g.values[c];if(f!=null){if(e!=null){m=[];for(i=0,k=f.length;i<k;i++)h=f[i],m.push(e.contains(h)?d.add(h):void 0);return m}n=[];for(j=0,l=f.length;j<l;j++)h=f[j],n.push(d.add(h));return n}}},f=function(a,b,c,d,f){d==null&&(d=e.initSet()),b.visit(function(b){return h(a,b,c,d,f)});return d},d!=null?d:d={},o=b.initView("MITHGrid.Data.initStore",a(window),d),o.items=m.items,o.contains=m.contains,o.addProperty=function(a,b){var c;c=e.initProperty(a),(b!=null?b.valueType:void 0)!=null&&(c.valueType=b.valueType,k[a]=c);return c},o.getProperty=function(a){var b;return(b=k[a])!=null?b:e.initProperty(a)},o.addType=function(a,b){var c;c=e.initType(a),p[a]=c;return c},o.getType=function(a){var b;return(b=p[a])!=null?b:e.initType(a)},o.getItem=function(a){var b,c;return(b=(c=n[a])!=null?c.values:void 0)!=null?b:{}},o.getItems=function(b){if(!a.isArray(b))return[o.getItem(b)];return a.map(b,function(a,b){return o.getItem(a)})},o.fetchData=function(b){return a.ajax({url:b,dataType:"json",success:function(a,b){return o.loadData(a)}})},o.updateItems=function(b){var c,d,e,f,g,h,k,l;e=[],g=function(b,c,d,e){var f,g,h,i;h=b[c];if(h!=null){f=h.values[d],g=h.counts[d];if(f==null||g==null)return;g[e]-=1;if(g[e]<1){i=a.inArray(e,f),i===0?f=f.slice(1,f.length):i===f.length-1?f=f.slice(0,i):i>0&&(f=f.slice(0,i).concat(f.slice(i+1,f.length)));return h.values[d]=f}}},f=function(a,b,c){i(n,a,b,c);return i(j,c,b,a)},h=function(a,b,c){g(n,a,b,c);return g(j,c,b,a)},l=function(b,c,d){var e,f,g,h,i,j,k,l,m,n;f=b.id,n=b.type,e=!1,g=function(a,b){var c,d,e;d=!0;if(a.length!==b.length)return!1;for(c=0,e=a.length;0<=e?c<e:c>e;0<=e?c++:c--)a[c]!==b[c]&&(d=!1);return d},l=function(a,b,c){var e,f,g,h;h=[];for(f=0,g=c.length;f<g;f++)e=c[f],h.push(d(a,b,e));return h},k=function(a,b,d){var e,f,g,h;h=[];for(f=0,g=d.length;f<g;f++)e=d[f],h.push(c(a,b,e));return h},a.isArray(f)&&(f=f[0]),a.isArray(n)&&(n=n[0]),i=o.getItem(f);for(j in b){h=b[j];if(typeof j!="string"||j==="id"||j==="type")continue;a.isArray(h)||(h=[h]),m=h.length,i[j]==null?(k(f,j,h),e=!0):g(h,i[j])||(e=!0,l(f,j,i[j]),k(f,j,h))}return e},o.events.onBeforeUpdating.fire(o),k=b.length,c=parseInt(k/100,10),c>200&&(c=200),c<1&&(c=1),d=function(a){var g,i,j;g=a+c,g>k&&(g=k);for(j=a;a<=g?j<g:j>g;a<=g?j++:j--)i=b[j],typeof i=="object"&&l(i,f,h)&&e.push(i.id);if(g<k)return setTimeout(function(){return d(g)},0);o.events.onAfterUpdating.fire(o);return o.events.onModelChange.fire(o,e)};return d(0)},o.loadItems=function(b,d){var e,f,g,h,k,l;g=[],h=function(a,b,c){i(n,a,b,c);return i(j,c,b,a)},k=function(b,d){var e,f,i,j,k,l;if(b.id==null)throw c.error("Item entry has no id: ",b);if(b.type==null)throw c.error("Item entry has no type: ",b);e=b.id,i=b.type,a.isArray(e)&&(e=e[0]),a.isArray(i)&&(i=i[0]),m.add(e),g.push(e),h(e,"type",i),h(e,"id",e),l=[];for(f in b){j=b[f];if(typeof f!="string")continue;l.push(function(){var b,c,d;if(f!=="id"&&f!=="type"){if(a.isArray(j)){d=[];for(b=0,c=j.length;b<c;b++)k=j[b],d.push(h(e,f,k));return d}if(j!=null)return h(e,f,j)}}())}return l},o.events.onBeforeLoading.fire(o),l=b.length,d!=null?(e=parseInt(l/100,10),e>200&&(e=200),e<1&&(e=1)):e=l,f=function(a){var c,h,i;c=a+e,c>l&&(c=l);for(i=a;a<=c?i<c:i>c;a<=c?i++:i--)h=b[i],typeof h=="object"&&k(h);return c<l?setTimeout(function(){return f(c)},0):setTimeout(function(){o.events.onAfterLoading.fire(o);return setTimeout(function(){o.events.onModelChange.fire(o,g);if(d!=null)return setTimeout(d,0)},0)},0)};return f(0)},o.prepare=function(a){var b,d;d=function(){var d,e,f;f=[];for(d=0,e=a.length;d<e;d++)b=a[d],f.push(c.Expression.initParser().parse(b));return f}();return{evaluate:function(a){var b,c,e,f,g;c=[],e=function(b){var d;d=b.evaluateOnItem(a,o);return c=c.concat(d.values.items())};for(f=0,g=d.length;f<g;f++)b=d[f],e(b);return c}}},o.getObjectsUnion=function(a,b,c,d){return f(n,a,b,c,d)},o.getSubjectsUnion=function(a,b,c,d){return f(j,a,b,c,d)};return o},e.initView=function(d){var f,h,i,j,k;i=b.initView("MITHGrid.Data.initView",a(window),d),h=e.initSet(),f=function(a){var b,c,d,f;h=e.initSet(),d=i.dataStore.items(),f=d.length;if(f===0)a();else{f>200?(b=parseInt(f/100,10),b>200&&(b=200)):b=f,b<1&&(b=1),c=function(e){var g,j,k,l;g=e+b,g>f&&(g=f);for(k=e;e<=g?k<g:k>g;e<=g?k++:k--)l=d[k],j=i.events.onFilterItem.fire(i.dataStore,l),j!==!1&&h.add(l);if(g<f)return setTimeout(function(){return c(g)},0);i.items=h.items,i.size=h.size,i.contains=h.contains;if(a!=null)return setTimeout(a,0)};return c(0)}},i.registerFilter=function(a){i.events.onFilterItem.addListener(function(b,c){return a.eventFilterItem(b,c)}),i.events.onModelChange.addListener(function(b,c){return a.eventModelChange(b,c)});return a.events.onFilterChange.addListener(i.eventFilterChange)},i.registerPresentation=function(a){i.events.onModelChange.addListener(function(b,c){return a.eventModelChange(b,c)});return f(function(){return a.eventModelChange(i,i.items())})},i.items=h.items,i.size=h.size,i.contains=h.contains,(d!=null?(j=d.types)!=null?j.length:void 0:void 0)>0&&function(a){return i.registerFilter({eventFilterItem:function(b,c){var d,e,f,h;d=b.getItem(c);if(d.type==null)return!1;for(f=0,h=a.length;f<h;f++){e=a[f];if(g.call(d.type,e)>=0)return}return!1},eventModelChange:function(a,b){},events:{onFilterChange:{addListener:function(a){}}}})}(d.types),(d!=null?(k=d.filters)!=null?k.length:void 0:void 0)>0&&function(a){var b,d,e;e=c.Expression.initParser(),d=function(){var c,d,f;f=[];for(c=0,d=a.length;c<d;c++)b=a[c],f.push(e.parse(b));return f}();return i.registerFilter({eventFilterItem:function(a,b){var c,e,f,g,h,i,j;for(g=0,i=d.length;g<i;g++){c=d[g],f=c.evaluateOnItem(b,a),f=f.values.items();for(h=0,j=f.length;h<j;h++){e=f[h];if(e!=="false")return}}return!1},eventModelChange:function(a,b){},events:{onFilterChange:{addListener:function(a){}}}})}(d.filters),(d!=null?d.collection:void 0)!=null&&i.registerFilter({eventFilterItem:d.collection,eventModelChange:function(a,b){},events:{onFilterChange:{addListener:function(a){}}}}),i.eventModelChange=function(a,b){var c;c=e.initSet(i.items());return f(function(){var a,d,f,g,h,j,k;a=e.initSet(),k=i.items();for(f=0,h=k.length;f<h;f++)d=k[f],c.add(d);for(g=0,j=b.length;g<j;g++)d=b[g],c.contains(d)&&a.add(d);if(a.size()>0)return i.events.onModelChange.fire(i,a.items())})},i.eventFilterChange=i.eventModelChange,i.dataStore=d.dataStore,i.getItems=i.dataStore.getItems,i.getItem=i.dataStore.getItem,i.fetchData=i.dataStore.fetchData,i.updateItems=i.dataStore.updateItems,i.loadItems=i.dataStore.loadItems,i.prepare=i.dataStore.prepare,i.addType=i.dataStore.addType,i.getType=i.dataStore.getType,i.addProperty=i.dataStore.addProperty,i.getProperty=i.dataStore.getProperty,i.getObjectsUnion=i.dataStore.getObjectsUnion,i.getSubjectsUnion=i.dataStore.getSubjectsUnion,i.dataStore.events.onModelChange.addListener(i.eventModelChange);return i},f=c.namespace("Expression"),i={"+":{argumentType:"number",valueType:"number",f:function(a,b){return a+b}},"-":{argumentType:"number",valueType:"number",f:function(a,b){return a-b}},"*":{argumentType:"number",valueType:"number",f:function(a,b){return a*b}},"/":{argumentType:"number",valueType:"number",f:function(a,b){return a/b}},"=":{valueType:"boolean",f:function(a,b){return a===b}},"<>":{valueType:"boolean",f:function(a,b){return a!==b}},"><":{valueType:"boolean",f:function(a,b){return a!==b}},"<":{valueType:"boolean",f:function(a,b){return a<b}},">":{valueType:"boolean",f:function(a,b){return a>b}},"<=":{valueType:"boolean",f:function(a,b){return a<=b}},">=":{valueType:"boolean",f:function(a,b){return a>=b}}},f.controls={"if":{f:function(a,b,c,d,e){var f,g;g=a[0].evaluate(b,c,d,e),f=!1,g.forEachValue(function(a){if(a){f=!0;return!0}});return f?a[1].evaluate(b,c,d,e):a[2].evaluate(b,c,d)}},foreach:{f:function(a,b,c,d,e){var g,h,i,j,k;g=a[0].evaluate(b,c,d,e),h=b.value,i=c.value,j=[],k="text",c.value=g.valueType,g.forEachValue(function(f){var g;b.value=f,g=a[1].evaluate(b,c,d,e),k=g.valueType;return g.forEachValue(function(a){return j.push(a)})}),b.value=h,c.value=i;return f.initCollection(j,k)}},"default":{f:function(a,b,c,d,e){var g,h,i,j;for(i=0,j=a.length;i<j;i++){g=a[i],h=g.evaluate(b,c,d,e);if(h.size()>0)return h}return f.initCollection([],"text")}}},f.initExpression=function(a){var b;b={},b.evaluate=function(b,c,d,e){var f;f=a.evaluate(b,c,d,e);return{values:f.getSet(),valueType:f.valueType,size:f.size}},b.evaluateOnItem=function(a,b){return this.evaluate({value:a},{value:"item"},"value",b)},b.evaluateSingle=function(b,c,d,e){var f,g;f=a.evaluate(b,c,d,e),g={value:null,valueType:f.valueType},f.forEachValue(function(a){g.value=a;return!0});return g},b.isPath=a.isPath,b.isPath?(b.getPath=function(){return a},b.testExists=function(b,c,d,e){return a.testExists(b,c,d,e)}):(b.getPath=function(){return null},b.testExists=function(a,c,d,e){return b.evaluate(a,c,d,e).values.size()>0}),b.evaluateBackward=function(b,c,d,e){return a.walkBackward([b],c,d,e)},b.walkForward=function(b,c,d){return a.walkForward(b,c,d)},b.walkBackward=function(b,c,d,e){return a.walkBackward(b,c,d,e)};return b},f.initCollection=function(a,b){var d;d={valueType:b},a instanceof Array?(d.forEachValue=function(b){var c,d,e,f;f=[];for(d=0,e=a.length;d<e;d++){c=a[d];if(b(c)===!0)break}return f},d.getSet=function(){return c.Data.initSet(a)},d.contains=function(b){return g.call(a,b)>=0},d.size=function(){return a.length}):(d.forEachValue=a.visit,d.size=a.size,d.getSet=function(){return a},d.contains=a.contains),d.isPath=!1;return d},f.initConstant=function(a,b){var c;c={},c.evaluate=function(c,d,e,g){return f.initCollection([a],b)},c.isPath=!1;return c},f.initOperator=function(a,b){var c,d,e;c={},e=a,d=b,c.evaluate=function(c,g,h,j){var k,l,m,n,o;m=[],b=[];for(n=0,o=d.length;n<o;n++)k=d[n],b.push(k.evaluate(c,g,h,j));a=i[e],l=a.f,a.argumentType==="number"?b[0].forEachValue(function(a){typeof a!="number"&&(a=parseFloat(a));return b[1].forEachValue(function(b){typeof b!="number"&&(b=parseFloat(b));return m.push(l(a,b))})}):b[0].forEachValue(function(a){return b[1].forEachValue(function(b){return m.push(l(a,b))})});return f.initCollection(m,a.valueType)},c.isPath=!1;return c},f.initFunctionCall=function(a,b){var c,d;c={},d=b,c.evaluate=function(c,e,g,h){var i,j,k,l;b=[];for(j=0,k=d.length;j<k;j++)i=d[j],b.push(i.evaluate(c,e,g,h));if(((l=f.functions[a])!=null?l.f:void 0)!=null)return f.functions[a].f(b);throw new Error("No such function named "+_name)},c.isPath=!1;return c},f.initControlCall=function(a,b){var c;c={},c.evaluate=function(c,d,e,g){return f.controls[a].f(b,c,d,e,g)},c.isPath=!1;return c},f.initPath=function(a,b){var d,e,g,h,i;d={},h=null,i=[],g=function(b,c){var d,e,g,h,j,k,l,m;g=function(a){var d;d=[],b.forEachValue(function(b){return c.getObjects(b,a.property).visit(function(a){return d.push(a)})});return d},e=function(a){var d;d=[],b.forEachValue(function(b){return c.getSubjects(b,a.property).visit(function(a){return d.push(a)})});return d};for(h=0,m=i.length;0<=m?h<m:h>m;0<=m?h++:h--)j=i[h],j.isMultiple?(d=[],j.forward?(d=g(j),a=c.getProperty(j.property),k=a!=null?a.getValueType():"text"):(d=e(j),k="item"),b=f.initCollection(d,k)):j.forward?(l=c.getObjectsUnion(b.getSet(),j.property),a=c.getProperty(j.property),k=a!=null?a.getValueType():"text",b=f.initCollection(l,k)):(l=c.getSubjectsUnion(b.getSet(),j.property),b=f.initCollection(l,"item"));return b},e=function(b,d,e){var g,h,j,k,l,m,n,o;j=function(a){var c;c=[],b.forEachValue(function(b){return e.getSubjects(b,a.property).visit(function(a){if(k>0||d==null||d.contains(a))return c.push(a)})});return c},h=function(a){var c;c=[],b.forEachValue(function(b){return e.getObjects(b,a.property).visit(function(a){if(k>0||d==null||d.contains(a))return c.push(a)})});return c},d instanceof Array&&(d=c.Data.initSet(d));for(k=o=i.length-1;o<=0?k<=0:k>=0;o<=0?k++:k--)l=i[k],l.isMultiple?(g=[],l.forward?(g=j(l),a=e.getProperty(l.property),m=a!=null?a.getValueType():"text"):(g=h(l),m="item"),b=f.initCollection(g,m)):l.forward?(n=e.getSubjectsUnion(b.getSet(),l.property,null,k===0?d:null),b=f.initCollection(n,"item")):(n=e.getObjectsUnion(b.getSet(),l.property,null,k===0?d:null),a=e.getProperty(l.property),m=a!=null?a.getValueType():"text",b=f.initCollection(n,m));return b},a!=null&&i.push({property:a,forward:b,isMultiple:!1}),d.isPath=!0,d.setRootName=function(a){return h=a},d.appendSegment=function(a,b){return i.push({property:a,forward:b[0]===".",isMultiple:b.length>1})},d.getSegment=function(a){var b;if(a<i.length){b=i[a];return{property:b.property,forward:b.forward,isMultiple:b.isMultiple}}return null},d.getLastSegment=function(){return d.getSegment(i.length-1)},d.getSegmentCount=function(){return i.length},d.rangeBackward=function(b,d,e,f){var g,h,j,k,l;j=c.Data.initSet(),k="item";if(i.length>0){h=i[i.length-1];if(h.forward)f.getSubjectsInRange(h.property,b,d,!1,j,i.length===1?e:null);else throw new Error("Last path of segment must be forward");for(g=l=i.length-2;l<=0?g<=0:g>=0;l<=0?g++:g--)h=i[g],h.forward?(j=f.getSubjectsUnion(j,h.property,null,g===0?e:null),k="item"):(j=f.getObjectsUnion(j,h.property,null,g===0?e:null),a=f.getPropertysegment.property,k=a!=null?a.getValueType():"text")}return{valueType:k,values:j,count:j.size()}},d.evaluate=function(a,b,c,d){var e,i,j,k;j=h!=null?h:c,k=b[j]!=null?b[j]:"text",e=null;if(a[j]!=null){i=a[j],i.isSet||i instanceof Array?e=f.initCollection(i,k):e=f.initCollection([i],k);return g(e,d)}throw new Error("No such variable called "+j)},d.testExists=function(a,b,c,e){return d.evaluate(a,b,c,e).size()>0},d.evaluateBackward=function(a,b,c,d){var g;g=f.initCollection([a],b);return e(g,c,d)},d.walkForward=function(a,b,c){return g(f.initCollection(a,b),c)},d.walkBackward=function(a,b,c,d){return e(f.initCollection(a,b),c,d)};return d},f.initParser=function(){var a,b;b={},a=function(a,b){var c,d,e,g,h,i,j,k,l,m,n,o,p,q,r;p=a.token(),c=f.initScanner,g=function(){a.next();return p=a.token()},j=function(){},m=function(){var a,b,d;b=j();while(p!=null&&p.type===c.OPERATOR&&((d=p.value)==="*"||d==="/"))a=p.value,g(),b=f.initOperator(a,[b,j()]);return b},l=function(){var a,b,d;b=m();while(p!=null&&p.type===c.OPERATOR&&((d=p.value)==="+"||d==="-"))a=p.value,g(),b=f.initOperator(a,[b,m()]);return b},h=function(){var a,b,d;a=l();while(p!=null&&p.type===c.OPERATOR&&((d=p.value)==="="||d==="<>"||d==="<"||d===">"||d==="<="||d===">="))b=p.value,g(),a=f.initOperator(b,[a,l()]);return a},i=function(){var a;a=[h()];while(p!=null&&p.type===c.DELIMITER&&p.value===",")g(),a.push(h());return a},e=function(){return p!=null?p.start:a.index()},k=function(){var a,b;b=f.initPath();while(p!=null&&p.type===c.PATH_OPERATOR){a=p.value,g();if(p!=null&&p.type===c.IDENTIFIER)b.appendSegment(p.value,a),g();else throw new Error("Missing property ID at position "+e())}return b},j=function(){var a,b,d;d=null,a=[];if(p==null)throw new Error("Missing factor at end of expression");switch(p.type){case c.NUMBER:d=f.initConstant(p.value,"number"),g();break;case c.STRING:d=f.initConstant(p.value,"text"),g();break;case c.PATH_OPERATOR:d=k();break;case c.IDENTIFIER:b=p.value,g();if(f.controls[b]!=null){if(p==null||p.type!==c.DELIMITER||p.value!=="(")throw new Error("Missing ( to start "+b+" at position "+e());g(),p!=null&&p.type===c.DELIMITER&&p.value===")"?a=[]:a=i(),d=f.initControlCall(b,a);if(p!=null&&p.type===c.DELIMITER&&p.value===")")g();else throw new Error("Missing ) to end "+b+" at position "+e())}else if(p!=null&&p.type===c.DELIMITER&&p.value==="("){g(),p!=null&&p.type===c.DELIMITER&&p.value===")"?a=[]:a=i(),d=f.initFunctionCall(b,a);if(p!=null&&p.type===c.DELIMITER&&p.value===")")g();else throw new Error("Missing ) after function call "+b+" at position "+e())}else d=k(),d.setRootName(b);break;case c.DELIMITER:if(p.value!=="(")throw new Error("Unexpected text "+p.value+" at position "+e());g(),d=h();if(p!=null&&p.type===c.DELIMITER&&p.value===")")g();else throw new Error("Missing ) at position "+e());break;default:throw new Error("Unexpected text "+p.value+" at position "+e())}return d};if(b){o=i(),d=[];for(q=0,r=o.length;q<r;q++)n=o[q],d.push(f.initExpression(n));return d}return[f.initExpression(h())]},b.parse=function(b,c,d){var e;c!=null?c:c=0,d!=null?d:d={},e=f.initScanner(b,c);try{return a(e,!1)[0]}finally{d.index=e.token()!=null?e.token().start:e.index()}};return b},f.initScanner=function(a,b){var c,d,e,g,h,i;d={},h=a+" ",g=a.length,e=b,i=null,c=function(a){return"0123456789".indexOf(a)>=0},d.token=function(){return i},d.index=function(){return e},d.next=function(){var a,b,d,j;i=null;while(e<g&&" \t\r\n".indexOf(h.charAt(e))>=0)e+=1;if(e<g){b=h.charAt(e),d=h.charAt(e+1);if(".!".indexOf(b)<0){if("<>".indexOf(b)<0){if("+-*/=".indexOf(b)<0){if("()".indexOf(b)<0){if("\"'".indexOf(b)<0){if(c(b)){j=e;while(j<g&&c(h.charAt(j)))j+=1;if(j<g&&h.charAt(j)==="."){j+=1;while(j<g&&c(h.charAt(j)))j+=1}i={type:f.initScanner.NUMBER,value:parseFloat(h.substring(e,j)),start:e,end:j};return e=j}j=e;while(j<g){a=h.charAt(j);if("(),.!@ \t".indexOf(a)>=0)break;j+=1}i={type:f.initScanner.IDENTIFIER,value:h.substring(e,j),start:e,end:j};return e=j}j=e+1;while(j<g){if(h.charAt(j)===b&&h.charAt(j-1)!=="\\")break;j+=1}if(j<g){i={type:f.initScanner.STRING,value:h.substring(e+1,j).replace(/\\'/g,"'").replace(/\\"/g,'"'),start:e,end:j+1};return e=j+1}throw new Error("Unterminated string starting at "+String(e))}i={type:f.initScanner.DELIMITER,value:b,start:e,end:e+1};return e+=1}i={type:f.initScanner.OPERATOR,value:b,start:e,end:e+1};return e+=1}if(d==="="||"<>".indexOf(d)>=0&&b!==d){i={type:f.initScanner.OPERATOR,value:b+d,start:e,end:e+2};return e+=2}i={type:f.initScanner.OPERATOR,value:b,start:e,end:e+1};return e+=1}if(d==="@"){i={type:f.initScanner.PATH_OPERATOR,value:b+d,start:e,end:e+2};return e+=2}i={type:f.initScanner.PATH_OPERATOR,value:b,start:e,end:e+1};return e+=1}},d.next();return d},f.initScanner.DELIMITER=0,f.initScanner.NUMBER=1,f.initScanner.STRING=2,f.initScanner.IDENTIFIER=3,f.initScanner.OPERATOR=4,f.initScanner.PATH_OPERATOR=5,f.functions={},f.FunctionUtilities={},f.FunctionUtilities.registerSimpleMappingFunction=function(a,b,d){return f.functions[a]={f:function(a){var e,g,h,i,j;h=c.Data.initSet(),g=function(a){return a.forEachValue(function(a){var c;c=b(a);if(c!=null)return h.add(c)})};for(i=0,j=a.length;i<j;i++)e=a[i],g(e);return f.initCollection(h,d)}}},c.namespace("Presentation"),c.Presentation.initPresentation=function(c,d,e){var f,g,h;h=b.initView("MITHGrid.Presentation."+c,d,e),g={},f=h.options.lenses,e=h.options,a(d).empty(),h.getLens=function(a){if(a.type!=null&&a.type[0]!=null&&f[a.type[0]]!=null)return{render:f[a.type[0]]}},h.renderingFor=function(a){return g[a]},h.renderItems=function(a,b){var c,e;e=b.length,c=function(f){var i,j,k,l,m;if(f<e){i=e,e>200&&(i=f+parseInt(Math.sqrt(e),10)+1,i>e&&(i=e));for(k=f;f<=i?k<i:k>i;f<=i?k++:k--)l=b[k],j=a.contains(l),j?g[l]!=null?g[l].update(a.getItem(l)):(m=h.getLens(a.getItem(l)),m!=null&&(g[l]=m.render(d,h,a,l))):g[l]!=null&&(g[l].remove(),delete g[l]);return setTimeout(function(){return c(i)},0)}return h.finishDisplayUpdate()},h.startDisplayUpdate();return c(0)},h.eventModelChange=h.renderItems,h.startDisplayUpdate=function(){},h.finishDisplayUpdate=function(){},h.selfRender=function(){return h.renderItems(h.dataView,h.dataView.items())},h.dataView=h.options.dataView,h.dataView.registerPresentation(h);return h},d=c.namespace("Application"),d.initApp=function(d,e,f){var g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w;m=b.initView(d,e,f),h=[],m.presentation={},m.dataStore={},m.dataView={},f=m.options,m.ready=function(a){return h.push(a)};if((f!=null?f.dataStores:void 0)!=null){t=f.dataStores;for(l in t){g=t[l],m.dataStore[l]==null?(k=c.Data.initStore(),m.dataStore[l]=k,k.addType("Item"),k.addProperty("label",{valueType:"text"}),k.addProperty("type",{valueType:"text"}),k.addProperty("id",{valueType:"text"})):k=m.dataStore[l];if((g!=null?g.types:void 0)!=null){u=g.types;for(n in u)o=u[n],k.addType(n)}if((g!=null?g.properties:void 0)!=null){v=g.properties;for(i in v)j=v[i],k.addProperty(i,j)}}}if((f!=null?f.dataViews:void 0)!=null){w=f.dataViews;for(r in w)q=w[r],s={dataStore:m.dataStore[q.dataStore],label:r},m.dataView[r]==null&&(q.collection!=null&&(s.collection=q.collection),q.types!=null&&(s.types=q.types),q.filters!=null&&(s.filters=q.filters),p=c.Data.initView(s),m.dataView[r]=p)}(f!=null?f.viewSetup:void 0)!=null&&(a.isFunction(f.viewSetup)?m.ready(function(){return f.viewSetup(a(e))}):m.ready(function(){return a(e).append(f.viewSetup)})),(f!=null?f.presentations:void 0)!=null&&m.ready(function(){var b,c,d,g,h,i,j;i=f.presentations,j=[];for(b in i)c=i[b],g=a.extend(!0,{},c),d=a("#"+a(e).attr("id")+" > "+c.container),a.isArray(e)&&(d=d[0]),g.dataView=m.dataView[c.dataView],g.application=m,h=c.type.initPresentation(d,g),m.presentation[b]=h,j.push(h.selfRender());return j}),(f!=null?f.plugins:void 0)!=null&&m.ready(function(){var b,c,d,g,h,i,j,k,l,n,o,p,q,r,s;r=f.plugins,s=[];for(p=0,q=r.length;p<q;p++)b=r[p],d=b.type.initPlugin(b),s.push(function(){var f,p,q,r;if(d!=null){if((b!=null?b.dataView:void 0)!=null){d.dataView=m.dataView[b.dataView],f=d.getTypes();for(n in f)o=f[n],d.dataView.addType(n);p=d.getProperties();for(j in p)k=p[j],d.dataView.addProperty(j,k)}q=d.getPresentations(),r=[];for(g in q)h=q[g],l=a.extend(!0,{},h.options),c=a("#"+a(e).attr("id")+" > "+h.container),(h!=null?h.lenses:void 0)!=null&&(l.lenses=h.lenses),a.isArray(c)&&(c=c[0]),h.dataView!=null?l.dataView=m.dataView[h.dataView]:b.dataView!=null&&(l.dataView=m.dataView[b.dataView]),l.application=m,i=h.type.initPresentation(c,l),d.presentation[g]=i,r.push(i.selfRender());return r}}());return s}),m.run=function(){return a(document).ready(function(){var a,b,c;for(b=0,c=h.length;b<c;b++)a=h[b],a();h=[];return m.ready=function(a){return setTimeout(a,0)}})};return m},c.namespace("Plugin");return c.Plugin.initPlugin=function(a,b){var c,d;d={options:b,presentation:{}},c=[],d.getTypes=function(){return(b!=null?b.types:void 0)!=null?b.types:[]},d.getProperties=function(){return(b!=null?b.properties:void 0)!=null?b.properties:[]},d.getPresentations=function(){return(b!=null?b.presentations:void 0)!=null?b.presentations:[]},d.ready=c.push,d.eventReady=function(a){var b,e,f;for(e=0,f=c.length;e<f;e++)b=c[e],b(a);c=[];return d.ready=function(b){return b(a)}};return d}}(c,a),b.defaults("MITHGrid.Data.initStore",{events:{onModelChange:null,onBeforeLoading:null,onAfterLoading:null,onBeforeUpdating:null,onAfterUpdating:null}}),b.defaults("MITHGrid.Data.initView",{events:{onModelChange:null,onFilterItem:"preventable"}})}).call(this);