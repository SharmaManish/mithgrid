/*
 * mithgrid JavaScript Library v0.0.1
 *
 * Date: Sat Jul 2 16:49:46 2011 -0400
 *
 * (c) Copyright University of Maryland 2011.  All rights reserved.
 *
 * (c) Copyright Texas A&M University 2010.  All rights reserved.
 *
 * Portions of this code are copied from The SIMILE Project:
 *  (c) Copyright The SIMILE Project 2006. All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions
 * are met:
 *
 * 1. Redistributions of source code must retain the above copyright
 *    notice, this list of conditions and the following disclaimer.
 *
 * 2. Redistributions in binary form must reproduce the above copyright
 *    notice, this list of conditions and the following disclaimer in the
 *    documentation and/or other materials provided with the distribution.
 *
 * 3. The name of the author may not be used to endorse or promote products
 *    derived from this software without specific prior written permission.
 *
 * THIS SOFTWARE IS PROVIDED BY THE AUTHOR ``AS IS'' AND ANY EXPRESS OR
 * IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES
 * OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE DISCLAIMED.
 * IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY DIRECT, INDIRECT,
 * INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT
 * NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,
 * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY
 * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT
 * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE OF
 * THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.
 *
 */
var MITHGrid=MITHGrid||{};(function(a,b){window.console!==undefined&&window.console.log!==undefined?b.debug=function(){console.log(Array.prototype.slice.call(arguments))}:b.debug=function(){};var c=function(a,d){typeof a[d]=="undefined"&&(a[d]={},a[d].namespace=function(b){return c(a[d],b)},a[d].debug=b.debug);return a[d]};b.namespace=function(a){return c(b,a)},b.Set=function(b){var c={},d={},e=0,f=!0,g=[];c.isSet=!0,c.items=function(){if(f){g=[];for(var a in d)typeof a=="string"&&d[a]===!0&&g.push(a)}return g},c.add=function(a){a in d||(d[a]=!0,f=!0,e+=1)},c.remove=function(a){a in d&&(delete d[a],f=!0,e-=1)},c.visit=function(a){var b;for(b in d)if(a(b)===!0)break},c.contains=function(a){return a in d},c.size=function(){return f?c.items().length:g.length},b instanceof Array&&a(b).each(function(a,b){c.add(b)});return c},b.Type=function(a){var b={};b.name=a,b.custom={};return b},b.Property=function(a){var b={};b.name=a,b.getValueType=function(){return b.valueType||"text"};return b};var d={};b.DataSource=function(c){var e,f,g=!1,h=b.Set();if(typeof d[c.source]!="undefined")return d[c.source];e=fluid.initView("MITHGrid.DataSource",a(window),c),d[c.source]=e,e.source=c.source,e.types={},e.properties={},e.spo={},e.ops={},e.items=h.items,e.addProperty=function(a,c){var d=b.Property(a);d.valueType=c.valueType,e.properties[a]=d},e.addType=function(a,c){var d=b.Type(a);e.types[a]=d},e.getItem=function(a){if(a in e.spo)return e.spo[a].values;return{}},e.getItems=function(b){if(!a.isArray(b))return[e.getItem(b)];a.map(b,function(a,b){return e.getItem(a)})},e.fetchData=function(b){a.ajax({url:b,dataType:"json",success:function(a,b){e.loadData(a)}})};var i=function(b,c,d,e){var f=b[c],g,h,i,j;f||(f={values:{},counts:{}},b[c]=f),g=f.values[d],h=f.counts[d],g||(g=[],f.values[d]=g);if(!h)h={},f.counts[d]=h;else if(a.inArray(e,g)!=-1){h[e]+=1;return}g.push(e),h[e]=1};e.updateItems=function(c){var d,f,g,h,j,k,l=[],m,n=function(b,c,d,e){var f=b[c],g,h,i,j;if(!!f){g=f.values[d],h=f.counts[d];if(!g)return;if(!h)return;h[e]-=1,h[e]<1&&(i=a.inArray(e,g),i===0?g=g.slice(1):i==g.length-1?g=g.slice(0,i-1):g=g.slice(0,i-1).concat(g.slice(i+1)),f.values[d]=g)}},o=function(a,b,c){i(e.spo,a,b,c),i(e.ops,c,b,a)},p=function(a,b,c){n(e.spo,a,b,c),n(e.ops,c,b,a)},q=function(b,c,d){var f,g=item.id,h=item.type,i=!1;a.isArray(g)&&(g=g[0]),a.isArray(h)&&(h=h[0]),f=e.getItem(g);for(var j in b){if(typeof j!="string"||j=="id"||j=="type")continue;var k=b[j];a.isArray(k)||(k=[k]);var l=k.length;if(j in f&&l==f[j].length){var m=!0;a.each(k,function(a,b){b!=f[j][a]&&(m=!1)});if(m)continue}i=!0,j in f&&a.each(f[j],function(a,b){d(g,j,b)}),a.each(k,function(a,b){c(g,j,b)})}return i};e.events.onBeforeUpdating.fire(e);try{h=c.length,j=parseInt(h/100,10),j>200&&(j=200),j<1&&(j=1),k=function(a){var d,f;d=a+j,d>h&&(d=h);try{for(f=a;f<d;f+=1)m=c[f],typeof m=="object"&&q(m,o,p)&&l.push(m.id)}catch(g){b.debug("loadData failed: ",g)}d<h?setTimeout(function(){k(d)},0):setTimeout(function(){e.events.onAfterUpdating.fire(e),setTimeout(function(){e.events.onModelChange.fire(e,l)},0)},0)},k(0)}catch(r){b.debug("updateItems failed:",r)}},e.loadItems=function(c){var d,f,g,j,k,l=[],m,n=function(a,b,c){i(e.spo,a,b,c),i(e.ops,c,b,a)},o=function(c,d){var e,f,g,i,j;if("id"in c){if(!("type"in c)){b.debug("Item entry has no type: ",c);return}e=c.id,f=c.type,a.isArray(e)&&(e=e[0]),a.isArray(f)&&(f=f[0]),h.add(e),l.push(e),n(e,"type",f),n(e,"id",e);for(g in c){if(typeof g!="string")continue;if(g!="id"&&g!="type"){v=c[g];if(a.isArray(v))for(i=0,j=v.length;i<j;i+=1)n(e,g,v[i]);else v!==undefined&&v!==null&&n(e,g,v)}}}else b.debug("Item entry has no id: ",c)};e.events.onBeforeLoading.fire(e);try{k=c.length,chunk_size=parseInt(k/100,10),chunk_size>200&&(chunk_size=200),chunk_size<1&&(chunk_size=1),m=function(a){var d,f;d=a+chunk_size,d>k&&(d=k);try{for(f=a;f<d;f+=1)j=c[f],typeof j=="object"&&o(j)}catch(g){b.debug("loadData failed: ",g)}d<k?setTimeout(function(){m(d)},0):setTimeout(function(){e.events.onAfterLoading.fire(e),setTimeout(function(){e.events.onModelChange.fire(e,l)},0)},0)},m(0)}catch(p){b.debug("loadData failed: ",p)}},e.prepare=function(c){return a.map(c,function(a){return b.ExpressionParser().parse(a)})},e.evaluate=function(b,c){var d=[];a.each(c,function(a,c){var f=c.evaluateOnItem(b,e);d=d.concat(f.values.items())});return d};var j=function(a,b,c,d,e){var f=a[b],g,h,i,j;if(f){g=f.values[c];if(g)if(e)for(h=0,i=g.length;h<i;h+=1)j=g[h],e.contains(j)&&d.add(j);else for(h=0,i=g.length;h<i;h+=1)d.add(g[h])}},k=function(a,c,d,e,f){e||(e=b.Set()),c.visit(function(b){j(a,b,d,e,f)});return e};e.getObjectsUnion=function(a,b,c,d){return k(e.spo,a,b,c,d)},e.getSubjectsUnion=function(a,b,c,d){return k(e.ops,a,b,c,d)};return e};var e={};b.DataView=function(c){var d,f=b.Set();if(typeof e[c.label]!="undefined")return e[c.label];d=fluid.initView("MITHGrid.DataView",a(window),c),d.registerFilter=function(a){d.events.onFilterItem.addListener(function(b,c){return a.eventFilterItem(b,c)}),d.events.onModelChange.addListener(function(b,c){a.eventModelChange(b,c)}),a.events.onFilterChange.addListener(d.eventFilterChange)},d.registerView=function(a){d.events.onModelChange.addListener(function(b,c){a.eventModelChange(b,c)}),d.filterItems(function(){a.eventModelChange(d,d.items())})},d.items=f.items,d.size=f.size,d.filterItems=function(a){var c,e,g,h,i,j;f=b.Set(),d.items=f.items,d.size=f.size,g=d.dataSource.items(),h=g.length;h===0?a():(i=parseInt(h/100,10),i>200&&(i=200),i<1&&(i=1),j=function(b){var e,k;k=b+i,k>h&&(k=h);for(e=b;e<k;e+=1)c=g[e],free=d.events.onFilterItem.fire(d.dataSource,c),free!==!1&&f.add(c);k<h?setTimeout(function(){j(k)},0):a&&setTimeout(a,0)},j(0))},d.eventModelChange=function(a,b){d.filterItems(function(){d.events.onModelChange.fire(d,b)})},d.eventFilterChange=d.eventModelChange,d.dataSource=b.DataSource({source:c.source}),d.getItems=d.dataSource.getItems,d.getItem=d.dataSource.getItem,d.updateItems=d.dataSource.updateItems,d.prepare=d.dataSource.prepare,d.evaluate=d.dataSource.evaluate,d.dataSource.events.onModelChange.addListener(d.eventModelChange);return d},b.Controls={"if":{f:function(a,b,c,d,e){var f=a[0].evaluate(b,c,d,e),g=!1;f.forEachValue(function(a){if(a){g=!0;return!0}});return g?a[1].evaluate(b,c,d,e):a[2].evaluate(b,c,d,e)}},foreach:{f:function(a,c,d,e,f){var g=a[0].evaluate(c,d,e,f),h=c.value,i=d.value,j=[],k="text",l;d.value=g.valueType,g.forEachValue(function(b){c.value=b,l=a[1].evaluate(c,d,e,f),k=l.valueType,l.forEachValue(function(a){j.push(a)})}),c.value=h,d.value=i;return b.Expression.Collection(j,k)}},"default":{f:function(a,c,d,e,f){var g,h,i;for(g=0,h=a.length;g<h;g++){i=a[g].evaluate(c,d,e,f);if(i.size()>0)return i}return b.Expression.Collection([],"text")}}},b.Expression=function(a){var b={};b.evaluate=function(b,c,d,e){var f=a.evaluate(b,c,d,e);return{values:f.getSet(),valueType:f.valueType,size:f.size()}},b.evaluateOnItem=function(a,b){return this.evaluate({value:a},{value:"item"},"value",b)},b.evaluateSingle=function(b,c,d,e){var f=a.evaluate(b,c,d,e),g={value:null,valueType:f.valueType};f.forEachValue(function(a){g.value=a;return!0});return g},b.isPath=a.isPath,b.getPath=b.isPath?function(){return a}:function(){return null},b.testExists=b.isPath?function(b,c,d,e){return a.testExists(b,c,d,e)}:function(a,c,d,e){return b.evaluate(a,c,d,e).values.size()>0},b.evaluateBackward=function(b,c,d,e){return a.walkBackward([b],c,d,e)},b.walkForward=function(b,c,d){return a.walkForward(b,c,d)},b.walkBackward=function(b,c,d,e){return a.walkBackward(b,c,d,e)};return b},b.Expression.Collection=function(a,c){var d={valueType:c};a instanceof Array?(d.forEachValue=function(b){var c=a,d,e;for(d=0,e=c.length;d<e;d++)if(b(c[d])===!0)break},d.getSet=function(){return b.Set(a)},d.contains=function(b){var c=a,d,e;for(d=0,e=c.length;d<e;d++)if(c[d]==b)return!0;return!1},d.size=function(){return a.length}):(d.forEachValue=function(b){return a.visit(b)},d.getSet=function(){return a},d.contains=function(b){return a.contains(b)},d.size=a.size),d.isPath=!1;return d},b.Expression.Constant=function(a,c){var d={};d.evaluate=function(d,e,f,g){return b.Expression.Collection([a],c)},d.isPath=!1;return d};var f={"+":{argumentType:"number",valueType:"number",f:function(a,b){return a+b}},"-":{argumentType:"number",valueType:"number",f:function(a,b){return a-b}},"*":{argumentType:"number",valueType:"number",f:function(a,b){return a*b}},"/":{argumentType:"number",valueType:"number",f:function(a,b){return a/b}},"=":{valueType:"boolean",f:function(a,b){return a==b}},"<>":{valueType:"boolean",f:function(a,b){return a!=b}},"><":{valueType:"boolean",f:function(a,b){return a!=b}},"<":{valueType:"boolean",f:function(a,b){return a<b}},">":{valueType:"boolean",f:function(a,b){return a>b}},"<=":{valueType:"boolean",f:function(a,b){return a<=b}},">=":{valueType:"boolean",f:function(a,b){return a>=b}}};b.Expression.Operator=function(a,c){var d={},e=a,g=c;d.evaluate=function(a,c,d,h){var i=[],j=[],k,l,m,n;for(k=0,l=g.length;k<l;k++)j.push(g[k].evaluate(a,c,d,h));m=f[e],n=m.f,m.argumentType=="number"?j[0].forEachValue(function(a){typeof a!="number"&&(a=parseFloat(a)),j[1].forEachValue(function(b){typeof b!="number"&&(b=parseFloat(b)),i.push(n(a,b))})}):j[0].forEachValue(function(a){j[1].forEachValue(function(b){i.push(n(a,b))})});return b.Expression.Collection(i,m.valueType)},d.isPath=!1;return d},b.Expression.FunctionCall=function(a,c){var d={},e=a,f=c;d.evaluate=function(a,c,d,g){var h=[],i,j;for(i=0,j=f.length;i<j;i++)h.push(f[i].evaluate(a,c,d,g));if(e in b.Functions)return b.Functions[e].f(h);throw new Error("No such function named "+e)},d.isPath=!1;return d},b.Expression.ControlCall=function(a,c){var d={},e=a,f=c;d.evaluate=function(a,c,d,g){return b.Controls[e].f(f,a,c,d,g)},d.isPath=!1;return d},b.Expression.Path=function(a,c){var d={},e=null,f=[];typeof a!="undefined"&&f.push({property:a,forward:c,isArray:!1}),d.isPath=!0,d.setRootName=function(a){e=a},d.appendSegment=function(a,b){f.push({property:a,forward:b.charAt(0)==".",isArray:b.length>1})},d.getSegment=function(a){var b;if(a<f.length){b=f[a];return{property:b.property,forward:b.forward,isArray:b.isArray}}return null},d.getLastSegment=function(){return d.getSegment(f.length-1)},d.getSegmentCount=function(){return f.length};var g=function(a,c){var d,e,g,h,i,j,k;for(d=0,e=f.length;d<e;d++)g=f[d],g.isArray?(h=[],g.forward?(a.forEachValue(function(a){c.getObjects(a,g.property).visit(function(a){h.push(a)})}),j=c.getProperty(g.property),i=j!==null?j.getValueType():"text"):(a.forEachValue(function(a){c.getSubjects(a,g.property).visit(function(a){h.push(a)})}),i="item"),a=b.Expression.Collection(h,i)):g.forward?(k=c.getObjectsUnion(a.getSet(),g.property),j=c.getProperty(g.property),i=j!==null?j.getValueType():"text",a=b.Expression.Collection(k,i)):(k=c.getSubjectsUnion(a.getSet(),g.property),a=b.Expression.Collection(k,"item"));return a},h=function(a,c,d){var e,g,h,i,j,k;c instanceof Array&&(c=b.Set(c));for(e=f.length-1;e>=0;e--)g=f[e],g.isArray?(h=[],g.forward?(a.forEachValue(function(a){d.getSubjects(a,g.property).visit(function(a){(e>0||c===null||c.contains(a))&&h.push(a)})}),j=d.getProperty(g.property),i=j!==null?j.getValueType():"text"):(a.forEachValue(function(a){d.getObjects(a,g.property).visit(function(a){(e>0||c===null||c.contains(a))&&h.push(a)})}),i="item"),a=b.Expression.Collection(h,i)):g.forward?(k=d.getSubjectsUnion(a.getSet(),g.property,null,e===0?c:null),a=b.Expression.Collection(k,"item")):(k=d.getObjectsUnion(a.getSet(),g.property,null,e===0?c:null),j=d.getProperty(g.property),i=j!==null?j.getValueType():"text",a=b.Expression.Collection(k,i));return a};d.rangeBackward=function(c,d,e,g){var h=b.Set(),i="item",j,k;if(f.length>0){j=f[f.length-1];if(j.forward)g.getSubjectsInRange(j.property,c,d,!1,h,f.length==1?e:null);else throw new Error("Last path of segment must be forward");for(k=f.length-2;k>=0;k--)j=f[k],j.forward?(h=g.getSubjectsUnion(h,j.property,null,k===0?e:null),i="item"):(h=g.getObjectsUnion(h,j.property,null,k===0?e:null),a=g.getProperty(j.property),i=a!==null?a.getValueType():"text")}return{valueType:i,values:h,count:h.size()}},d.evaluate=function(a,c,d,f){var h=e!==null?e:d,i=h in c?c[h]:"text",j=null,k;if(h in a){k=a[h],k.isSet||k instanceof Array?j=b.Expression.Collection(k,i):j=b.Expression.Collection([k],i);return g(j,f)}throw new Error("No such variable called "+h)},d.testExists=function(a,b,c,e){return d.evaluate(a,b,c,e).size()>0},d.evaluateBackward=function(a,c,d,e){var f=b.Expression.Collection([a],c);return h(f,d,e)},d.walkForward=function(a,c,d){return g(b.Expression.Collection(a,c),d)},d.walkBackward=function(a,c,d,e){return h(b.Expression.Collection(a,c),d,e)};return d},b.ExpressionParser=function(){var a={},c=function(a,c){var d=a.token(),e,f,g,h,i=b.ExpressionScanner,j=function(){a.next(),d=a.token()},k=function(){return d!==null?d.start:a.index()},l=function(){var a=b.Expression.Path(),c;while(d!==null&&d.type==i.PATH_OPERATOR){c=d.value,j();if(d!==null&&d.type==i.IDENTIFIER)a.appendSegment(d.value,c),j();else throw new Error("Missing property ID at position "+k())}return a},m=function(){var a=null,c;if(d===null)throw new Error("Missing factor at end of expression");switch(d.type){case i.NUMBER:a=b.Expression.Constant(d.value,"number"),j();break;case i.STRING:a=b.Expression.Constant(d.value,"text"),j();break;case i.PATH_OPERATOR:a=l();break;case i.IDENTIFIER:c=d.value,j();if(c in b.Controls){if(d===null||d.type!=i.DELIMITER||d.value!="(")throw new Error("Missing ( to start "+c+" at position "+k());j(),args=d!==null&&d.type==i.DELIMITER&&d.value==")"?[]:q(),a=b.Expression.ControlCall(c,args);if(d!==null&&d.type==i.DELIMITER&&d.value==")")j();else throw new Error("Missing ) to end "+c+" at position "+k())}else if(d!==null&&d.type==i.DELIMITER&&d.value=="("){j(),args=d!==null&&d.type==i.DELIMITER&&d.value==")"?[]:q(),a=b.Expression.FunctionCall(c,args);if(d!==null&&d.type==i.DELIMITER&&d.value==")")j();else throw new Error("Missing ) after function call "+c+" at position "+k())}else a=l(),a.setRootName(c);break;case i.DELIMITER:if(d.value=="("){j(),a=p();if(d!==null&&d.type==i.DELIMITER&&d.value==")"){j();break}throw new Error("Missing ) at position "+k())}throw new Error("Unexpected text "+d.value+" at position "+k());default:throw new Error("Unexpected text "+d.value+" at position "+k())}return a},n=function(){var a=m(),c;while(d!==null&&d.type==i.OPERATOR&&(d.value=="*"||d.value=="/"))c=d.value,j(),a=b.Expression.Operator(c,[a,m()]);return a},o=function(){var a=n(),c;while(d!==null&&d.type==i.OPERATOR&&(d.value=="+"||d.value=="-"))c=d.value,j(),a=b.Expression.Operator(c,[a,n()]);return a},p=function(){var a=o(),c;while(d!==null&&d.type==i.OPERATOR&&(d.value=="="||d.value=="<>"||d.value=="<"||d.value=="<="||d.value==">"||d.value==">="))c=d.value,j(),a=b.Expression.Operator(c,[a,o]);return a},q=function(){var a=[p()];while(d!==null&&d.type==i.DELIMITER&&d.value==",")j(),a.push(p());return a};if(c){e=q(),f=[];for(g=0,h=e.length;g<h;g++)f.push(b.Expression(e[g]));return f}return b.Expression(p())};a.parse=function(a,d,e){var f;d=d||0,e=e||{},f=b.ExpressionScanner(a,d);try{return c(f,!1)}finally{e.index=f.token()!==null?f.token().start:f.index()}};return a},b.ExpressionScanner=function(a,c){var d={},e=a+" ",f=a.length,g=c,h=null;d.token=function(){return h},d.index=function(){return g};var i=function(a){return"0123456789".indexOf(a)>=0};d.next=function(){var a,c,d,j;h=null;while(g<f&&" \t\r\n".indexOf(e.charAt(g))>=0)g++;if(g<f){a=e.charAt(g),c=e.charAt(g+1);if(".!".indexOf(a)<0)if("<>".indexOf(a)<0)if("+-*/=".indexOf(a)<0)if("()".indexOf(a)<0)if("\"'".indexOf(a)<0)if(i(a)){d=g;while(d<f&&i(e.charAt(d)))d+=1;if(d<f&&e.charAt(d)=="."){d+=1;while(d<f&&i(e.charAt(d)))d+=1}h={type:b.ExpressionScanner.NUMBER,value:parseFloat(e.substring(g,d)),start:g,end:d},g=d}else{d=g;while(d<f){j=e.charAt(d);if("(),.!@ \t".indexOf(j)<0)d+=1;else break}h={type:b.ExpressionScanner.IDENTIFIER,value:e.substring(g,d),start:g,end:d},g=d}else{d=g+1;while(d<f){if(e.charAt(d)==a&&e.charAt(d-1)!="\\")break;d+=1}if(d<f)h={type:b.ExpressionScanner.STRING,value:e.substring(g+1,d).replace(/\\'/g,"'").replace(/\\"/g,'"'),start:g,end:d+1},g=d+1;else throw new Error("Unterminated string starting at "+g)}else h={type:b.ExpressionScanner.DELIMITER,value:a,start:g,end:g+1},g+=1;else h={type:b.ExpressionScanner.OPERATOR,value:a,start:g,end:g+1},g+=1;else c=="="||"<>".indexOf(c)>=0&&a!=c?(h={type:b.ExpressionScanner.OPERATOR,value:a+c,start:g,end:g+2},g+=2):(h={type:b.ExpressionScanner.OPERATOR,value:a,start:g,end:g+1},g+=1);else c=="@"?(h={type:b.ExpressionScanner.PATH_OPERATOR,value:a+c,start:g,end:g+2},g+=2):(h={type:b.ExpressionScanner.PATH_OPERATOR,value:a,start:g,end:g+1},g+=1)}},d.next();return d},b.ExpressionScanner.DELIMITER=0,b.ExpressionScanner.NUMBER=1,b.ExpressionScanner.STRING=2,b.ExpressionScanner.IDENTIFIER=3,b.ExpressionScanner.OPERATOR=4,b.ExpressionScanner.PATH_OPERATOR=5,b.namespace("Presentation"),b.Presentation.initView=function(b,c,d){var e=fluid.initView("MITHGrid.Presentation."+b,c,d),f={};d=e.options,a(c).empty(),e.eventModelChange=function(a,b){var c;e.renderItems(a,b)},e.renderingFor=function(a){return f[a]},e.renderItems=function(a,b){n=b.length;var d=function(g){var h,i;if(g<n){h=n,n>200&&(h=g+parseInt(Math.sqrt(n),10)+1,h>n&&(h=n));for(i=g;i<h;i+=1){var j=b[i];item=a.getItem(j),item?f[j]?f[j].update(item):(lens=e.getLens(item),lens&&(f[j]=lens.render(c,e,a,b[i]))):f[j]&&f[j].remove()}e.finishDisplayUpdate(),setTimeout(function(){d(h)},0)}};e.startDisplayUpdate(),d(0)},e.startDisplayUpdate=function(){a(c).empty()},e.finishDisplayUpdate=function(){a("<div class='clear'></div>").appendTo(a(c))},e.selfRender=function(){e.startDisplayUpdate(),e.renderItems(e.options.source,e.options.source.items()),e.finishDisplayUpdate()},e.dataView=e.options.source,e.options.source.registerView(e);return e},b.Application=function(c){var d={presentation:{},dataSource:{},dataView:{}},e=[];d.ready=function(a){e.push(a)},"dataSources"in c&&a.each(c.dataSources,function(c,e){var f=b.DataSource({source:e.label});d.dataSource[e.label]=f,f.addType("Item"),f.addProperty("label",{valueType:"text"}),f.addProperty("type",{valueType:"text"}),f.addProperty("id",{valueType:"text"}),"types"in e&&a.each(e.types,function(a,b){f.addType(b.label)}),"properties"in e&&a.each(e.properties,function(a,b){f.addProperty(b.label,b)})}),"dataViews"in c&&a.each(c.dataViews,function(a,c){var e=b.DataView({source:c.dataSource,label:c.label});d.dataView[c.label]=e}),"presentations"in c&&d.ready(function(){a.each(c.presentations,function(b,c){var e=a.extend(!0,{},c.options),f=a(c.container);a.isArray(f)&&(f=f[0]),e.source=d.dataView[c.dataView];var g=c.type(f,e);d.presentation[c.label]=g,g.selfRender()})}),a(document).ready(function(){a.each(e,function(a,b){b()}),d.ready=function(a){setTimeout(a,0)}});return d}})(jQuery,MITHGrid),fluid.defaults("MITHGrid.DataSource",{events:{onModelChange:null,onBeforeLoading:null,onAfterLoading:null,onBeforeUpdating:null,onAfterUpdating:null}}),fluid.defaults("MITHGrid.DataView",{events:{onModelChange:null,onFilterItem:"preventable"}});